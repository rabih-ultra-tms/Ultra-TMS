<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Board V3 â€” Dense Ops</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }

[data-theme="light"] {
    --bg-main: #F8F9FA; --bg-filter: #F1F3F5; --surface: #FFFFFF;
    --surface-hover: #F8FAFD; --surface-selected: #F0F4FF;
    --border: #e5e7eb; --border-soft: #DEE2E6;
    --sapphire: #1D4ED8; --sapphire-hover: #1E3FB0;
    --sapphire-light: #EEF2FF; --sapphire-border: #C7D2FE;
    --text-primary: #333333; --text-secondary: #6C757D; --text-muted: #adb5bd;
    --danger: #DC2626; --danger-bg: #FEF2F2;
    --success: #059669; --success-bg: #DCFCE7;
    --warning: #D97706; --warning-bg: #FFFBEB;
    --sidebar-bg: #1A1D27; --sidebar-icon: #9CA3AF; --sidebar-active: #3B82F6;
    --scrollbar-track: #F1F3F5; --scrollbar-thumb: #CED4DA;
    --group-header: #F8F9FA;
}
[data-theme="dark"] {
    --bg-main: #0F1117; --bg-filter: #161923; --surface: #1A1D27;
    --surface-hover: #22253A; --surface-selected: #1E2744;
    --border: #2A2D3A; --border-soft: #353849;
    --sapphire: #3B82F6; --sapphire-hover: #2563EB;
    --sapphire-light: #1E2744; --sapphire-border: #1E3A5F;
    --text-primary: #E8E9ED; --text-secondary: #9CA3AF; --text-muted: #6B7280;
    --danger: #EF4444; --danger-bg: #1F1215;
    --success: #10B981; --success-bg: #0F1F17;
    --warning: #F59E0B; --warning-bg: #1A1708;
    --sidebar-bg: #0B0D14; --sidebar-icon: #6B7280; --sidebar-active: #3B82F6;
    --scrollbar-track: #161923; --scrollbar-thumb: #2A2D3A;
    --group-header: #141720;
}

/* Scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Pulsing live dot */
@keyframes pulse-live {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.75); }
}
.live-dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--success);
    animation: pulse-live 2s ease-in-out infinite;
    display: inline-block; flex-shrink: 0;
}
.risk-dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: var(--danger);
    animation: pulse-live 1.5s ease-in-out infinite;
    display: inline-block; flex-shrink: 0;
}

/* Group accordion */
.group-rows { max-height: 2000px; overflow: hidden; transition: max-height 0.25s ease-out; }
.group-rows.collapsed { max-height: 0; }

/* Row inline actions */
.row-actions { opacity: 0; transition: opacity 0.15s ease; pointer-events: none; }
.table-row:hover .row-actions { opacity: 1; pointer-events: all; }

/* Row hover */
.table-row { transition: background 0.1s ease; }
.table-row:hover { background: var(--surface-hover) !important; }
.table-row.selected { background: var(--surface-selected) !important; }
.table-row.at-risk { background: var(--danger-bg); }
.table-row.at-risk:hover { background: var(--danger-bg) !important; filter: brightness(1.05); }

/* Drawer */
.drawer-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 90;
    opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease;
}
.drawer-overlay.open { opacity: 1; visibility: visible; }
.drawer-panel {
    position: fixed; top: 0; right: -360px; width: 360px; height: 100%;
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 100; transition: right 0.25s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column; overflow: hidden;
}
.drawer-panel.open { right: 0; }

/* Tab active */
.drawer-tab { transition: all 0.15s ease; }
.drawer-tab.active {
    color: var(--sapphire);
    border-bottom: 2px solid var(--sapphire);
}

/* Filter chip */
.filter-chip {
    cursor: pointer; transition: all 0.15s ease;
    border-bottom: 2px solid transparent;
    padding: 0 8px; height: 100%; display: flex; align-items: center; gap: 4px;
    font-size: 11px; font-weight: 500; color: var(--text-secondary);
    white-space: nowrap;
}
.filter-chip:hover { color: var(--text-primary); }
.filter-chip.active {
    color: var(--sapphire);
    border-bottom-color: var(--sapphire);
}
.filter-chip .count {
    font-size: 9px; font-weight: 600; padding: 0 4px;
    border-radius: 3px; background: var(--bg-filter); color: var(--text-muted);
    line-height: 16px;
}
.filter-chip.active .count {
    background: var(--sapphire-light); color: var(--sapphire);
}

/* Bulk bar */
.bulk-bar {
    height: 0; overflow: hidden; transition: height 0.2s ease;
    background: var(--sapphire-light); border-bottom: 1px solid var(--sapphire-border);
}
.bulk-bar.visible { height: 32px; }

/* Status badges */
.status-badge {
    display: inline-flex; align-items: center; gap: 3px;
    padding: 1px 6px; border-radius: 3px; font-size: 9px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
    line-height: 16px;
}

/* Material icon sizing for dense */
.material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
}
.icon-xs { font-size: 14px; }
.icon-sm { font-size: 16px; }
.icon-md { font-size: 18px; }
.icon-lg { font-size: 20px; }

/* Sidebar nav item */
.nav-item {
    width: 40px; height: 36px; display: flex; align-items: center; justify-content: center;
    border-radius: 6px; cursor: pointer; transition: all 0.15s ease;
    color: var(--sidebar-icon); position: relative;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: #D1D5DB; }
.nav-item.active { background: rgba(59,130,246,0.12); color: var(--sidebar-active); }
.nav-item.active::before {
    content: ''; position: absolute; left: -12px; top: 50%; transform: translateY(-50%);
    width: 3px; height: 18px; border-radius: 0 2px 2px 0; background: var(--sidebar-active);
}

/* Sort arrows */
.sort-arrow { font-size: 10px; color: var(--text-muted); margin-left: 2px; }
.sort-arrow.active { color: var(--sapphire); }

/* Checkbox */
.cb { width: 13px; height: 13px; accent-color: var(--sapphire); cursor: pointer; }

/* Pagination */
.page-btn {
    width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
    border-radius: 4px; border: 1px solid var(--border); cursor: pointer;
    color: var(--text-secondary); font-size: 11px; transition: all 0.15s ease;
    background: var(--surface);
}
.page-btn:hover { border-color: var(--sapphire); color: var(--sapphire); }
.page-btn.active { background: var(--sapphire); color: #fff; border-color: var(--sapphire); }
.page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* Tooltip on sidebar */
.nav-item .tooltip {
    position: absolute; left: 54px; top: 50%; transform: translateY(-50%);
    background: #1F2937; color: #F9FAFB; font-size: 11px; padding: 3px 8px;
    border-radius: 4px; white-space: nowrap; pointer-events: none;
    opacity: 0; transition: opacity 0.15s ease; z-index: 200;
}
.nav-item:hover .tooltip { opacity: 1; }

/* Unassigned carrier */
.unassigned-label {
    color: var(--warning); font-size: 10px; font-weight: 500; font-style: italic;
}
</style>
</head>
<body style="background:var(--bg-main); color:var(--text-primary);">

<div id="app" style="display:flex; height:100vh; width:100vw;"></div>

<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer-panel" id="drawerPanel"></div>

<script>
// ---- Safe DOM clear utility ----
function clearChildren(node) {
    while (node.firstChild) { node.removeChild(node.firstChild); }
}

// ---- DATA ----
var loads = [
    { id: 'LD-7842', status: 'transit', customer: 'Acme Corp', origin: 'Chicago, IL', dest: 'Dallas, TX', miles: 921, carrier: 'Swift Transport', driver: 'Mike Reynolds', equipment: 'Dry Van', pickupDate: 'Feb 6', pickupTime: '08:00', delivDate: 'Feb 8', delivTime: '14:00', rate: 3450, carrierPay: 2822, margin: 18.2, rpm: 3.75, updated: '5m', live: true },
    { id: 'LD-7838', status: 'transit', customer: 'Global Foods', origin: 'Atlanta, GA', dest: 'Miami, FL', miles: 662, carrier: 'J.B. Hunt', driver: 'Carlos Mendez', equipment: 'Reefer', pickupDate: 'Feb 6', pickupTime: '11:30', delivDate: 'Feb 7', delivTime: '18:00', rate: 2880, carrierPay: 2261, margin: 21.5, rpm: 4.35, updated: '2m', live: true },
    { id: 'LD-7835', status: 'transit', customer: 'Steel Works Inc', origin: 'Los Angeles, CA', dest: 'Phoenix, AZ', miles: 373, carrier: 'Werner', driver: 'James Park', equipment: 'Flatbed', pickupDate: 'Feb 7', pickupTime: '06:00', delivDate: 'Feb 7', delivTime: '16:00', rate: 1750, carrierPay: 1503, margin: 14.1, rpm: 4.69, updated: '8m', live: true },
    { id: 'LD-7831', status: 'transit', customer: 'MedSupply Co', origin: 'Nashville, TN', dest: 'Memphis, TN', miles: 213, carrier: 'Schneider', driver: 'Tom Bradley', equipment: 'Dry Van', pickupDate: 'Feb 7', pickupTime: '10:00', delivDate: 'Feb 7', delivTime: '17:30', rate: 1120, carrierPay: 932, margin: 16.8, rpm: 5.26, updated: '22m', live: false },
    { id: 'LD-7826', status: 'transit', customer: 'FreshPro LLC', origin: 'Denver, CO', dest: 'Kansas City, MO', miles: 605, carrier: 'XPO Logistics', driver: 'Sarah Kim', equipment: 'Reefer', pickupDate: 'Feb 6', pickupTime: '14:00', delivDate: 'Feb 8', delivTime: '08:00', rate: 2650, carrierPay: 2322, margin: 12.4, rpm: 4.38, updated: '1m', live: true },
    { id: 'LD-7819', status: 'transit', customer: 'RetailMax', origin: 'Seattle, WA', dest: 'Portland, OR', miles: 174, carrier: 'Heartland', driver: 'Derek Liu', equipment: 'Dry Van', pickupDate: 'Feb 8', pickupTime: '07:00', delivDate: 'Feb 8', delivTime: '12:00', rate: 890, carrierPay: 691, margin: 22.3, rpm: 5.11, updated: '12m', live: true },
    { id: 'LD-7814', status: 'transit', customer: 'ChemTech Intl', origin: 'Houston, TX', dest: 'New Orleans, LA', miles: 350, carrier: 'KLLM', driver: 'Andre Williams', equipment: 'Reefer', pickupDate: 'Feb 7', pickupTime: '15:00', delivDate: 'Feb 8', delivTime: '09:00', rate: 1680, carrierPay: 1450, margin: 13.7, rpm: 4.80, updated: '35m', live: false },
    { id: 'LD-7809', status: 'transit', customer: 'BuildRight Co', origin: 'Detroit, MI', dest: 'Columbus, OH', miles: 263, carrier: 'Old Dominion', driver: 'Robert Chen', equipment: 'Flatbed', pickupDate: 'Feb 8', pickupTime: '05:30', delivDate: 'Feb 8', delivTime: '13:00', rate: 1340, carrierPay: 1077, margin: 19.6, rpm: 5.10, updated: '7m', live: true },
    { id: 'LD-7851', status: 'unassigned', customer: 'TechParts Inc', origin: 'San Francisco, CA', dest: 'Reno, NV', miles: 218, carrier: '', driver: '', equipment: 'Dry Van', pickupDate: 'Feb 9', pickupTime: '09:00', delivDate: 'Feb 9', delivTime: '16:00', rate: 1250, carrierPay: 0, margin: 0, rpm: 5.73, updated: '1h', live: false },
    { id: 'LD-7849', status: 'unassigned', customer: 'PharmaDist', origin: 'Philadelphia, PA', dest: 'Boston, MA', miles: 306, carrier: '', driver: '', equipment: 'Reefer', pickupDate: 'Feb 9', pickupTime: '07:00', delivDate: 'Feb 9', delivTime: '15:30', rate: 1780, carrierPay: 0, margin: 0, rpm: 5.82, updated: '2h', live: false },
    { id: 'LD-7847', status: 'unassigned', customer: 'HomeGoods Plus', origin: 'Minneapolis, MN', dest: 'Milwaukee, WI', miles: 337, carrier: '', driver: '', equipment: 'Dry Van', pickupDate: 'Feb 10', pickupTime: '06:00', delivDate: 'Feb 10', delivTime: '14:00', rate: 1560, carrierPay: 0, margin: 0, rpm: 4.63, updated: '3h', live: false },
    { id: 'LD-7845', status: 'unassigned', customer: 'AgriSupply', origin: 'Charlotte, NC', dest: 'Jacksonville, FL', miles: 394, carrier: '', driver: '', equipment: 'Flatbed', pickupDate: 'Feb 10', pickupTime: '08:00', delivDate: 'Feb 11', delivTime: '10:00', rate: 2100, carrierPay: 0, margin: 0, rpm: 5.33, updated: '4h', live: false },
    { id: 'LD-7853', status: 'tendered', customer: 'Acme Corp', origin: 'Indianapolis, IN', dest: 'St. Louis, MO', miles: 242, carrier: 'Ryder', driver: 'Pending', equipment: 'Dry Van', pickupDate: 'Feb 9', pickupTime: '10:00', delivDate: 'Feb 9', delivTime: '18:00', rate: 1380, carrierPay: 1226, margin: 11.2, rpm: 5.70, updated: '45m', live: false },
    { id: 'LD-7850', status: 'tendered', customer: 'FreshPro LLC', origin: 'Salt Lake City, UT', dest: 'Boise, ID', miles: 340, carrier: 'Covenant', driver: 'Pending', equipment: 'Reefer', pickupDate: 'Feb 10', pickupTime: '07:30', delivDate: 'Feb 10', delivTime: '16:00', rate: 1920, carrierPay: 1603, margin: 16.5, rpm: 5.65, updated: '1h', live: false },
    { id: 'LD-7848', status: 'tendered', customer: 'Global Foods', origin: 'Tampa, FL', dest: 'Savannah, GA', miles: 408, carrier: 'USX', driver: 'Pending', equipment: 'Dry Van', pickupDate: 'Feb 9', pickupTime: '11:00', delivDate: 'Feb 10', delivTime: '07:00', rate: 1850, carrierPay: 1500, margin: 18.9, rpm: 4.53, updated: '2h', live: false },
    { id: 'LD-7854', status: 'dispatched', customer: 'MedSupply Co', origin: 'Newark, NJ', dest: 'Pittsburgh, PA', miles: 370, carrier: 'FedEx Freight', driver: 'Lisa Tran', equipment: 'Dry Van', pickupDate: 'Feb 9', pickupTime: '06:00', delivDate: 'Feb 9', delivTime: '16:00', rate: 1690, carrierPay: 1463, margin: 13.4, rpm: 4.57, updated: '30m', live: false },
    { id: 'LD-7852', status: 'dispatched', customer: 'Steel Works Inc', origin: 'Oklahoma City, OK', dest: 'Tulsa, OK', miles: 107, carrier: 'ABF Freight', driver: 'Tony Garcia', equipment: 'Flatbed', pickupDate: 'Feb 9', pickupTime: '08:00', delivDate: 'Feb 9', delivTime: '11:00', rate: 680, carrierPay: 516, margin: 24.1, rpm: 6.36, updated: '55m', live: false },
    { id: 'LD-7846', status: 'dispatched', customer: 'ChemTech Intl', origin: 'El Paso, TX', dest: 'San Antonio, TX', miles: 551, carrier: 'Saia Inc.', driver: 'Maria Santos', equipment: 'Reefer', pickupDate: 'Feb 9', pickupTime: '05:00', delivDate: 'Feb 9', delivTime: '18:00', rate: 2340, carrierPay: 1937, margin: 17.2, rpm: 4.25, updated: '1h', live: false },
    { id: 'LD-7843', status: 'dispatched', customer: 'RetailMax', origin: 'Richmond, VA', dest: 'Raleigh, NC', miles: 169, carrier: 'Estes Express', driver: 'Kevin Moore', equipment: 'Dry Van', pickupDate: 'Feb 9', pickupTime: '09:00', delivDate: 'Feb 9', delivTime: '14:00', rate: 920, carrierPay: 812, margin: 11.8, rpm: 5.44, updated: '2h', live: false },
    { id: 'LD-7801', status: 'delivered', customer: 'TechParts Inc', origin: 'New York, NY', dest: 'Washington, DC', miles: 225, carrier: 'Werner', driver: 'Paul Walker', equipment: 'Dry Van', pickupDate: 'Feb 5', pickupTime: '07:00', delivDate: 'Feb 5', delivTime: '15:00', rate: 1450, carrierPay: 1156, margin: 20.3, rpm: 6.44, updated: '2d', live: false },
    { id: 'LD-7798', status: 'delivered', customer: 'HomeGoods Plus', origin: 'Cincinnati, OH', dest: 'Louisville, KY', miles: 100, carrier: 'Schneider', driver: 'Amy Davis', equipment: 'Dry Van', pickupDate: 'Feb 5', pickupTime: '10:00', delivDate: 'Feb 5', delivTime: '13:30', rate: 620, carrierPay: 500, margin: 19.4, rpm: 6.20, updated: '2d', live: false },
    { id: 'LD-7795', status: 'delivered', customer: 'BuildRight Co', origin: 'Las Vegas, NV', dest: 'Tucson, AZ', miles: 420, carrier: 'J.B. Hunt', driver: 'Nick Patel', equipment: 'Flatbed', pickupDate: 'Feb 4', pickupTime: '06:00', delivDate: 'Feb 4', delivTime: '16:00', rate: 2010, carrierPay: 1714, margin: 14.7, rpm: 4.79, updated: '3d', live: false },
    { id: 'LD-7790', status: 'delivered', customer: 'PharmaDist', origin: 'Baltimore, MD', dest: 'Hartford, CT', miles: 298, carrier: 'XPO Logistics', driver: 'Dan Fischer', equipment: 'Reefer', pickupDate: 'Feb 4', pickupTime: '08:00', delivDate: 'Feb 4', delivTime: '17:00', rate: 1580, carrierPay: 1326, margin: 16.1, rpm: 5.30, updated: '3d', live: false },
    { id: 'LD-7822', status: 'atrisk', customer: 'AgriSupply', origin: 'Cleveland, OH', dest: 'Buffalo, NY', miles: 189, carrier: 'Crete Carrier', driver: 'Joe Mitchell', equipment: 'Reefer', pickupDate: 'Feb 7', pickupTime: '04:00', delivDate: 'Feb 7', delivTime: '12:00', rate: 1150, carrierPay: 1060, margin: 7.8, rpm: 6.08, updated: '3m', live: true, late: true },
    { id: 'LD-7817', status: 'atrisk', customer: 'Acme Corp', origin: 'Omaha, NE', dest: 'Des Moines, IA', miles: 150, carrier: 'PAM Transport', driver: 'Steve Novak', equipment: 'Dry Van', pickupDate: 'Feb 7', pickupTime: '09:00', delivDate: 'Feb 7', delivTime: '15:00', rate: 780, carrierPay: 730, margin: 6.4, rpm: 5.20, updated: '9m', live: true, late: true }
];

// ---- STATE ----
var state = {
    theme: localStorage.getItem('dispatch-v3-theme') || 'dark',
    activeFilter: 'all',
    selectedIds: new Set(),
    collapsedGroups: new Set(),
    drawerLoadId: null,
    drawerTab: 'overview',
    sortCol: null,
    sortDir: 'asc'
};

var statusGroups = [
    { key: 'atrisk', label: 'At Risk', icon: 'warning', color: 'var(--danger)' },
    { key: 'transit', label: 'In Transit', icon: 'local_shipping', color: 'var(--sapphire)' },
    { key: 'unassigned', label: 'Unassigned', icon: 'help_outline', color: 'var(--warning)' },
    { key: 'tendered', label: 'Tendered', icon: 'send', color: '#8B5CF6' },
    { key: 'dispatched', label: 'Dispatched', icon: 'check_circle', color: 'var(--success)' },
    { key: 'delivered', label: 'Delivered', icon: 'inventory', color: 'var(--text-muted)' }
];

var filterTabs = [
    { key: 'all', label: 'All' },
    { key: 'transit', label: 'Transit' },
    { key: 'unassigned', label: 'Unassigned' },
    { key: 'tendered', label: 'Tendered' },
    { key: 'dispatched', label: 'Dispatched' },
    { key: 'delivered', label: 'Delivered' },
    { key: 'atrisk', label: 'Risk' }
];

// ---- HELPERS ----
function el(tag, attrs, children) {
    var e = document.createElement(tag);
    if (attrs) {
        Object.keys(attrs).forEach(function(k) {
            if (k === 'style' && typeof attrs[k] === 'object') {
                Object.assign(e.style, attrs[k]);
            } else if (k === 'className') {
                e.className = attrs[k];
            } else if (k.startsWith('on')) {
                e.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
            } else if (k === 'dataset') {
                Object.keys(attrs[k]).forEach(function(dk) { e.dataset[dk] = attrs[k][dk]; });
            } else {
                e.setAttribute(k, attrs[k]);
            }
        });
    }
    if (children) {
        if (!Array.isArray(children)) children = [children];
        children.forEach(function(c) {
            if (c == null) return;
            if (typeof c === 'string' || typeof c === 'number') {
                e.appendChild(document.createTextNode(String(c)));
            } else {
                e.appendChild(c);
            }
        });
    }
    return e;
}

function mIcon(name, cls) {
    var s = el('span', { className: 'material-symbols-outlined ' + (cls || 'icon-sm') });
    s.textContent = name;
    return s;
}

function fmtRate(n) { return '$' + n.toLocaleString(); }

function getStatusConfig(st) {
    var map = {
        transit:    { label: 'In Transit',  bg: 'var(--sapphire-light)', color: 'var(--sapphire)', border: 'var(--sapphire-border)' },
        unassigned: { label: 'Unassigned',  bg: 'var(--warning-bg)',     color: 'var(--warning)',  border: 'rgba(217,119,6,0.2)' },
        tendered:   { label: 'Tendered',    bg: 'rgba(139,92,246,0.08)', color: '#8B5CF6',         border: 'rgba(139,92,246,0.2)' },
        dispatched: { label: 'Dispatched',  bg: 'var(--success-bg)',     color: 'var(--success)',  border: 'rgba(16,185,129,0.2)' },
        delivered:  { label: 'Delivered',   bg: 'var(--bg-filter)',      color: 'var(--text-muted)', border: 'var(--border)' },
        atrisk:     { label: 'At Risk',     bg: 'var(--danger-bg)',      color: 'var(--danger)',   border: 'rgba(239,68,68,0.2)' }
    };
    return map[st] || map.transit;
}

function getFilteredLoads() {
    if (state.activeFilter === 'all') return loads;
    return loads.filter(function(l) { return l.status === state.activeFilter; });
}

function getGroupCounts() {
    var counts = {};
    loads.forEach(function(l) {
        counts[l.status] = (counts[l.status] || 0) + 1;
    });
    return counts;
}

// ---- APPLY THEME ----
function applyTheme() {
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('dispatch-v3-theme', state.theme);
}

// ---- BUILD SIDEBAR ----
function buildSidebar() {
    var nav = [
        { icon: 'dashboard', label: 'Dashboard', active: false },
        { icon: 'local_shipping', label: 'Dispatch', active: true },
        { icon: 'inventory_2', label: 'Loads', active: false },
        { icon: 'business', label: 'Carriers', active: false },
        { icon: 'people', label: 'Customers', active: false },
        { icon: 'request_quote', label: 'Quotes', active: false },
        { icon: 'receipt_long', label: 'Invoices', active: false },
        { icon: 'bar_chart', label: 'Reports', active: false }
    ];

    var sidebar = el('div', { style: {
        width: '64px', minWidth: '64px', background: 'var(--sidebar-bg)',
        display: 'flex', flexDirection: 'column', alignItems: 'center',
        paddingTop: '10px', paddingBottom: '10px', borderRight: '1px solid var(--border)',
        gap: '2px', zIndex: '50'
    }});

    var logo = el('div', { style: {
        width: '32px', height: '32px', borderRadius: '8px',
        background: 'linear-gradient(135deg, #3B82F6, #1D4ED8)',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        marginBottom: '14px', fontSize: '13px', fontWeight: '700', color: '#fff'
    }}, ['U']);
    sidebar.appendChild(logo);

    nav.forEach(function(n) {
        var item = el('div', { className: 'nav-item' + (n.active ? ' active' : '') });
        item.appendChild(mIcon(n.icon, 'icon-lg'));
        var tip = el('span', { className: 'tooltip' }, [n.label]);
        item.appendChild(tip);
        sidebar.appendChild(item);
    });

    sidebar.appendChild(el('div', { style: { flex: '1' } }));

    var settingsItem = el('div', { className: 'nav-item' });
    settingsItem.appendChild(mIcon('settings', 'icon-lg'));
    settingsItem.appendChild(el('span', { className: 'tooltip' }, ['Settings']));
    sidebar.appendChild(settingsItem);

    return sidebar;
}

// ---- BUILD HEADER ----
function buildHeader() {
    var header = el('div', { style: {
        height: '42px', minHeight: '42px', display: 'flex', alignItems: 'center',
        padding: '0 16px', borderBottom: '1px solid var(--border)',
        background: 'var(--surface)', gap: '12px'
    }});

    var title = el('div', { style: { display: 'flex', alignItems: 'baseline', gap: '6px' } }, [
        el('span', { style: { fontSize: '13px', fontWeight: '600', color: 'var(--text-primary)' } }, ['Dispatch Board']),
        el('span', { style: { fontSize: '10px', fontWeight: '500', color: 'var(--text-muted)' } }, ['571 loads'])
    ]);
    header.appendChild(title);

    header.appendChild(el('div', { style: { flex: '1' } }));

    var searchWrap = el('div', { style: { position: 'relative', width: '240px' } });
    var searchIcon = mIcon('search', 'icon-xs');
    searchIcon.style.position = 'absolute';
    searchIcon.style.left = '8px';
    searchIcon.style.top = '50%';
    searchIcon.style.transform = 'translateY(-50%)';
    searchIcon.style.color = 'var(--text-muted)';
    searchWrap.appendChild(searchIcon);
    var searchInput = el('input', {
        type: 'text', placeholder: 'Search loads, carriers...',
        style: {
            width: '100%', height: '28px', borderRadius: '4px',
            border: '1px solid var(--border)', background: 'var(--bg-filter)',
            color: 'var(--text-primary)', fontSize: '11px', paddingLeft: '28px',
            paddingRight: '8px', outline: 'none'
        }
    });
    searchWrap.appendChild(searchInput);
    header.appendChild(searchWrap);

    var newBtn = el('button', { style: {
        height: '28px', padding: '0 10px', borderRadius: '4px',
        background: 'var(--sapphire)', color: '#fff', border: 'none',
        fontSize: '11px', fontWeight: '500', cursor: 'pointer',
        display: 'flex', alignItems: 'center', gap: '4px'
    }});
    newBtn.appendChild(mIcon('add', 'icon-xs'));
    newBtn.appendChild(document.createTextNode('New Load'));
    header.appendChild(newBtn);

    var themeBtn = el('div', { style: {
        width: '28px', height: '28px', display: 'flex', alignItems: 'center',
        justifyContent: 'center', cursor: 'pointer', borderRadius: '4px',
        color: 'var(--text-secondary)', border: '1px solid var(--border)'
    }, onClick: function() {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        applyTheme();
        render();
    }});
    themeBtn.appendChild(mIcon(state.theme === 'dark' ? 'light_mode' : 'dark_mode', 'icon-xs'));
    header.appendChild(themeBtn);

    var avatar = el('div', { style: {
        width: '26px', height: '26px', borderRadius: '50%',
        background: 'linear-gradient(135deg, #3B82F6, #8B5CF6)',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        fontSize: '10px', fontWeight: '600', color: '#fff'
    }}, ['JD']);
    header.appendChild(avatar);

    return header;
}

// ---- BUILD FILTER BAR ----
function buildFilterBar() {
    var counts = getGroupCounts();
    var bar = el('div', { style: {
        height: '36px', minHeight: '36px', display: 'flex', alignItems: 'stretch',
        padding: '0 16px', borderBottom: '1px solid var(--border)',
        background: 'var(--bg-filter)', gap: '0'
    }});

    filterTabs.forEach(function(tab) {
        var count = tab.key === 'all' ? loads.length : (counts[tab.key] || 0);
        var chip = el('div', {
            className: 'filter-chip' + (state.activeFilter === tab.key ? ' active' : ''),
            onClick: function() {
                state.activeFilter = tab.key;
                state.selectedIds.clear();
                render();
            }
        }, [
            document.createTextNode(tab.label),
            el('span', { className: 'count' }, [String(count)])
        ]);
        bar.appendChild(chip);
    });

    bar.appendChild(el('div', { style: { flex: '1' } }));

    var actions = el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } });
    ['filter_list', 'view_column', 'download'].forEach(function(ic) {
        var btn = el('div', { style: {
            width: '26px', height: '26px', display: 'flex', alignItems: 'center',
            justifyContent: 'center', cursor: 'pointer', borderRadius: '3px',
            color: 'var(--text-muted)'
        }});
        btn.appendChild(mIcon(ic, 'icon-xs'));
        actions.appendChild(btn);
    });
    bar.appendChild(actions);

    return bar;
}

// ---- BUILD STATS STRIP ----
function buildStatsStrip() {
    var strip = el('div', { style: {
        height: '32px', minHeight: '32px', display: 'flex', alignItems: 'center',
        padding: '0 16px', borderBottom: '1px solid var(--border)',
        background: 'var(--surface)', gap: '20px', fontSize: '10px'
    }});

    var stats = [
        { label: 'Revenue', value: '$1.47M', color: 'var(--text-primary)' },
        { label: 'Margin', value: '16.4%', color: 'var(--success)' },
        { label: 'On-Time', value: '94.2%', color: 'var(--sapphire)' },
        { label: 'Active', value: '57', color: 'var(--text-primary)' },
        { label: 'Risk', value: '2', color: 'var(--danger)' }
    ];

    stats.forEach(function(s, i) {
        if (i > 0) {
            strip.appendChild(el('div', { style: {
                width: '1px', height: '14px', background: 'var(--border)'
            }}));
        }
        var item = el('div', { style: { display: 'flex', alignItems: 'center', gap: '4px' } }, [
            el('span', { style: { color: 'var(--text-muted)', fontWeight: '500', textTransform: 'uppercase', letterSpacing: '0.5px', fontSize: '9px' } }, [s.label]),
            el('span', { style: { color: s.color, fontWeight: '600' } }, [s.value])
        ]);
        strip.appendChild(item);
    });

    return strip;
}

// ---- BUILD BULK BAR ----
function buildBulkBar() {
    var count = state.selectedIds.size;
    var bar = el('div', { className: 'bulk-bar' + (count > 0 ? ' visible' : '') });
    var inner = el('div', { style: {
        height: '32px', display: 'flex', alignItems: 'center', padding: '0 16px',
        gap: '10px', fontSize: '11px'
    }});

    inner.appendChild(el('span', { style: { fontWeight: '600', color: 'var(--sapphire)' } },
        [count + ' selected']));

    ['Assign', 'Status', 'Export'].forEach(function(action) {
        var btn = el('button', { style: {
            height: '22px', padding: '0 8px', borderRadius: '3px',
            border: '1px solid var(--sapphire-border)', background: 'transparent',
            color: 'var(--sapphire)', fontSize: '10px', fontWeight: '500',
            cursor: 'pointer'
        }}, [action]);
        inner.appendChild(btn);
    });

    inner.appendChild(el('div', { style: { flex: '1' } }));

    var closeBtn = el('div', { style: {
        cursor: 'pointer', color: 'var(--text-muted)', display: 'flex', alignItems: 'center'
    }, onClick: function() {
        state.selectedIds.clear();
        render();
    }});
    closeBtn.appendChild(mIcon('close', 'icon-xs'));
    inner.appendChild(closeBtn);

    bar.appendChild(inner);
    return bar;
}

// ---- BUILD TABLE HEADER ----
function buildTableHeader() {
    var row = el('div', { style: {
        display: 'flex', alignItems: 'center', height: '28px', minHeight: '28px',
        padding: '0 12px', borderBottom: '1px solid var(--border)',
        background: 'var(--bg-filter)', fontSize: '9px', fontWeight: '600',
        textTransform: 'uppercase', letterSpacing: '0.5px', color: 'var(--text-muted)',
        position: 'sticky', top: '0', zIndex: '10'
    }});

    var columns = [
        { key: 'cb', label: '', width: '36px', sortable: false },
        { key: 'status', label: 'Status', width: '80px', sortable: true },
        { key: 'id', label: 'Load #', width: '100px', sortable: true },
        { key: 'customer', label: 'Customer', width: '100px', sortable: true },
        { key: 'route', label: 'Route', width: null, flex: 1, minWidth: '180px', sortable: true },
        { key: 'carrier', label: 'Carrier / Driver', width: '130px', sortable: true },
        { key: 'equipment', label: 'Equip', width: '70px', sortable: true },
        { key: 'pickup', label: 'Pickup', width: '90px', sortable: true },
        { key: 'delivery', label: 'Delivery', width: '90px', sortable: true },
        { key: 'rate', label: 'Rate', width: '70px', sortable: true },
        { key: 'margin', label: 'Margin', width: '60px', sortable: true },
        { key: 'rpm', label: 'RPM', width: '55px', sortable: true },
        { key: 'updated', label: 'Updated', width: '75px', sortable: true }
    ];

    columns.forEach(function(col) {
        if (col.key === 'cb') {
            var cbWrap = el('div', { style: { width: col.width, display: 'flex', alignItems: 'center', justifyContent: 'center' } });
            var cb = el('input', { type: 'checkbox', className: 'cb', onClick: function(e) {
                var filtered = getFilteredLoads();
                if (e.target.checked) {
                    filtered.forEach(function(l) { state.selectedIds.add(l.id); });
                } else {
                    state.selectedIds.clear();
                }
                render();
            }});
            cbWrap.appendChild(cb);
            row.appendChild(cbWrap);
            return;
        }

        var cellStyle = { padding: '0 4px', cursor: col.sortable ? 'pointer' : 'default',
            display: 'flex', alignItems: 'center', gap: '2px', userSelect: 'none' };
        if (col.width) cellStyle.width = col.width;
        if (col.flex) { cellStyle.flex = String(col.flex); cellStyle.minWidth = col.minWidth; }

        var cell = el('div', { style: cellStyle, onClick: col.sortable ? (function(k) {
            return function() {
                if (state.sortCol === k) {
                    state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortCol = k;
                    state.sortDir = 'asc';
                }
                render();
            };
        })(col.key) : null });

        cell.appendChild(document.createTextNode(col.label));

        if (col.sortable) {
            var isActive = state.sortCol === col.key;
            var arrow = el('span', { className: 'sort-arrow' + (isActive ? ' active' : '') },
                [isActive ? (state.sortDir === 'asc' ? '\u25B2' : '\u25BC') : '\u25B4']);
            cell.appendChild(arrow);
        }

        row.appendChild(cell);
    });

    return row;
}

// ---- BUILD TABLE ROW ----
function buildTableRow(load) {
    var isAtRisk = load.status === 'atrisk';
    var isSelected = state.selectedIds.has(load.id);
    var sc = getStatusConfig(load.status);

    var row = el('div', {
        className: 'table-row' + (isAtRisk ? ' at-risk' : '') + (isSelected ? ' selected' : ''),
        style: {
            display: 'flex', alignItems: 'center', height: '32px', minHeight: '32px',
            padding: '0 12px', borderBottom: '1px solid var(--border-soft)',
            fontSize: '11px', cursor: 'pointer', position: 'relative'
        },
        onClick: function(e) {
            if (e.target.type === 'checkbox' || e.target.closest('.row-actions')) return;
            openDrawer(load.id);
        }
    });

    // Checkbox
    var cbWrap = el('div', { style: { width: '36px', display: 'flex', alignItems: 'center', justifyContent: 'center' } });
    var cb = el('input', { type: 'checkbox', className: 'cb' });
    cb.checked = isSelected;
    cb.addEventListener('change', function(e) {
        e.stopPropagation();
        if (e.target.checked) { state.selectedIds.add(load.id); }
        else { state.selectedIds.delete(load.id); }
        render();
    });
    cbWrap.appendChild(cb);
    row.appendChild(cbWrap);

    // Status
    var statusCell = el('div', { style: { width: '80px', padding: '0 4px' } });
    var badge = el('span', { className: 'status-badge', style: {
        background: sc.bg, color: sc.color, border: '1px solid ' + sc.border
    }}, [sc.label]);
    statusCell.appendChild(badge);
    row.appendChild(statusCell);

    // Load #
    row.appendChild(el('div', { style: { width: '100px', padding: '0 4px', fontWeight: '600', color: 'var(--sapphire)' } }, [load.id]));

    // Customer
    row.appendChild(el('div', { style: {
        width: '100px', padding: '0 4px', color: 'var(--text-primary)',
        overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap',
        fontSize: '10px', fontWeight: '500'
    }}, [load.customer]));

    // Route
    var routeCell = el('div', { style: {
        flex: '1', minWidth: '180px', padding: '0 4px', display: 'flex',
        alignItems: 'center', gap: '4px', overflow: 'hidden'
    }});
    routeCell.appendChild(el('span', { style: { color: 'var(--text-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '45%' } }, [load.origin]));
    var arrowIcon = mIcon('arrow_forward', 'icon-xs');
    arrowIcon.style.color = 'var(--text-muted)';
    arrowIcon.style.flexShrink = '0';
    routeCell.appendChild(arrowIcon);
    routeCell.appendChild(el('span', { style: { color: 'var(--text-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '45%' } }, [load.dest]));
    routeCell.appendChild(el('span', { style: { color: 'var(--text-muted)', fontSize: '9px', marginLeft: '2px', flexShrink: '0' } }, [load.miles + 'mi']));
    row.appendChild(routeCell);

    // Carrier / Driver
    var carrierCell = el('div', { style: { width: '130px', padding: '0 4px', overflow: 'hidden' } });
    if (load.carrier) {
        carrierCell.appendChild(el('div', { style: {
            fontSize: '10px', fontWeight: '500', color: 'var(--text-primary)',
            overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', lineHeight: '14px'
        }}, [load.carrier]));
        if (load.driver && load.driver !== 'Pending') {
            carrierCell.appendChild(el('div', { style: {
                fontSize: '9px', color: 'var(--text-muted)', lineHeight: '12px',
                overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'
            }}, [load.driver]));
        } else if (load.driver === 'Pending') {
            carrierCell.appendChild(el('div', { style: {
                fontSize: '9px', color: 'var(--warning)', fontStyle: 'italic', lineHeight: '12px'
            }}, ['Pending']));
        }
    } else {
        carrierCell.appendChild(el('span', { className: 'unassigned-label' }, ['Needs carrier']));
    }
    row.appendChild(carrierCell);

    // Equipment
    row.appendChild(el('div', { style: {
        width: '70px', padding: '0 4px', fontSize: '10px', color: 'var(--text-secondary)'
    }}, [load.equipment]));

    // Pickup
    var pickupCell = el('div', { style: { width: '90px', padding: '0 4px' } });
    pickupCell.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-primary)', lineHeight: '14px' } }, [load.pickupDate]));
    pickupCell.appendChild(el('div', { style: { fontSize: '9px', color: 'var(--text-muted)', lineHeight: '12px' } }, [load.pickupTime]));
    row.appendChild(pickupCell);

    // Delivery
    var delivCell = el('div', { style: { width: '90px', padding: '0 4px' } });
    delivCell.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-primary)', lineHeight: '14px' } }, [load.delivDate]));
    delivCell.appendChild(el('div', { style: { fontSize: '9px', color: 'var(--text-muted)', lineHeight: '12px' } }, [load.delivTime]));
    row.appendChild(delivCell);

    // Rate
    row.appendChild(el('div', { style: {
        width: '70px', padding: '0 4px', fontWeight: '600', color: 'var(--text-primary)',
        fontSize: '10px', fontFeatureSettings: '"tnum"'
    }}, [fmtRate(load.rate)]));

    // Margin
    var marginColor = load.margin >= 15 ? 'var(--success)' : load.margin >= 10 ? 'var(--warning)' : load.margin > 0 ? 'var(--danger)' : 'var(--text-muted)';
    row.appendChild(el('div', { style: {
        width: '60px', padding: '0 4px', fontWeight: '600', color: marginColor,
        fontSize: '10px', fontFeatureSettings: '"tnum"'
    }}, [load.margin > 0 ? load.margin.toFixed(1) + '%' : '--']));

    // RPM
    row.appendChild(el('div', { style: {
        width: '55px', padding: '0 4px', color: 'var(--text-secondary)',
        fontSize: '10px', fontFeatureSettings: '"tnum"'
    }}, ['$' + load.rpm.toFixed(2)]));

    // Updated + live dot + inline actions
    var updatedCell = el('div', { style: {
        width: '75px', padding: '0 4px', display: 'flex', alignItems: 'center',
        gap: '4px', position: 'relative'
    }});

    if (isAtRisk) {
        updatedCell.appendChild(el('span', { className: 'risk-dot' }));
    } else if (load.live) {
        updatedCell.appendChild(el('span', { className: 'live-dot' }));
    }

    updatedCell.appendChild(el('span', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, [load.updated]));

    // Inline row actions
    var actionsWrap = el('div', { className: 'row-actions', style: {
        position: 'absolute', right: '0', top: '0', height: '100%',
        display: 'flex', alignItems: 'center', gap: '2px',
        background: 'linear-gradient(to right, transparent, var(--surface-hover) 20%)',
        paddingLeft: '16px', paddingRight: '4px'
    }});

    [{ ic: 'edit', tip: 'Edit' }, { ic: 'phone', tip: 'Call' }, { ic: 'gps_fixed', tip: 'Track' }].forEach(function(act) {
        var actionBtn = el('div', { style: {
            width: '22px', height: '22px', display: 'flex', alignItems: 'center',
            justifyContent: 'center', borderRadius: '3px', cursor: 'pointer',
            color: 'var(--text-secondary)', transition: 'all 0.1s ease'
        }, onClick: function(e) {
            e.stopPropagation();
        }});
        actionBtn.addEventListener('mouseenter', function() {
            actionBtn.style.background = 'var(--sapphire-light)';
            actionBtn.style.color = 'var(--sapphire)';
        });
        actionBtn.addEventListener('mouseleave', function() {
            actionBtn.style.background = 'transparent';
            actionBtn.style.color = 'var(--text-secondary)';
        });
        actionBtn.appendChild(mIcon(act.ic, 'icon-xs'));
        actionsWrap.appendChild(actionBtn);
    });

    updatedCell.appendChild(actionsWrap);
    row.appendChild(updatedCell);

    return row;
}

// ---- BUILD GROUP HEADER ----
function buildGroupHeader(group, count) {
    var isCollapsed = state.collapsedGroups.has(group.key);
    var header = el('div', { style: {
        height: '24px', minHeight: '24px', display: 'flex', alignItems: 'center',
        padding: '0 12px', background: 'var(--group-header)',
        borderBottom: '1px solid var(--border)', cursor: 'pointer',
        gap: '6px', userSelect: 'none'
    }, onClick: function() {
        if (isCollapsed) { state.collapsedGroups.delete(group.key); }
        else { state.collapsedGroups.add(group.key); }
        render();
    }});

    header.appendChild(el('div', { style: {
        width: '5px', height: '5px', borderRadius: '50%', background: group.color, flexShrink: '0'
    }}));

    header.appendChild(el('span', { style: {
        fontSize: '9px', fontWeight: '600', textTransform: 'uppercase',
        letterSpacing: '0.5px', color: 'var(--text-secondary)'
    }}, [group.label]));

    header.appendChild(el('span', { style: {
        fontSize: '9px', color: 'var(--text-muted)', fontWeight: '500'
    }}, ['(' + count + ')']));

    header.appendChild(el('div', { style: { flex: '1' } }));

    var chevron = mIcon(isCollapsed ? 'expand_more' : 'expand_less', 'icon-xs');
    chevron.style.color = 'var(--text-muted)';
    header.appendChild(chevron);

    return header;
}

// ---- BUILD TABLE ----
function buildTable() {
    var container = el('div', { style: {
        flex: '1', overflow: 'auto', background: 'var(--bg-main)'
    }});

    container.appendChild(buildTableHeader());

    var filtered = getFilteredLoads();

    if (state.sortCol) {
        filtered = filtered.slice().sort(function(a, b) {
            var va, vb;
            switch (state.sortCol) {
                case 'status': va = a.status; vb = b.status; break;
                case 'id': va = a.id; vb = b.id; break;
                case 'customer': va = a.customer; vb = b.customer; break;
                case 'route': va = a.origin; vb = b.origin; break;
                case 'carrier': va = a.carrier || 'zzz'; vb = b.carrier || 'zzz'; break;
                case 'equipment': va = a.equipment; vb = b.equipment; break;
                case 'pickup': va = a.pickupDate + a.pickupTime; vb = b.pickupDate + b.pickupTime; break;
                case 'delivery': va = a.delivDate + a.delivTime; vb = b.delivDate + b.delivTime; break;
                case 'rate': va = a.rate; vb = b.rate; break;
                case 'margin': va = a.margin; vb = b.margin; break;
                case 'rpm': va = a.rpm; vb = b.rpm; break;
                case 'updated': va = a.updated; vb = b.updated; break;
                default: return 0;
            }
            if (typeof va === 'string') {
                var cmp = va.localeCompare(vb);
                return state.sortDir === 'asc' ? cmp : -cmp;
            }
            return state.sortDir === 'asc' ? va - vb : vb - va;
        });
    }

    if (state.activeFilter === 'all') {
        statusGroups.forEach(function(group) {
            var groupLoads = filtered.filter(function(l) { return l.status === group.key; });
            if (groupLoads.length === 0) return;

            container.appendChild(buildGroupHeader(group, groupLoads.length));

            var rowsWrap = el('div', {
                className: 'group-rows' + (state.collapsedGroups.has(group.key) ? ' collapsed' : '')
            });
            groupLoads.forEach(function(l) {
                rowsWrap.appendChild(buildTableRow(l));
            });
            container.appendChild(rowsWrap);
        });
    } else {
        filtered.forEach(function(l) {
            container.appendChild(buildTableRow(l));
        });
    }

    return container;
}

// ---- BUILD PAGINATION ----
function buildPagination() {
    var bar = el('div', { style: {
        height: '36px', minHeight: '36px', display: 'flex', alignItems: 'center',
        padding: '0 16px', borderTop: '1px solid var(--border)',
        background: 'var(--surface)', justifyContent: 'space-between',
        fontSize: '10px', color: 'var(--text-muted)'
    }});

    bar.appendChild(el('span', null, ['Showing 1\u201325 of 571 loads']));

    var pages = el('div', { style: { display: 'flex', gap: '3px', alignItems: 'center' } });

    var prevBtn = el('div', { className: 'page-btn' });
    prevBtn.appendChild(mIcon('chevron_left', 'icon-xs'));
    pages.appendChild(prevBtn);

    [1, 2, 3, '...', 23].forEach(function(p) {
        pages.appendChild(el('div', { className: 'page-btn' + (p === 1 ? ' active' : '') }, [String(p)]));
    });

    var nextBtn = el('div', { className: 'page-btn' });
    nextBtn.appendChild(mIcon('chevron_right', 'icon-xs'));
    pages.appendChild(nextBtn);

    bar.appendChild(pages);
    return bar;
}

// ---- DRAWER ----
function openDrawer(loadId) {
    state.drawerLoadId = loadId;
    state.drawerTab = 'overview';
    renderDrawer();
    document.getElementById('drawerOverlay').classList.add('open');
    document.getElementById('drawerPanel').classList.add('open');
}

function closeDrawer() {
    state.drawerLoadId = null;
    document.getElementById('drawerOverlay').classList.remove('open');
    document.getElementById('drawerPanel').classList.remove('open');
}

function renderDrawer() {
    var panel = document.getElementById('drawerPanel');
    clearChildren(panel);
    if (!state.drawerLoadId) return;

    var load = loads.find(function(l) { return l.id === state.drawerLoadId; });
    if (!load) return;
    var sc = getStatusConfig(load.status);

    // Header
    var header = el('div', { style: {
        height: '40px', minHeight: '40px', display: 'flex', alignItems: 'center',
        padding: '0 14px', borderBottom: '1px solid var(--border)', gap: '8px'
    }});
    header.appendChild(el('span', { style: { fontSize: '12px', fontWeight: '600', color: 'var(--text-primary)' } }, [load.id]));
    header.appendChild(el('span', { className: 'status-badge', style: {
        background: sc.bg, color: sc.color, border: '1px solid ' + sc.border
    }}, [sc.label]));
    header.appendChild(el('div', { style: { flex: '1' } }));
    var closeBtn = el('div', { style: {
        width: '24px', height: '24px', display: 'flex', alignItems: 'center',
        justifyContent: 'center', cursor: 'pointer', borderRadius: '3px',
        color: 'var(--text-muted)'
    }, onClick: closeDrawer });
    closeBtn.appendChild(mIcon('close', 'icon-sm'));
    header.appendChild(closeBtn);
    panel.appendChild(header);

    // Tabs
    var tabBar = el('div', { style: {
        height: '34px', minHeight: '34px', display: 'flex', alignItems: 'stretch',
        padding: '0 14px', borderBottom: '1px solid var(--border)', gap: '0'
    }});

    var tabs = [
        { key: 'overview', label: 'Overview', icon: 'info' },
        { key: 'stops', label: 'Stops', icon: 'pin_drop' },
        { key: 'finance', label: 'Finance', icon: 'attach_money' },
        { key: 'docs', label: 'Docs', icon: 'description' }
    ];

    tabs.forEach(function(tab) {
        var tabEl = el('div', {
            className: 'drawer-tab' + (state.drawerTab === tab.key ? ' active' : ''),
            style: {
                display: 'flex', alignItems: 'center', gap: '3px',
                padding: '0 8px', cursor: 'pointer', fontSize: '10px',
                fontWeight: '500', color: state.drawerTab === tab.key ? 'var(--sapphire)' : 'var(--text-muted)',
                borderBottom: state.drawerTab === tab.key ? '2px solid var(--sapphire)' : '2px solid transparent'
            },
            onClick: function() {
                state.drawerTab = tab.key;
                renderDrawer();
            }
        });
        tabEl.appendChild(mIcon(tab.icon, 'icon-xs'));
        tabEl.appendChild(document.createTextNode(tab.label));
        tabBar.appendChild(tabEl);
    });
    panel.appendChild(tabBar);

    // Content
    var content = el('div', { style: {
        flex: '1', overflow: 'auto', padding: '12px 14px'
    }});

    if (state.drawerTab === 'overview') {
        content.appendChild(buildDrawerOverview(load));
    } else if (state.drawerTab === 'stops') {
        content.appendChild(buildDrawerStops(load));
    } else if (state.drawerTab === 'finance') {
        content.appendChild(buildDrawerFinance(load));
    } else {
        content.appendChild(buildDrawerDocs(load));
    }

    panel.appendChild(content);

    // Footer actions
    var footer = el('div', { style: {
        height: '40px', minHeight: '40px', display: 'flex', alignItems: 'center',
        padding: '0 14px', borderTop: '1px solid var(--border)', gap: '6px'
    }});
    var editBtn = el('button', { style: {
        flex: '1', height: '28px', borderRadius: '4px',
        border: '1px solid var(--border)', background: 'transparent',
        color: 'var(--text-primary)', fontSize: '10px', fontWeight: '500',
        cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px'
    }});
    editBtn.appendChild(mIcon('edit', 'icon-xs'));
    editBtn.appendChild(document.createTextNode('Edit Load'));
    footer.appendChild(editBtn);

    var primaryBtn = el('button', { style: {
        flex: '1', height: '28px', borderRadius: '4px',
        border: 'none', background: 'var(--sapphire)', color: '#fff',
        fontSize: '10px', fontWeight: '500', cursor: 'pointer',
        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px'
    }});
    primaryBtn.appendChild(mIcon('send', 'icon-xs'));
    primaryBtn.appendChild(document.createTextNode(load.status === 'unassigned' ? 'Find Carrier' : 'Update Status'));
    footer.appendChild(primaryBtn);

    panel.appendChild(footer);
}

function drawerSection(title) {
    return el('div', { style: {
        fontSize: '9px', fontWeight: '600', textTransform: 'uppercase',
        letterSpacing: '0.5px', color: 'var(--text-muted)',
        marginBottom: '6px', marginTop: '12px'
    }}, [title]);
}

function drawerField(label, value, valueColor) {
    return el('div', { style: {
        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
        padding: '3px 0', fontSize: '10px'
    }}, [
        el('span', { style: { color: 'var(--text-muted)' } }, [label]),
        el('span', { style: { fontWeight: '500', color: valueColor || 'var(--text-primary)' } }, [value])
    ]);
}

function buildDrawerOverview(load) {
    var wrap = el('div');

    wrap.appendChild(drawerSection('Customer'));
    wrap.appendChild(drawerField('Company', load.customer));

    wrap.appendChild(drawerSection('Route'));
    wrap.appendChild(drawerField('Origin', load.origin));
    wrap.appendChild(drawerField('Destination', load.dest));
    wrap.appendChild(drawerField('Distance', load.miles + ' miles'));
    wrap.appendChild(drawerField('Equipment', load.equipment));

    wrap.appendChild(drawerSection('Carrier'));
    wrap.appendChild(drawerField('Carrier', load.carrier || 'Unassigned', load.carrier ? null : 'var(--warning)'));
    wrap.appendChild(drawerField('Driver', load.driver || '--'));

    wrap.appendChild(drawerSection('Schedule'));
    wrap.appendChild(drawerField('Pickup', load.pickupDate + ' @ ' + load.pickupTime));
    wrap.appendChild(drawerField('Delivery', load.delivDate + ' @ ' + load.delivTime));
    wrap.appendChild(drawerField('Last Update', load.updated + ' ago'));

    if (load.late) {
        var alertBox = el('div', { style: {
            marginTop: '10px', padding: '8px', borderRadius: '4px',
            background: 'var(--danger-bg)', border: '1px solid rgba(239,68,68,0.2)',
            display: 'flex', alignItems: 'center', gap: '6px'
        }});
        var alertIcon = mIcon('warning', 'icon-sm');
        alertIcon.style.color = 'var(--danger)';
        alertBox.appendChild(alertIcon);
        alertBox.appendChild(el('span', { style: { fontSize: '10px', color: 'var(--danger)', fontWeight: '500' } },
            ['Behind schedule \u2014 delivery window at risk']));
        wrap.appendChild(alertBox);
    }

    return wrap;
}

function buildDrawerStops(load) {
    var wrap = el('div');
    wrap.appendChild(drawerSection('Stops'));

    // Pickup stop
    var pickupStop = el('div', { style: {
        padding: '8px', borderRadius: '4px', border: '1px solid var(--border)',
        marginBottom: '8px'
    }});
    var pickHeader = el('div', { style: { display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' } });
    var pickIcon = mIcon('north_east', 'icon-xs');
    pickIcon.style.color = 'var(--success)';
    pickHeader.appendChild(pickIcon);
    pickHeader.appendChild(el('span', { style: { fontSize: '10px', fontWeight: '600', color: 'var(--success)' } }, ['PICKUP']));
    pickupStop.appendChild(pickHeader);
    pickupStop.appendChild(drawerField('Location', load.origin));
    pickupStop.appendChild(drawerField('Date', load.pickupDate));
    pickupStop.appendChild(drawerField('Time', load.pickupTime));
    wrap.appendChild(pickupStop);

    // Delivery stop
    var delivStop = el('div', { style: {
        padding: '8px', borderRadius: '4px', border: '1px solid var(--border)'
    }});
    var delivHeader = el('div', { style: { display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' } });
    var delivIcon = mIcon('south_west', 'icon-xs');
    delivIcon.style.color = 'var(--sapphire)';
    delivHeader.appendChild(delivIcon);
    delivHeader.appendChild(el('span', { style: { fontSize: '10px', fontWeight: '600', color: 'var(--sapphire)' } }, ['DELIVERY']));
    delivStop.appendChild(delivHeader);
    delivStop.appendChild(drawerField('Location', load.dest));
    delivStop.appendChild(drawerField('Date', load.delivDate));
    delivStop.appendChild(drawerField('Time', load.delivTime));
    wrap.appendChild(delivStop);

    // Timeline
    wrap.appendChild(drawerSection('Timeline'));
    var timeline = el('div', { style: { position: 'relative', paddingLeft: '14px', borderLeft: '2px solid var(--border)' } });
    var events = [
        { time: 'Created', desc: 'Load created by dispatcher', done: true },
        { time: 'Assigned', desc: load.carrier ? 'Assigned to ' + load.carrier : 'Pending', done: !!load.carrier },
        { time: 'Picked up', desc: load.pickupDate + ' ' + load.pickupTime, done: load.status === 'transit' || load.status === 'delivered' },
        { time: 'Delivered', desc: load.delivDate + ' ' + load.delivTime, done: load.status === 'delivered' }
    ];
    events.forEach(function(ev) {
        var evEl = el('div', { style: { marginBottom: '10px', position: 'relative' } });
        evEl.appendChild(el('div', { style: {
            width: '6px', height: '6px', borderRadius: '50%',
            background: ev.done ? 'var(--sapphire)' : 'var(--border)',
            position: 'absolute', left: '-18px', top: '3px'
        }}));
        evEl.appendChild(el('div', { style: { fontSize: '10px', fontWeight: '500', color: ev.done ? 'var(--text-primary)' : 'var(--text-muted)' } }, [ev.time]));
        evEl.appendChild(el('div', { style: { fontSize: '9px', color: 'var(--text-muted)' } }, [ev.desc]));
        timeline.appendChild(evEl);
    });
    wrap.appendChild(timeline);

    return wrap;
}

function buildDrawerFinance(load) {
    var wrap = el('div');
    wrap.appendChild(drawerSection('Revenue'));
    wrap.appendChild(drawerField('Customer Rate', fmtRate(load.rate)));
    wrap.appendChild(drawerField('RPM', '$' + load.rpm.toFixed(2)));

    wrap.appendChild(drawerSection('Costs'));
    wrap.appendChild(drawerField('Carrier Pay', load.carrierPay > 0 ? fmtRate(load.carrierPay) : '--', load.carrierPay > 0 ? null : 'var(--text-muted)'));
    wrap.appendChild(drawerField('Cost/Mile', load.carrierPay > 0 ? '$' + (load.carrierPay / load.miles).toFixed(2) : '--'));

    wrap.appendChild(drawerSection('Margin'));
    var profit = load.rate - load.carrierPay;
    var marginColor = load.margin >= 15 ? 'var(--success)' : load.margin >= 10 ? 'var(--warning)' : load.margin > 0 ? 'var(--danger)' : 'var(--text-muted)';
    wrap.appendChild(drawerField('Gross Profit', profit > 0 ? fmtRate(profit) : '--', profit > 0 ? 'var(--success)' : null));
    wrap.appendChild(drawerField('Margin %', load.margin > 0 ? load.margin.toFixed(1) + '%' : '--', marginColor));

    if (load.margin > 0) {
        var barWrap = el('div', { style: { marginTop: '8px' } });
        var barBg = el('div', { style: {
            height: '6px', borderRadius: '3px', background: 'var(--bg-filter)',
            overflow: 'hidden', width: '100%'
        }});
        barBg.appendChild(el('div', { style: {
            height: '100%', borderRadius: '3px',
            background: marginColor,
            width: Math.min(load.margin * 3, 100) + '%',
            transition: 'width 0.3s ease'
        }}));
        barWrap.appendChild(barBg);
        wrap.appendChild(barWrap);
    }

    return wrap;
}

function buildDrawerDocs(load) {
    var wrap = el('div');
    wrap.appendChild(drawerSection('Documents'));

    var docs = [
        { name: 'Rate Confirmation', status: load.carrier ? 'Uploaded' : 'Pending', icon: 'description' },
        { name: 'Bill of Lading', status: load.status === 'delivered' ? 'Uploaded' : 'Pending', icon: 'receipt' },
        { name: 'Proof of Delivery', status: load.status === 'delivered' ? 'Uploaded' : 'Pending', icon: 'verified' },
        { name: 'Insurance Certificate', status: load.carrier ? 'On File' : 'N/A', icon: 'shield' }
    ];

    docs.forEach(function(doc) {
        var isUploaded = doc.status === 'Uploaded' || doc.status === 'On File';
        var docRow = el('div', { style: {
            display: 'flex', alignItems: 'center', gap: '8px',
            padding: '6px 8px', borderRadius: '4px', marginBottom: '4px',
            border: '1px solid var(--border)', cursor: 'pointer'
        }});
        docRow.addEventListener('mouseenter', function() { docRow.style.background = 'var(--surface-hover)'; });
        docRow.addEventListener('mouseleave', function() { docRow.style.background = 'transparent'; });

        var docIcon = mIcon(doc.icon, 'icon-sm');
        docIcon.style.color = isUploaded ? 'var(--sapphire)' : 'var(--text-muted)';
        docRow.appendChild(docIcon);

        var docInfo = el('div', { style: { flex: '1' } });
        docInfo.appendChild(el('div', { style: { fontSize: '10px', fontWeight: '500', color: 'var(--text-primary)' } }, [doc.name]));
        docInfo.appendChild(el('div', { style: {
            fontSize: '9px', color: isUploaded ? 'var(--success)' : 'var(--text-muted)'
        }}, [doc.status]));
        docRow.appendChild(docInfo);

        if (isUploaded) {
            var dlIcon = mIcon('download', 'icon-xs');
            dlIcon.style.color = 'var(--text-muted)';
            docRow.appendChild(dlIcon);
        }

        wrap.appendChild(docRow);
    });

    wrap.appendChild(drawerSection('Upload'));
    var uploadArea = el('div', { style: {
        border: '1px dashed var(--border)', borderRadius: '4px',
        padding: '14px', textAlign: 'center', cursor: 'pointer'
    }});
    uploadArea.addEventListener('mouseenter', function() { uploadArea.style.borderColor = 'var(--sapphire)'; });
    uploadArea.addEventListener('mouseleave', function() { uploadArea.style.borderColor = 'var(--border)'; });
    var uploadIcon = mIcon('cloud_upload', 'icon-lg');
    uploadIcon.style.color = 'var(--text-muted)';
    uploadIcon.style.display = 'block';
    uploadIcon.style.margin = '0 auto 4px';
    uploadArea.appendChild(uploadIcon);
    uploadArea.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, ['Drop files or click to upload']));
    wrap.appendChild(uploadArea);

    return wrap;
}

// ---- MAIN RENDER ----
function render() {
    applyTheme();

    var app = document.getElementById('app');
    clearChildren(app);

    app.appendChild(buildSidebar());

    var main = el('div', { style: {
        flex: '1', display: 'flex', flexDirection: 'column',
        overflow: 'hidden', minWidth: '0'
    }});

    main.appendChild(buildHeader());
    main.appendChild(buildFilterBar());
    main.appendChild(buildStatsStrip());
    main.appendChild(buildBulkBar());
    main.appendChild(buildTable());
    main.appendChild(buildPagination());

    app.appendChild(main);
}

// ---- INIT ----
document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
render();
</script>
</body>
</html>
