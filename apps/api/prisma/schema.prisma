// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & ADMIN SERVICE (Service 01)
// ============================================================================

model Tenant {
  id                 String    @id @default(cuid())
  name               String    @db.VarChar(255)
  slug               String    @unique @db.VarChar(255)
  domain             String?   @db.VarChar(255)
  settings           Json      @default("{}")
  features           Json      @default("{}")
  branding           Json      @default("{}")
  status             String    @default("ACTIVE") @db.VarChar(20) // ACTIVE, INACTIVE, SUSPENDED, TRIAL
  trialEndsAt        DateTime?
  subscriptionPlan   String?   @db.VarChar(50)
  subscriptionStatus String?   @db.VarChar(20)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  users               User[]
  roles               Role[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]

  // CRM Relations
  companies       Company[]
  contacts        Contact[]
  opportunities   Opportunity[]
  activities      Activity[]
  hubspotSyncLogs HubspotSyncLog[]

  // Sales Relations
  quotes            Quote[]
  quoteStops        QuoteStop[]
  quoteAccessorials QuoteAccessorial[]
  rateContracts     RateContract[]
  contractLaneRates ContractLaneRate[]
  accessorialRates  AccessorialRate[]
  salesQuotas       SalesQuota[]

  // TMS Core Relations
  orders          Order[]
  loads           Load[]
  stops           Stop[]
  orderItems      OrderItem[]
  checkCalls      CheckCall[]
  statusHistories StatusHistory[]

  // Carrier Relations
  carriers                  Carrier[]
  carrierContacts           CarrierContact[]
  drivers                   Driver[]
  insuranceCertificates     InsuranceCertificate[]
  carrierDocuments          CarrierDocument[]
  carrierPerformanceHistory CarrierPerformanceHistory[]
  fmcsaComplianceLogs       FmcsaComplianceLog[]

  // Accounting Relations
  chartOfAccounts     ChartOfAccount[]
  invoices            Invoice[]
  invoiceLineItems    InvoiceLineItem[]
  settlements         Settlement[]
  settlementLineItems SettlementLineItem[]
  paymentsReceived    PaymentReceived[]
  paymentApplications PaymentApplication[]
  paymentsMade        PaymentMade[]
  journalEntries      JournalEntry[]
  journalEntryLines   JournalEntryLine[]
  quickbooksSyncLog   QuickbooksSyncLog[]

  // Load Board Relations
  loadPostings     LoadPosting[]
  carrierLoadViews CarrierLoadView[]
  loadBids         LoadBid[]
  loadTenders      LoadTender[]
  tenderRecipients TenderRecipient[]

  // Commission Relations
  commissionPlans             CommissionPlan[]
  userCommissionAssignments   UserCommissionAssignment[]
  customerCommissionOverrides CustomerCommissionOverride[]
  commissionEntries           CommissionEntry[]
  commissionPayouts           CommissionPayout[]

  // Documents Relations
  documents          Document[]
  documentTemplates  DocumentTemplate[]
  generatedDocuments GeneratedDocument[]
  documentFolders    DocumentFolder[]

  // Communication Relations
  communicationTemplates  CommunicationTemplate[]
  communicationLogs       CommunicationLog[]
  smsConversations        SmsConversation[]
  notificationPreferences NotificationPreference[]
  inAppNotifications      InAppNotification[]

  // Carrier Relations (Additional)
  carrierCapacities CarrierCapacity[]

  // Customer Portal Relations
  portalUsers        PortalUser[]
  portalSessions     PortalSession[]
  quoteRequests      QuoteRequest[]
  portalActivityLogs PortalActivityLog[]
  portalPayments     PortalPayment[]

  // Carrier Portal Relations
  carrierPortalUsers        CarrierPortalUser[]
  carrierPortalSessions     CarrierPortalSession[]
  carrierPortalDocuments    CarrierPortalDocument[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]
  carrierQuickPayRequests   CarrierQuickPayRequest[]
  carrierPortalActivityLogs CarrierPortalActivityLog[]

  // Contracts Relations
  contracts           Contract[]
  fuelSurchargeTables FuelSurchargeTable[]
  contractSLAs        ContractSLA[]
  volumeCommitments   VolumeCommitment[]

  // Agent Relations
  agents                   Agent[]
  agentAgreements          AgentAgreement[]
  agentCustomerAssignments AgentCustomerAssignment[]
  agentCommissions         AgentCommission[]

  // Factoring Relations
  factoringCompanies       FactoringCompany[]
  noaRecords               NOARecord[]
  carrierFactoringStatuses CarrierFactoringStatus[]

  // HR Relations
  employees       Employee[]
  departments     Department[]
  positions       Position[]
  timeOffRequests TimeOffRequest[]

  // Analytics Relations
  kpiDefinitions KPIDefinition[]
  dashboards     Dashboard[]
  reports        Report[]

  // Workflow Relations
  workflows          Workflow[]
  workflowExecutions WorkflowExecution[]
  approvalRequests   ApprovalRequest[]

  // Integration Hub Relations
  integrations      Integration[]
  webhookEndpoints  WebhookEndpoint[]
  webhookDeliveries WebhookDelivery[]

  // Search Relations
  savedSearches SavedSearch[]
  searchHistory SearchHistory[]

  // Audit Relations
  auditLogs     AuditLog[]
  changeHistory ChangeHistory[]

  // Cache Relations
  cacheConfigs           CacheConfig[]
  rateLimits             RateLimit[]
  cacheStats             CacheStats[]
  cacheInvalidationRules CacheInvalidationRule[]
  distributedLocks       DistributedLock[]

  // Scheduler Relations
  scheduledJobs ScheduledJob[]

  // Help Desk Relations
  supportTickets  SupportTicket[]
  ticketReplies   TicketReply[]
  kbArticles      KBArticle[]
  supportTeams    SupportTeam[]
  slaPolicies     SlaPolicy[]
  escalationRules EscalationRule[]
  cannedResponses CannedResponse[]

  // Feedback Relations
  npsSurveys      NPSSurvey[]
  npsResponses    NPSResponse[]
  featureRequests FeatureRequest[]
  surveys         Survey[]
  surveyResponses SurveyResponse[]
  feedbackWidgets FeedbackWidget[]

  // Credit Service Relations
  creditApplications   CreditApplication[]
  creditLimits         CreditLimit[]
  creditHolds          CreditHold[]
  collectionActivities CollectionActivity[]
  paymentPlans         PaymentPlan[]

  // Claims Service Relations
  claims             Claim[]
  claimItems         ClaimItem[]
  claimDocuments     ClaimDocument[]
  claimNotes         ClaimNote[]
  claimTimeline      ClaimTimeline[]
  claimAdjustments   ClaimAdjustment[]
  subrogationRecords SubrogationRecord[]
  claimContacts      ClaimContact[]

  // EDI Service Relations
  ediTradingPartners     EdiTradingPartner[]
  ediMessages            EdiMessage[]
  ediTransactionMappings EdiTransactionMapping[]
  ediControlNumbers      EdiControlNumber[]
  ediBatches             EdiBatch[]
  ediBatchMessages       EdiBatchMessage[]
  ediCommunicationLogs   EdiCommunicationLog[]
  ediEventTriggers       EdiEventTrigger[]
  ediCodeLists           EdiCodeList[]
  ediAcknowledgments     EdiAcknowledgment[]
  ediErrors              EdiError[]

  // Safety Service Relations
  fmcsaCarrierRecords      FmcsaCarrierRecord[]
  csaScores                CsaScore[]
  carrierInsurances        CarrierInsurance[]
  driverQualificationFiles DriverQualificationFile[]
  safetyIncidents          SafetyIncident[]
  safetyInspections        SafetyInspection[]
  safetyAlerts             SafetyAlert[]
  authorityChanges         AuthorityChange[]
  carrierWatchlists        CarrierWatchlist[]
  safetyAuditTrails        SafetyAuditTrail[]

  // Rate Intelligence Service Relations
  rateQueries         RateQuery[]
  rateHistories       RateHistory[]
  rateAlerts          RateAlert[]
  rateAlertHistories  RateAlertHistory[]
  laneAnalytics       LaneAnalytics[]
  rateProviderConfigs RateProviderConfig[]

  // Load Board External Service Relations
  loadBoardProviders         LoadBoardProvider[]
  loadBoardAccounts          LoadBoardAccount[]
  loadPosts                  LoadPost[]
  postLeads                  PostLead[]
  capacitySearches           CapacitySearch[]
  capacityResults            CapacityResult[]
  postingRules               PostingRule[]
  postingSchedules           PostingSchedule[]
  rateDataRecords            RateData[]
  boardMetrics               BoardMetric[]
  portalSavedPaymentMethods  PortalSavedPaymentMethod[]
  portalBrandings            PortalBranding[]
  portalNotifications        PortalNotification[]
  carrierSavedLoads          CarrierSavedLoad[]
  carrierPortalNotifications CarrierPortalNotification[]
  contractTemplates          ContractTemplate[]
  contractClauses            ContractClause[]
  contractRateTables         ContractRateTable[]
  contractRateLanes          ContractRateLane[]
  contractAmendments         ContractAmendment[]
  contractMetrics            ContractMetric[]
  agentContacts              AgentContact[]
  agentLeads                 AgentLead[]
  agentPayouts               AgentPayout[]
  agentDrawBalances          AgentDrawBalance[]
  agentPortalUsers           AgentPortalUser[]
  factoringVerifications     FactoringVerification[]
  factoredPayments           FactoredPayment[]
  locations                  Location[]
  employmentHistories        EmploymentHistory[]
  timeOffBalances            TimeOffBalance[]
  timeEntries                TimeEntry[]
  onboardingChecklists       OnboardingChecklist[]
  onboardingTasks            OnboardingTask[]
  kpisnapshots               KPISnapshot[]
  dashboardWidgets           DashboardWidget[]
  reportTemplates            ReportTemplate[]
  reportExecutions           ReportExecution[]
  savedAnalyticsViews        SavedAnalyticsView[]
  kpialerts                  KPIAlert[]
  analyticsCaches            AnalyticsCache[]
  workflowSteps              WorkflowStep[]
  stepExecutions             StepExecution[]
  workflowTemplates          WorkflowTemplate[]
  scheduledWorkflowRuns      ScheduledWorkflowRun[]
  integrationProviderConfigs IntegrationProviderConfig[]
  webhookSubscriptions       WebhookSubscription[]
  apirequestLogs             APIRequestLog[]
  transformationTemplates    TransformationTemplate[]
  syncJobs                   SyncJob[]
  circuitBreakerStateRecords CircuitBreakerStateRecord[]
  searchIndexes              SearchIndex[]
  searchSuggestions          SearchSuggestion[]
  searchSynonyms             SearchSynonym[]
  searchIndexQueues          SearchIndexQueue[]
  accessLogs                 AccessLog[]
  loginAudits                LoginAudit[]
  apiauditLogs               APIAuditLog[]
  complianceCheckpoints      ComplianceCheckpoint[]
  auditAlerts                AuditAlert[]
  auditAlertIncidents        AuditAlertIncident[]
  auditRetentionPolicies     AuditRetentionPolicy[]
  tenantConfigs              TenantConfig[]
  userPreferences            UserPreference[]
  featureFlagOverrides       FeatureFlagOverride[]
  configTemplates            ConfigTemplate[]
  configHistories            ConfigHistory[]
  businessHours              BusinessHours[]
  holidays                   Holiday[]
  numberSequences            NumberSequence[]
  scheduledTasks             ScheduledTask[]
  reminders                  Reminder[]

  @@index([slug])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model User {
  id                  String    @id @default(cuid())
  tenantId            String
  email               String    @db.VarChar(255)
  passwordHash        String    @db.VarChar(255)
  emailVerifiedAt     DateTime?
  firstName           String    @db.VarChar(100)
  lastName            String    @db.VarChar(100)
  phone               String?   @db.VarChar(20)
  avatarUrl           String?   @db.VarChar(500)
  timezone            String    @default("America/Chicago") @db.VarChar(50)
  locale              String    @default("en") @db.VarChar(10)
  status              String    @default("INVITED") @db.VarChar(20) // INVITED, ACTIVE, INACTIVE, LOCKED
  lastLoginAt         DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  roleId              String?

  // MFA (Multi-Factor Authentication) - Phase B
  mfaEnabled Boolean @default(false)
  mfaSecret  String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role                Role?                @relation(fields: [roleId], references: [id], onDelete: SetNull)
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  createdBy           User?                @relation("UserCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy           User?                @relation("UserUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  createdUsers        User[]               @relation("UserCreatedBy")
  updatedUsers        User[]               @relation("UserUpdatedBy")

  // CRM Relations
  assignedCompanies  Company[]     @relation("CompanyAssignedUser")
  ownedOpportunities Opportunity[] @relation("OpportunityOwner")
  ownedActivities    Activity[]    @relation("ActivityOwner")

  // Sales Relations
  salesQuotes Quote[]      @relation("QuoteSalesRep")
  salesQuotas SalesQuota[]

  // TMS Core Relations
  salesOrders Order[] @relation("OrderSalesRep")

  // Commission Relations
  commissionAssignments       UserCommissionAssignment[]
  customerCommissionOverrides CustomerCommissionOverride[]
  commissionEntries           CommissionEntry[]
  commissionPayouts           CommissionPayout[]
  approvedPayouts             CommissionPayout[]           @relation("PayoutApprover")

  // Documents Relations
  uploadedDocuments    Document[]          @relation
  createdTemplates     DocumentTemplate[]
  generatedDocuments   GeneratedDocument[]
  documentShares       DocumentShare[]
  createdFolders       DocumentFolder[]
  addedFolderDocuments FolderDocument[]

  // Communication Relations
  notificationPreference NotificationPreference?
  inAppNotifications     InAppNotification[]
  employee               Employee?
  agentPortalUsers       AgentPortalUser[]
  savedAnalyticsViews    SavedAnalyticsView[]
  accessLogs             AccessLog[]
  loginAudits            LoginAudit[]
  apiauditLogs           APIAuditLog[]
  userPreferences        UserPreference[]
  featureFlagOverrides   FeatureFlagOverride[]
  reminders              Reminder[]

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
  @@index([status])
  @@index([roleId])
  @@index([externalId, sourceSystem])
}

model Role {
  id          String  @id @default(cuid())
  tenantId    String? // NULL for system roles
  name        String  @db.VarChar(100)
  description String? @db.Text
  permissions Json    @default("[]") // Array of permission strings
  isSystem    Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  User[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isSystem])
}

model Session {
  id               String    @id @default(cuid())
  tenantId         String?
  userId           String
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  tenantId  String?
  userId    String
  tokenHash String    @db.VarChar(255)
  expiresAt DateTime
  usedAt    DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ============================================================================
// CRM SERVICE (Service 02)
// ============================================================================

model Company {
  id          String  @id @default(cuid())
  tenantId    String
  name        String  @db.VarChar(255)
  legalName   String? @db.VarChar(255)
  dbaName     String? @db.VarChar(255)
  companyType String  @db.VarChar(50) // CUSTOMER, PROSPECT, PARTNER, VENDOR
  status      String  @default("ACTIVE") @db.VarChar(50)
  industry    String? @db.VarChar(100)
  segment     String? @db.VarChar(50) // ENTERPRISE, MID_MARKET, SMB
  tier        String? @db.VarChar(20) // PLATINUM, GOLD, SILVER, BRONZE
  website     String? @db.VarChar(255)
  phone       String? @db.VarChar(50)
  email       String? @db.VarChar(255)

  // Address
  addressLine1 String? @db.VarChar(255)
  addressLine2 String? @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(50)
  postalCode   String? @db.VarChar(20)
  country      String  @default("USA") @db.VarChar(3)

  // Billing
  creditLimit  Decimal? @db.Decimal(12, 2)
  paymentTerms String?  @db.VarChar(50) // NET30, NET15, COD, PREPAID
  taxId        String?  @db.VarChar(50)
  dunsNumber   String?  @db.VarChar(20)

  // Operations defaults
  defaultPickupInstructions   String? @db.Text
  defaultDeliveryInstructions String? @db.Text
  requiresAppointment         Boolean @default(false)
  requiresLumper              Boolean @default(false)

  // Hierarchy & Assignment
  parentCompanyId String?
  assignedUserId  String?

  // HubSpot Integration
  hubspotId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentCompany  Company?      @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies Company[]     @relation("CompanyHierarchy")
  assignedUser   User?         @relation("CompanyAssignedUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  contacts       Contact[]
  opportunities  Opportunity[]
  activities     Activity[]

  // Sales Relations
  quotes        Quote[]
  rateContracts RateContract[]

  // TMS Core Relations
  orders Order[] @relation("OrderCustomer")

  // Accounting Relations
  invoices         Invoice[]
  paymentsReceived PaymentReceived[]

  // Commission Relations
  commissionOverrides CustomerCommissionOverride[]

  // Documents Relations
  documents Document[]

  // Additional Relations
  portalUsers              PortalUser[]
  quoteRequests            QuoteRequest[]
  portalActivityLogs       PortalActivityLog[]
  portalPayments           PortalPayment[]
  contractsAsCustomer      Contract[]                @relation("CustomerContracts")
  agentCustomerAssignments AgentCustomerAssignment[] @relation("AgentCustomerAssignments")
  agentCommissions         AgentCommission[]

  // Credit Service Relations
  creditApplications   CreditApplication[]
  creditLimits         CreditLimit[]
  creditHolds          CreditHold[]
  collectionActivities CollectionActivity[]
  paymentPlans         PaymentPlan[]

  // Claims Service Relations
  claims         Claim[]
  portalBranding PortalBranding?
  agentLeads     AgentLead[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, companyType])
  @@index([tenantId, deletedAt])
  @@index([companyType])
  @@index([status])
  @@index([assignedUserId])
  @@index([hubspotId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model Contact {
  id                     String  @id @default(cuid())
  tenantId               String
  companyId              String?
  firstName              String  @db.VarChar(100)
  lastName               String  @db.VarChar(100)
  title                  String? @db.VarChar(100)
  department             String? @db.VarChar(100)
  roleType               String? @db.VarChar(50) // PRIMARY, BILLING, SHIPPING, OPERATIONS, EXECUTIVE
  email                  String? @db.VarChar(255)
  phone                  String? @db.VarChar(50)
  mobile                 String? @db.VarChar(50)
  fax                    String? @db.VarChar(50)
  preferredContactMethod String? @db.VarChar(20) // EMAIL, PHONE, SMS
  language               String  @default("en") @db.VarChar(10)
  timezone               String? @db.VarChar(50)
  status                 String  @default("ACTIVE") @db.VarChar(50)
  isPrimary              Boolean @default(false)
  receivesInvoices       Boolean @default(false)
  receivesTracking       Boolean @default(false)

  // HubSpot Integration
  hubspotId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  opportunities Opportunity[] @relation("OpportunityPrimaryContact")
  activities    Activity[]

  // Sales Relations
  quotes Quote[]

  // TMS Core Relations
  orders Order[] @relation("OrderContact")

  @@index([tenantId])
  @@index([tenantId, email])
  @@index([tenantId, deletedAt])
  @@index([companyId])
  @@index([companyId, isPrimary])
  @@index([email])
  @@index([isPrimary])
  @@index([hubspotId])
  @@index([externalId, sourceSystem])
}

model Opportunity {
  id                     String    @id @default(cuid())
  tenantId               String
  companyId              String
  name                   String    @db.VarChar(255)
  description            String?   @db.Text
  stage                  String    @db.VarChar(50) // LEAD, QUALIFIED, PROPOSAL, NEGOTIATION, WON, LOST
  probability            Int       @default(0) // 0-100
  estimatedValue         Decimal?  @db.Decimal(12, 2)
  estimatedLoadsPerMonth Int?
  avgLoadValue           Decimal?  @db.Decimal(10, 2)
  expectedCloseDate      DateTime?
  actualCloseDate        DateTime?
  serviceTypes           String[]  @db.VarChar(50) // FTL, LTL, DRAYAGE, etc.
  lanes                  Json      @default("[]") // [{origin, destination, volume}]
  competition            String?   @db.Text
  winReason              String?   @db.Text
  lossReason             String?   @db.Text
  primaryContactId       String?
  ownerId                String

  // HubSpot Integration
  hubspotDealId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company        Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  primaryContact Contact?   @relation("OpportunityPrimaryContact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  owner          User       @relation("OpportunityOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  activities     Activity[]

  @@index([tenantId])
  @@index([companyId])
  @@index([stage])
  @@index([ownerId])
  @@index([expectedCloseDate])
  @@index([hubspotDealId])
  @@index([externalId, sourceSystem])
}

model Activity {
  id              String    @id @default(cuid())
  tenantId        String
  entityType      String    @db.VarChar(50) // COMPANY, CONTACT, OPPORTUNITY, ORDER
  entityId        String
  activityType    String    @db.VarChar(50) // CALL, EMAIL, MEETING, NOTE, TASK
  subject         String?   @db.VarChar(255)
  description     String?   @db.Text
  activityDate    DateTime  @default(now())
  durationMinutes Int?
  dueDate         DateTime?
  completedAt     DateTime?
  priority        String?   @db.VarChar(20) // HIGH, MEDIUM, LOW
  status          String    @default("PENDING") @db.VarChar(50)
  ownerId         String?

  // Linked entities (optional polymorphic)
  companyId     String?
  contactId     String?
  opportunityId String?

  // HubSpot Integration
  hubspotEngagementId String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company     Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  owner       User?        @relation("ActivityOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([activityType])
  @@index([activityDate])
  @@index([dueDate])
  @@index([status])
  @@index([ownerId])
  @@index([companyId])
  @@index([contactId])
  @@index([opportunityId])
  @@index([hubspotEngagementId])
  @@index([externalId, sourceSystem])
}

model HubspotSyncLog {
  id              String  @id @default(cuid())
  tenantId        String
  entityType      String  @db.VarChar(50) // COMPANY, CONTACT, OPPORTUNITY, ACTIVITY
  entityId        String
  hubspotId       String  @db.VarChar(50)
  syncDirection   String  @db.VarChar(20) // TO_HUBSPOT, FROM_HUBSPOT
  syncStatus      String  @db.VarChar(20) // SUCCESS, FAILED, PENDING
  payloadSent     Json?
  payloadReceived Json?
  errorMessage    String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  syncedAt  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([hubspotId])
  @@index([syncStatus])
  @@index([syncedAt])
}

// ============================================================================
// SALES SERVICE (Service 03)
// ============================================================================

model Quote {
  id            String  @id @default(cuid())
  tenantId      String
  quoteNumber   String  @db.VarChar(50)
  version       Int     @default(1)
  parentQuoteId String?
  companyId     String?
  contactId     String?

  // Quick quote customer info (when no company)
  customerName  String? @db.VarChar(255)
  customerEmail String? @db.VarChar(255)
  customerPhone String? @db.VarChar(50)

  status        String  @default("DRAFT") @db.VarChar(50) // DRAFT, SENT, VIEWED, ACCEPTED, REJECTED, EXPIRED, CONVERTED
  serviceType   String  @db.VarChar(50) // FTL, LTL, PARTIAL, DRAYAGE
  equipmentType String? @db.VarChar(50) // DRY_VAN, REEFER, FLATBED, etc.

  // Dates
  pickupDate          DateTime?
  pickupWindowStart   String?   @db.VarChar(10)
  pickupWindowEnd     String?   @db.VarChar(10)
  deliveryDate        DateTime?
  deliveryWindowStart String?   @db.VarChar(10)
  deliveryWindowEnd   String?   @db.VarChar(10)
  isFlexibleDates     Boolean   @default(false)

  // Cargo
  commodity      String?  @db.VarChar(255)
  weightLbs      Decimal? @db.Decimal(10, 2)
  pieces         Int?
  pallets        Int?
  dimensions     Json? // {length, width, height, unit}
  isHazmat       Boolean  @default(false)
  hazmatClass    String?  @db.VarChar(20)
  temperatureMin Decimal? @db.Decimal(5, 2)
  temperatureMax Decimal? @db.Decimal(5, 2)

  // Pricing
  totalMiles        Decimal? @db.Decimal(10, 2)
  linehaulRate      Decimal? @db.Decimal(12, 2)
  fuelSurcharge     Decimal? @db.Decimal(12, 2)
  accessorialsTotal Decimal? @db.Decimal(12, 2)
  totalAmount       Decimal  @db.Decimal(12, 2)
  marginAmount      Decimal? @db.Decimal(12, 2)
  marginPercent     Decimal? @db.Decimal(5, 2)
  currency          String   @default("USD") @db.VarChar(3)

  // Rate source
  rateSource     String?  @db.VarChar(50) // MANUAL, CONTRACT, MARKET, CALCULATED
  marketRateLow  Decimal? @db.Decimal(12, 2)
  marketRateAvg  Decimal? @db.Decimal(12, 2)
  marketRateHigh Decimal? @db.Decimal(12, 2)

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Conversion
  convertedOrderId String?
  convertedAt      DateTime?

  // Tracking
  sentAt          DateTime?
  viewedAt        DateTime?
  respondedAt     DateTime?
  rejectionReason String?   @db.Text

  // Notes
  internalNotes       String? @db.Text
  customerNotes       String? @db.Text
  specialInstructions String? @db.Text

  salesRepId String?

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentQuote  Quote?             @relation("QuoteVersions", fields: [parentQuoteId], references: [id], onDelete: SetNull)
  childQuotes  Quote[]            @relation("QuoteVersions")
  company      Company?           @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact      Contact?           @relation(fields: [contactId], references: [id], onDelete: SetNull)
  salesRep     User?              @relation("QuoteSalesRep", fields: [salesRepId], references: [id], onDelete: SetNull)
  stops        QuoteStop[]
  accessorials QuoteAccessorial[]

  // TMS Core Relations
  orders       Order[]
  quoteRequest QuoteRequest?

  @@unique([tenantId, quoteNumber, version])
  @@index([tenantId])
  @@index([status])
  @@index([companyId])
  @@index([salesRepId])
  @@index([pickupDate])
  @@index([externalId, sourceSystem])
}

model QuoteStop {
  id                  String   @id @default(cuid())
  tenantId            String
  quoteId             String
  stopSequence        Int
  stopType            String   @db.VarChar(20) // PICKUP, DELIVERY
  facilityName        String?  @db.VarChar(255)
  addressLine1        String   @db.VarChar(255)
  addressLine2        String?  @db.VarChar(255)
  city                String   @db.VarChar(100)
  state               String   @db.VarChar(50)
  postalCode          String   @db.VarChar(20)
  country             String   @default("USA") @db.VarChar(3)
  latitude            Decimal? @db.Decimal(10, 7)
  longitude           Decimal? @db.Decimal(10, 7)
  contactName         String?  @db.VarChar(255)
  contactPhone        String?  @db.VarChar(50)
  contactEmail        String?  @db.VarChar(255)
  appointmentRequired Boolean  @default(false)
  earliestTime        String?  @db.VarChar(10)
  latestTime          String?  @db.VarChar(10)
  instructions        String?  @db.Text
  milesToNext         Decimal? @db.Decimal(10, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, stopSequence])
  @@index([quoteId])
}

model QuoteAccessorial {
  id              String  @id @default(cuid())
  tenantId        String
  quoteId         String
  accessorialType String  @db.VarChar(50)
  description     String? @db.VarChar(255)
  quantity        Decimal @default(1) @db.Decimal(10, 2)
  unitRate        Decimal @db.Decimal(10, 2)
  totalAmount     Decimal @db.Decimal(12, 2)
  isBillable      Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model RateContract {
  id                          String   @id @default(cuid())
  tenantId                    String
  contractNumber              String   @db.VarChar(50)
  name                        String   @db.VarChar(255)
  companyId                   String
  status                      String   @default("ACTIVE") @db.VarChar(50) // DRAFT, ACTIVE, EXPIRED, TERMINATED
  effectiveDate               DateTime
  expirationDate              DateTime
  paymentTerms                String?  @db.VarChar(50)
  autoRenew                   Boolean  @default(false)
  renewalNoticeDays           Int      @default(30)
  defaultFuelSurchargeType    String?  @db.VarChar(50) // DOE_NATIONAL, DOE_REGIONAL, CUSTOM
  defaultFuelSurchargePercent Decimal? @db.Decimal(5, 2)
  minimumMarginPercent        Decimal? @db.Decimal(5, 2)
  notes                       String?  @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  laneRates        ContractLaneRate[]
  accessorialRates AccessorialRate[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([effectiveDate])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model ContractLaneRate {
  id                     String    @id @default(cuid())
  tenantId               String
  contractId             String
  originCity             String?   @db.VarChar(100)
  originState            String?   @db.VarChar(50)
  originZip              String?   @db.VarChar(20)
  originZone             String?   @db.VarChar(50)
  originRadiusMiles      Int?
  destinationCity        String?   @db.VarChar(100)
  destinationState       String?   @db.VarChar(50)
  destinationZip         String?   @db.VarChar(20)
  destinationZone        String?   @db.VarChar(50)
  destinationRadiusMiles Int?
  serviceType            String?   @db.VarChar(50) // FTL, LTL, PARTIAL
  equipmentType          String?   @db.VarChar(50)
  rateType               String    @db.VarChar(50) // PER_MILE, FLAT, PER_CWT
  rateAmount             Decimal   @db.Decimal(12, 2)
  minimumCharge          Decimal?  @db.Decimal(12, 2)
  fuelIncluded           Boolean   @default(false)
  fuelSurchargeType      String?   @db.VarChar(50)
  fuelSurchargePercent   Decimal?  @db.Decimal(5, 2)
  volumeMin              Int?
  volumeMax              Int?
  effectiveDate          DateTime?
  expirationDate         DateTime?
  notes                  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract RateContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([originState, originCity])
  @@index([destinationState, destinationCity])
}

model AccessorialRate {
  id                    String   @id @default(cuid())
  tenantId              String
  contractId            String? // NULL for tenant-wide defaults
  accessorialType       String   @db.VarChar(50)
  name                  String   @db.VarChar(255)
  description           String?  @db.Text
  rateType              String   @db.VarChar(50) // FLAT, PER_HOUR, PER_MILE, PERCENT
  rateAmount            Decimal  @db.Decimal(10, 2)
  minimumCharge         Decimal? @db.Decimal(10, 2)
  maximumCharge         Decimal? @db.Decimal(10, 2)
  appliesToServiceTypes String[] @db.VarChar(50) // FTL, LTL, etc.
  isDefault             Boolean  @default(false)
  status                String   @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract RateContract? @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([accessorialType])
}

model SalesQuota {
  id                 String   @id @default(cuid())
  tenantId           String
  userId             String
  periodType         String   @db.VarChar(20) // MONTHLY, QUARTERLY, ANNUAL
  periodStart        DateTime
  periodEnd          DateTime
  revenueTarget      Decimal? @db.Decimal(14, 2)
  loadsTarget        Int?
  newCustomersTarget Int?
  revenueActual      Decimal  @default(0) @db.Decimal(14, 2)
  loadsActual        Int      @default(0)
  newCustomersActual Int      @default(0)
  status             String   @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, periodStart])
  @@index([tenantId])
  @@index([userId])
  @@index([periodStart, periodEnd])
}

// ============================================================================
// TMS CORE SERVICE (Service 04)
// ============================================================================

model Order {
  id                String  @id @default(cuid())
  tenantId          String
  orderNumber       String  @db.VarChar(50)
  customerReference String? @db.VarChar(100)
  poNumber          String? @db.VarChar(100)
  bolNumber         String? @db.VarChar(100)
  customerId        String
  customerContactId String?
  quoteId           String?
  salesRepId        String?

  status String @default("PENDING") @db.VarChar(30) // PENDING, QUOTED, BOOKED, DISPATCHED, IN_TRANSIT, DELIVERED, INVOICED, COMPLETED, CANCELLED

  // Pricing
  customerRate       Decimal? @db.Decimal(10, 2)
  accessorialCharges Decimal  @default(0) @db.Decimal(10, 2)
  fuelSurcharge      Decimal  @default(0) @db.Decimal(10, 2)
  totalCharges       Decimal? @db.Decimal(10, 2)
  currency           String   @default("USD") @db.VarChar(3)

  // Cargo
  commodity      String?  @db.VarChar(255)
  commodityClass String?  @db.VarChar(10)
  weightLbs      Decimal? @db.Decimal(10, 2)
  pieceCount     Int?
  palletCount    Int?
  equipmentType  String?  @db.VarChar(30)

  // Hazmat
  isHazmat    Boolean @default(false)
  hazmatClass String? @db.VarChar(20)

  // Temperature
  temperatureMin Decimal? @db.Decimal(5, 2)
  temperatureMax Decimal? @db.Decimal(5, 2)

  // Dates
  orderDate            DateTime  @default(now())
  requiredDeliveryDate DateTime?
  actualDeliveryDate   DateTime?

  // Notes
  specialInstructions String? @db.Text
  internalNotes       String? @db.Text

  // Flags
  isHot       Boolean @default(false)
  isTeam      Boolean @default(false)
  isExpedited Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer        Company         @relation("OrderCustomer", fields: [customerId], references: [id], onDelete: Restrict)
  customerContact Contact?        @relation("OrderContact", fields: [customerContactId], references: [id], onDelete: SetNull)
  quote           Quote?          @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  salesRep        User?           @relation("OrderSalesRep", fields: [salesRepId], references: [id], onDelete: SetNull)
  loads           Load[]
  stops           Stop[]
  items           OrderItem[]
  statusHistory   StatusHistory[]

  // Accounting Relations
  invoices         Invoice[]
  invoiceLineItems InvoiceLineItem[]

  // Commission Relations
  commissionEntries CommissionEntry[]

  // Documents Relations
  documents        Document[]
  agentCommissions AgentCommission[]

  // Claims Service Relations
  claims Claim[]

  // Load Board External Relations
  loadPosts LoadPost[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([externalId, sourceSystem])
}

model Load {
  id         String  @id @default(cuid())
  tenantId   String
  loadNumber String  @db.VarChar(50)
  orderId    String
  carrierId  String?

  // Driver info
  driverName    String? @db.VarChar(100)
  driverPhone   String? @db.VarChar(20)
  truckNumber   String? @db.VarChar(20)
  trailerNumber String? @db.VarChar(20)

  status String @default("PENDING") @db.VarChar(30) // PENDING, TENDERED, ACCEPTED, AT_PICKUP, PICKED_UP, IN_TRANSIT, AT_DELIVERY, DELIVERED, COMPLETED

  // Pricing
  carrierRate      Decimal? @db.Decimal(10, 2)
  accessorialCosts Decimal  @default(0) @db.Decimal(10, 2)
  fuelAdvance      Decimal  @default(0) @db.Decimal(10, 2)
  totalCost        Decimal? @db.Decimal(10, 2)

  // Tracking
  currentLocationLat Decimal? @db.Decimal(10, 7)
  currentLocationLng Decimal? @db.Decimal(10, 7)
  currentCity        String?  @db.VarChar(100)
  currentState       String?  @db.VarChar(50)
  lastTrackingUpdate DateTime?
  eta                DateTime?

  // Equipment
  equipmentType        String? @db.VarChar(30)
  equipmentLength      Int?
  equipmentWeightLimit Int?

  // Timestamps
  dispatchedAt DateTime?
  pickedUpAt   DateTime?
  deliveredAt  DateTime?

  // Rate confirmation
  rateConfirmationSent   Boolean @default(false)
  rateConfirmationSigned Boolean @default(false)

  dispatchNotes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  carrier       Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  stops         Stop[]
  checkCalls    CheckCall[]
  statusHistory StatusHistory[]

  // Accounting Relations
  invoices            Invoice[]
  invoiceLineItems    InvoiceLineItem[]
  settlementLineItems SettlementLineItem[]

  // Load Board Relations
  postings LoadPosting[]
  bids     LoadBid[]
  tenders  LoadTender[]

  // Commission Relations
  commissionEntries CommissionEntry[]

  // Documents Relations
  documents                 Document[]
  carrierPortalDocuments    CarrierPortalDocument[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]
  carrierQuickPayRequests   CarrierQuickPayRequest[]
  agentCommissions          AgentCommission[]

  // Claims Service Relations
  claims Claim[]

  // Safety Service Relations
  safetyIncidents SafetyIncident[]

  // Load Board External Relations
  loadPosts         LoadPost[]
  carrierSavedLoads CarrierSavedLoad[]

  @@unique([tenantId, loadNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, carrierId])
  @@index([tenantId, deletedAt])
  @@index([createdAt])
  @@index([orderId])
  @@index([carrierId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Stop {
  id           String  @id @default(cuid())
  tenantId     String
  orderId      String
  loadId       String?
  stopType     String  @db.VarChar(20) // PICKUP, DELIVERY, STOP
  stopSequence Int

  // Location
  facilityName String?  @db.VarChar(255)
  addressLine1 String   @db.VarChar(255)
  addressLine2 String?  @db.VarChar(255)
  city         String   @db.VarChar(100)
  state        String   @db.VarChar(50)
  postalCode   String   @db.VarChar(20)
  country      String   @default("USA") @db.VarChar(50)
  latitude     Decimal? @db.Decimal(10, 7)
  longitude    Decimal? @db.Decimal(10, 7)

  // Contact
  contactName  String? @db.VarChar(100)
  contactPhone String? @db.VarChar(20)
  contactEmail String? @db.VarChar(255)

  // Appointment
  appointmentRequired  Boolean   @default(false)
  appointmentDate      DateTime?
  appointmentTimeStart String?   @db.VarChar(10)
  appointmentTimeEnd   String?   @db.VarChar(10)
  appointmentNumber    String?   @db.VarChar(50)

  status     String    @default("PENDING") @db.VarChar(20) // PENDING, EN_ROUTE, ARRIVED, LOADING, COMPLETED
  arrivedAt  DateTime?
  departedAt DateTime?

  // Cargo at stop
  weightLbs   Decimal? @db.Decimal(10, 2)
  pieceCount  Int?
  palletCount Int?

  // Instructions
  specialInstructions String? @db.Text
  driverInstructions  String? @db.Text
  accessorials        Json    @default("[]")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  load          Load?           @relation(fields: [loadId], references: [id], onDelete: SetNull)
  items         OrderItem[]
  statusHistory StatusHistory[]

  @@unique([orderId, stopSequence])
  @@index([tenantId])
  @@index([orderId])
  @@index([loadId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model OrderItem {
  id               String   @id @default(cuid())
  tenantId         String
  orderId          String
  stopId           String?
  description      String   @db.VarChar(255)
  quantity         Int      @default(1)
  quantityType     String?  @db.VarChar(20) // PIECES, PALLETS, SKIDS, CRATES
  weightLbs        Decimal? @db.Decimal(10, 2)
  dimensionsLength Int?
  dimensionsWidth  Int?
  dimensionsHeight Int?
  commodityClass   String?  @db.VarChar(10)
  nmfcCode         String?  @db.VarChar(20)
  isHazmat         Boolean  @default(false)
  hazmatClass      String?  @db.VarChar(20)
  unNumber         String?  @db.VarChar(20)
  sku              String?  @db.VarChar(100)
  lotNumber        String?  @db.VarChar(100)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  stop   Stop?  @relation(fields: [stopId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([orderId])
  @@index([stopId])
  @@index([externalId, sourceSystem])
}

model CheckCall {
  id             String    @id @default(cuid())
  tenantId       String
  loadId         String
  city           String?   @db.VarChar(100)
  state          String?   @db.VarChar(50)
  latitude       Decimal?  @db.Decimal(10, 7)
  longitude      Decimal?  @db.Decimal(10, 7)
  status         String?   @db.VarChar(30)
  notes          String?   @db.Text
  contacted      String?   @db.VarChar(50) // DRIVER, DISPATCHER, TRACKING_SYSTEM
  contactMethod  String?   @db.VarChar(20) // PHONE, TEXT, APP, GPS
  eta            DateTime?
  milesRemaining Int?
  source         String?   @db.VarChar(30) // MANUAL, MACROPOINT, ELD, DRIVER_APP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load   Load   @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([loadId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model StatusHistory {
  id         String  @id @default(cuid())
  tenantId   String
  entityType String  @db.VarChar(20) // ORDER, LOAD, STOP
  entityId   String
  oldStatus  String? @db.VarChar(30)
  newStatus  String  @db.VarChar(30)
  notes      String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])
  orderId String?
  load    Load?   @relation(fields: [loadId], references: [id])
  loadId  String?
  stop    Stop?   @relation(fields: [stopId], references: [id])
  stopId  String?

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ============================================================================
// CARRIER SERVICE (Service 05)
// ============================================================================

model Carrier {
  id          String  @id @default(cuid())
  tenantId    String
  mcNumber    String? @db.VarChar(20)
  dotNumber   String? @db.VarChar(20)
  scacCode    String? @db.VarChar(10)
  carrierCode String? @db.VarChar(50)
  legalName   String  @db.VarChar(255)
  dbaName     String? @db.VarChar(255)
  companyType String? @db.VarChar(50) // CARRIER, OWNER_OPERATOR, BROKER, ASSET_BASED

  // Primary contact
  primaryContactName  String? @db.VarChar(255)
  primaryContactEmail String? @db.VarChar(255)
  primaryContactPhone String? @db.VarChar(50)
  dispatchEmail       String? @db.VarChar(255)
  dispatchPhone       String? @db.VarChar(50)
  afterHoursPhone     String? @db.VarChar(50)

  // Address
  addressLine1 String? @db.VarChar(255)
  addressLine2 String? @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(50)
  postalCode   String? @db.VarChar(20)
  country      String  @default("USA") @db.VarChar(3)

  // Tax & Banking
  taxId                String?  @db.VarChar(50)
  w9OnFile             Boolean  @default(false)
  taxClassification    String?  @db.VarChar(50)
  paymentTerms         String?  @db.VarChar(50) // QUICK_PAY, NET30, NET15
  quickPayFeePercent   Decimal? @db.Decimal(5, 2)
  factoringCompany     String?  @db.VarChar(255)
  factoringAccount     String?  @db.VarChar(100)
  bankName             String?  @db.VarChar(255)
  bankRoutingNumber    String?  @db.VarChar(50)
  bankAccountNumberEnc String?  @db.VarChar(255) // Encrypted
  bankAccountType      String?  @db.VarChar(20) // CHECKING, SAVINGS

  // Equipment & Service
  equipmentTypes String[] @db.VarChar(50)
  truckCount     Int?
  trailerCount   Int?
  serviceStates  String[] @db.VarChar(3)
  preferredLanes Json     @default("[]") // [{origin_state, dest_state}]

  // Status & Qualification
  status            String    @default("PENDING") @db.VarChar(50) // PENDING, ACTIVE, SUSPENDED, INACTIVE, BLACKLISTED
  qualificationTier String?   @db.VarChar(20) // PLATINUM, GOLD, SILVER, BRONZE, UNQUALIFIED
  qualificationDate DateTime?

  // FMCSA Data
  fmcsaAuthorityStatus   String?   @db.VarChar(50)
  fmcsaCommonAuthority   Boolean?
  fmcsaContractAuthority Boolean?
  fmcsaBrokerAuthority   Boolean?
  fmcsaSafetyRating      String?   @db.VarChar(50)
  fmcsaOutOfService      Boolean   @default(false)
  fmcsaLastChecked       DateTime?

  // Performance Metrics
  complianceScore    Int? // 0-100
  safetyScore        Int? // 0-100
  totalLoads         Int      @default(0)
  onTimePickupRate   Decimal? @db.Decimal(5, 2)
  onTimeDeliveryRate Decimal? @db.Decimal(5, 2)
  claimsRate         Decimal? @db.Decimal(5, 2)
  avgRating          Decimal? @db.Decimal(3, 2)

  // Communication
  preferredLanguage       String  @default("en") @db.VarChar(10)
  communicationPreference String? @db.VarChar(20) // EMAIL, PHONE, SMS, APP

  // Notes
  internalNotes   String? @db.Text
  onboardingNotes String? @db.Text

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts              CarrierContact[]
  drivers               Driver[]
  insuranceCertificates InsuranceCertificate[]
  documents             CarrierDocument[]
  performanceHistory    CarrierPerformanceHistory[]
  complianceLogs        FmcsaComplianceLog[]
  loads                 Load[]

  // Accounting Relations
  settlements  Settlement[]
  paymentsMade PaymentMade[]

  // Load Board Relations
  loadViews        CarrierLoadView[]
  loadBids         LoadBid[]
  tendersAccepted  LoadTender[]
  tenderRecipients TenderRecipient[]

  // Documents Relations
  carrierDocuments Document[]

  // Additional Relations
  capacities         CarrierCapacity[]
  portalUsers        CarrierPortalUser[]
  portalSessions     CarrierPortalSession[]
  portalDocuments    CarrierPortalDocument[]
  invoiceSubmissions CarrierInvoiceSubmission[]
  quickPayRequests   CarrierQuickPayRequest[]
  portalActivityLogs CarrierPortalActivityLog[]
  contracts          Contract[]
  noaRecords         NOARecord[]
  factoringStatus    CarrierFactoringStatus?

  // Claims Service Relations
  claims Claim[]

  // Safety Service Relations
  fmcsaRecord       FmcsaCarrierRecord?
  csaScores         CsaScore[]
  carrierInsurances CarrierInsurance[]
  safetyIncidents   SafetyIncident[]
  safetyInspections SafetyInspection[]
  safetyAlerts      SafetyAlert[]
  authorityChanges  AuthorityChange[]
  watchlistEntries  CarrierWatchlist[]
  safetyAuditTrail  SafetyAuditTrail[]

  // Load Board External Relations
  postLeads PostLead[]

  @@unique([tenantId, mcNumber])
  @@unique([tenantId, dotNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deletedAt])
  @@index([mcNumber])
  @@index([dotNumber])
  @@index([scacCode])
  @@index([status])
  @@index([qualificationTier])
  @@index([equipmentTypes])
  @@index([serviceStates])
  @@index([externalId, sourceSystem])
}

model CarrierContact {
  id                   String  @id @default(cuid())
  tenantId             String
  carrierId            String
  firstName            String  @db.VarChar(100)
  lastName             String  @db.VarChar(100)
  title                String? @db.VarChar(100)
  role                 String? @db.VarChar(50) // OWNER, DISPATCHER, ACCOUNTING, SAFETY, DRIVER
  email                String? @db.VarChar(255)
  phone                String? @db.VarChar(50)
  mobile               String? @db.VarChar(50)
  isPrimary            Boolean @default(false)
  receivesRateConfirms Boolean @default(false)
  receivesPodRequests  Boolean @default(false)
  receivesPayments     Boolean @default(false)
  preferredLanguage    String  @default("en") @db.VarChar(10)
  isActive             Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([carrierId])
  @@index([isPrimary])
  @@index([role])
  @@index([isActive])
}

model Driver {
  id            String    @id @default(cuid())
  tenantId      String
  carrierId     String
  firstName     String    @db.VarChar(100)
  lastName      String    @db.VarChar(100)
  email         String?   @db.VarChar(255)
  phone         String?   @db.VarChar(50)
  cdlNumber     String?   @db.VarChar(50)
  cdlState      String?   @db.VarChar(3)
  cdlExpiration DateTime?
  cdlClass      String?   @db.VarChar(5) // A, B, C
  endorsements  String[]  @db.VarChar(20) // H, N, P, S, T, X
  status        String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, INACTIVE, SUSPENDED

  // Location tracking
  currentLocationLat Decimal?  @db.Decimal(10, 7)
  currentLocationLng Decimal?  @db.Decimal(10, 7)
  locationUpdatedAt  DateTime?

  // Performance
  totalLoads Int      @default(0)
  onTimeRate Decimal? @db.Decimal(5, 2)
  avgRating  Decimal? @db.Decimal(3, 2)

  // Integration
  preferredLanguage String  @default("en") @db.VarChar(10)
  appUserId         String?
  eldProvider       String? @db.VarChar(50)
  eldDriverId       String? @db.VarChar(100)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Safety Service Relations
  qualificationFiles DriverQualificationFile[]
  safetyIncidents    SafetyIncident[]
  safetyInspections  SafetyInspection[]

  @@unique([tenantId, carrierId, cdlNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deletedAt])
  @@index([carrierId])
  @@index([status])
  @@index([cdlExpiration])
  @@index([externalId, sourceSystem])
}

model InsuranceCertificate {
  id                    String    @id @default(cuid())
  tenantId              String
  carrierId             String
  insuranceType         String    @db.VarChar(50) // AUTO_LIABILITY, CARGO, GENERAL_LIABILITY, WORKERS_COMP
  policyNumber          String?   @db.VarChar(100)
  insuranceCompany      String    @db.VarChar(255)
  coverageAmount        Decimal   @db.Decimal(14, 2)
  deductible            Decimal?  @db.Decimal(12, 2)
  effectiveDate         DateTime
  expirationDate        DateTime
  certificateHolderName String?   @db.VarChar(255)
  additionalInsured     Boolean   @default(false)
  documentUrl           String?   @db.VarChar(500)
  status                String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, EXPIRING_SOON, EXPIRED, CANCELLED
  verified              Boolean   @default(false)
  verifiedById          String?
  verifiedAt            DateTime?
  expirationNotified30  Boolean   @default(false)
  expirationNotified14  Boolean   @default(false)
  expirationNotified7   Boolean   @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([carrierId, insuranceType, policyNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([insuranceType])
  @@index([expirationDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierDocument {
  id              String    @id @default(cuid())
  tenantId        String
  carrierId       String
  documentType    String    @db.VarChar(50) // W9, CARRIER_AGREEMENT, AUTHORITY_LETTER, VOID_CHECK, OTHER
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  filePath        String?   @db.VarChar(500)
  fileSize        Int?
  mimeType        String?   @db.VarChar(100)
  status          String    @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED, EXPIRED
  reviewedById    String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text
  expirationDate  DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([documentType])
  @@index([status])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model CarrierPerformanceHistory {
  id                  String   @id @default(cuid())
  tenantId            String
  carrierId           String
  periodType          String   @db.VarChar(20) // WEEKLY, MONTHLY, QUARTERLY
  periodStart         DateTime
  periodEnd           DateTime
  loadsCompleted      Int      @default(0)
  loadsCancelled      Int      @default(0)
  onTimePickups       Int      @default(0)
  onTimeDeliveries    Int      @default(0)
  latePickups         Int      @default(0)
  lateDeliveries      Int      @default(0)
  claimsCount         Int      @default(0)
  claimsAmount        Decimal  @default(0) @db.Decimal(12, 2)
  onTimePickupRate    Decimal? @db.Decimal(5, 2)
  onTimeDeliveryRate  Decimal? @db.Decimal(5, 2)
  claimsRate          Decimal? @db.Decimal(5, 2)
  totalPaid           Decimal  @default(0) @db.Decimal(14, 2)
  avgRatePerMile      Decimal? @db.Decimal(8, 2)
  avgDispatcherRating Decimal? @db.Decimal(3, 2)
  avgCustomerRating   Decimal? @db.Decimal(3, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([carrierId, periodType, periodStart])
  @@index([tenantId])
  @@index([carrierId])
  @@index([periodType])
  @@index([periodStart])
}

model FmcsaComplianceLog {
  id                   String   @id @default(cuid())
  tenantId             String
  carrierId            String
  checkedAt            DateTime @default(now())
  dotNumber            String?  @db.VarChar(20)
  mcNumber             String?  @db.VarChar(20)
  authorityStatus      String?  @db.VarChar(50)
  commonAuthority      Boolean?
  contractAuthority    Boolean?
  brokerAuthority      Boolean?
  safetyRating         String?  @db.VarChar(50)
  outOfService         Boolean?
  driverInspections    Int?
  driverOosRate        Decimal? @db.Decimal(5, 2)
  vehicleInspections   Int?
  vehicleOosRate       Decimal? @db.Decimal(5, 2)
  fmcsaInsuranceOnFile Boolean?
  fmcsaInsuranceAmount Decimal? @db.Decimal(14, 2)
  changesDetected      Json     @default("[]") // [{field, old_value, new_value}]
  rawResponse          Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([checkedAt])
  @@index([dotNumber])
  @@index([mcNumber])
  @@index([externalId, sourceSystem])
}

// ============================================================================
// ACCOUNTING SERVICE (Service 06)
// ============================================================================

model ChartOfAccount {
  id              String  @id @default(cuid())
  tenantId        String
  accountNumber   String  @db.VarChar(20)
  accountName     String  @db.VarChar(255)
  accountType     String  @db.VarChar(50) // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  accountSubType  String? @db.VarChar(50) // BANK, AR, AP, REVENUE, EXPENSE, etc.
  parentAccountId String?
  description     String? @db.Text
  normalBalance   String  @db.VarChar(10) // DEBIT, CREDIT
  isActive        Boolean @default(true)
  isSystemAccount Boolean @default(false)
  balance         Decimal @default(0) @db.Decimal(14, 2)

  // QuickBooks sync
  quickbooksId String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentAccount ChartOfAccount?  @relation("AccountHierarchy", fields: [parentAccountId], references: [id], onDelete: SetNull)
  childAccounts ChartOfAccount[] @relation("AccountHierarchy")

  // Invoice relations
  invoiceRevenueAccounts Invoice[] @relation("InvoiceRevenueAccount")
  invoiceArAccounts      Invoice[] @relation("InvoiceArAccount")

  // Invoice line relations
  invoiceLineAccounts InvoiceLineItem[] @relation("InvoiceLineRevenueAccount")

  // Settlement relations
  settlementExpenseAccounts Settlement[] @relation("SettlementExpenseAccount")
  settlementApAccounts      Settlement[] @relation("SettlementApAccount")

  // Settlement line relations
  settlementLineAccounts SettlementLineItem[] @relation("SettlementLineExpenseAccount")

  // Payment relations
  paymentsReceivedBank PaymentReceived[] @relation("PaymentReceivedBankAccount")
  paymentsMadeBank     PaymentMade[]     @relation("PaymentMadeBankAccount")

  // Journal entry lines
  journalEntryLines JournalEntryLine[]

  @@unique([tenantId, accountNumber])
  @@index([tenantId])
  @@index([accountType])
  @@index([isActive])
  @@index([parentAccountId])
  @@index([externalId, sourceSystem])
}

model Invoice {
  id            String  @id @default(cuid())
  tenantId      String
  invoiceNumber String  @db.VarChar(50)
  companyId     String
  orderId       String?
  loadId        String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Dates
  invoiceDate DateTime
  dueDate     DateTime
  sentAt      DateTime?

  // Amounts
  subtotal    Decimal @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @db.Decimal(12, 2)
  totalAmount Decimal @db.Decimal(12, 2)
  amountPaid  Decimal @default(0) @db.Decimal(12, 2)
  balanceDue  Decimal @db.Decimal(12, 2)
  currency    String  @default("USD") @db.VarChar(3)

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, SENT, VIEWED, PARTIAL, PAID, OVERDUE, VOID

  // Terms
  paymentTerms String? @db.VarChar(50)

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Aging
  daysOutstanding Int?
  agingBucket     String? @db.VarChar(20) // CURRENT, 1-30, 31-60, 61-90, 90+

  // Collection
  lastReminderDate DateTime?
  reminderCount    Int       @default(0)
  collectionStatus String?   @db.VarChar(50)

  // GL Accounts
  revenueAccountId String?
  arAccountId      String?

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  updatedById String?
  voidedAt    DateTime?
  voidedById  String?
  voidReason  String?   @db.Text

  // Custom fields
  customFields Json @default("{}")

  // Relations
  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company        Company              @relation(fields: [companyId], references: [id])
  order          Order?               @relation(fields: [orderId], references: [id])
  load           Load?                @relation(fields: [loadId], references: [id])
  revenueAccount ChartOfAccount?      @relation("InvoiceRevenueAccount", fields: [revenueAccountId], references: [id])
  arAccount      ChartOfAccount?      @relation("InvoiceArAccount", fields: [arAccountId], references: [id])
  lineItems      InvoiceLineItem[]
  applications   PaymentApplication[]

  // Agent Service Relations
  agentCommissions AgentCommission[]

  // Credit Service Relations
  collectionActivities CollectionActivity[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, companyId])
  @@index([tenantId, dueDate])
  @@index([tenantId, status, dueDate])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@index([orderId])
  @@index([loadId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model InvoiceLineItem {
  id        String  @id @default(cuid())
  tenantId  String
  invoiceId String
  loadId    String?
  orderId   String?

  // Line details
  lineNumber  Int
  description String  @db.VarChar(500)
  itemType    String? @db.VarChar(50) // FREIGHT, ACCESSORIAL, ADJUSTMENT

  // Amounts
  quantity  Decimal @default(1) @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  amount    Decimal @db.Decimal(12, 2)

  // GL
  revenueAccountId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice        Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  load           Load?           @relation(fields: [loadId], references: [id])
  order          Order?          @relation(fields: [orderId], references: [id])
  revenueAccount ChartOfAccount? @relation("InvoiceLineRevenueAccount", fields: [revenueAccountId], references: [id])

  @@unique([invoiceId, lineNumber])
  @@index([tenantId])
  @@index([invoiceId])
  @@index([loadId])
  @@index([orderId])
  @@index([externalId, sourceSystem])
}

model Settlement {
  id               String @id @default(cuid())
  tenantId         String
  settlementNumber String @db.VarChar(50)
  carrierId        String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Dates
  settlementDate DateTime
  dueDate        DateTime

  // Payment method
  paymentType        String?  @db.VarChar(50) // QUICK_PAY, NET30, FACTORING
  quickPayFeePercent Decimal? @db.Decimal(5, 2)
  quickPayFeeAmount  Decimal? @db.Decimal(12, 2)

  // Amounts
  grossAmount     Decimal @db.Decimal(12, 2)
  deductionsTotal Decimal @default(0) @db.Decimal(12, 2)
  quickPayFee     Decimal @default(0) @db.Decimal(12, 2)
  netAmount       Decimal @db.Decimal(12, 2)
  amountPaid      Decimal @default(0) @db.Decimal(12, 2)
  balanceDue      Decimal @db.Decimal(12, 2)
  currency        String  @default("USD") @db.VarChar(3)

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, PENDING, APPROVED, PARTIAL, PAID, VOID

  // Payment destination
  paymentMethod      String? @db.VarChar(50) // CHECK, ACH, WIRE
  payToName          String? @db.VarChar(255)
  payToFactoring     Boolean @default(false)
  factoringCompanyId String?
  factoringAccount   String? @db.VarChar(100)

  // GL Accounts
  expenseAccountId String?
  apAccountId      String?

  // Approval
  approvedById String?
  approvedAt   DateTime?

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Custom fields
  customFields Json @default("{}")

  // Relations
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier                   Carrier                    @relation(fields: [carrierId], references: [id])
  expenseAccount            ChartOfAccount?            @relation("SettlementExpenseAccount", fields: [expenseAccountId], references: [id])
  apAccount                 ChartOfAccount?            @relation("SettlementApAccount", fields: [apAccountId], references: [id])
  lineItems                 SettlementLineItem[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]
  factoredPayments          FactoredPayment[]

  @@unique([tenantId, settlementNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([status])
  @@index([dueDate])
  @@index([settlementDate])
  @@index([externalId, sourceSystem])
}

model SettlementLineItem {
  id           String  @id @default(cuid())
  tenantId     String
  settlementId String
  loadId       String?

  // Line details
  lineNumber  Int
  description String  @db.VarChar(500)
  itemType    String? @db.VarChar(50) // FREIGHT, ACCESSORIAL, DEDUCTION, ADVANCE

  // Amounts
  quantity Decimal @default(1) @db.Decimal(10, 2)
  unitRate Decimal @db.Decimal(12, 2)
  amount   Decimal @db.Decimal(12, 2)

  // GL
  expenseAccountId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settlement     Settlement      @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  load           Load?           @relation(fields: [loadId], references: [id])
  expenseAccount ChartOfAccount? @relation("SettlementLineExpenseAccount", fields: [expenseAccountId], references: [id])

  @@unique([settlementId, lineNumber])
  @@index([tenantId])
  @@index([settlementId])
  @@index([loadId])
  @@index([externalId, sourceSystem])
}

model PaymentReceived {
  id            String @id @default(cuid())
  tenantId      String
  paymentNumber String @db.VarChar(50)
  companyId     String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Payment details
  paymentDate   DateTime
  paymentMethod String   @db.VarChar(50) // CHECK, ACH, WIRE, CREDIT_CARD, CASH

  // Amount
  amount          Decimal @db.Decimal(12, 2)
  unappliedAmount Decimal @default(0) @db.Decimal(12, 2)
  currency        String  @default("USD") @db.VarChar(3)

  // Reference
  referenceNumber String? @db.VarChar(100)

  // Bank
  bankAccountId String?
  depositDate   DateTime?

  // Status
  status String @default("RECEIVED") @db.VarChar(50) // RECEIVED, APPLIED, PARTIAL, BOUNCED, REFUNDED

  // Notes
  notes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company      Company              @relation(fields: [companyId], references: [id])
  bankAccount  ChartOfAccount?      @relation("PaymentReceivedBankAccount", fields: [bankAccountId], references: [id])
  applications PaymentApplication[]

  @@unique([tenantId, paymentNumber])
  @@index([tenantId])
  @@index([companyId])
  @@index([paymentDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model PaymentApplication {
  id        String  @id @default(cuid())
  tenantId  String
  paymentId String
  invoiceId String
  amount    Decimal @db.Decimal(12, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment PaymentReceived @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice         @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([paymentId])
  @@index([invoiceId])
  @@index([externalId, sourceSystem])
}

model PaymentMade {
  id            String @id @default(cuid())
  tenantId      String
  paymentNumber String @db.VarChar(50)
  carrierId     String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Payment details
  paymentDate   DateTime
  paymentMethod String   @db.VarChar(50) // CHECK, ACH, WIRE

  // Amount
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Reference
  referenceNumber String? @db.VarChar(100)

  // Bank
  bankAccountId String?

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, SENT, CLEARED, VOID

  // ACH/Wire details
  achBatchId     String? @db.VarChar(100)
  achTraceNumber String? @db.VarChar(100)

  // Notes
  notes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier     Carrier         @relation(fields: [carrierId], references: [id])
  bankAccount ChartOfAccount? @relation("PaymentMadeBankAccount", fields: [bankAccountId], references: [id])

  @@unique([tenantId, paymentNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([paymentDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model JournalEntry {
  id          String @id @default(cuid())
  tenantId    String
  entryNumber String @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Details
  entryDate   DateTime
  description String?  @db.Text

  // Reference
  referenceType String? @db.VarChar(50) // INVOICE, SETTLEMENT, PAYMENT, MANUAL
  referenceId   String?

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, POSTED, VOID

  // Amounts (must balance)
  totalDebit  Decimal @db.Decimal(14, 2)
  totalCredit Decimal @db.Decimal(14, 2)

  // Posting
  postedById String?
  postedAt   DateTime?

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines  JournalEntryLine[]

  @@unique([tenantId, entryNumber])
  @@index([tenantId])
  @@index([entryDate])
  @@index([referenceType, referenceId])
  @@index([status])
}

model JournalEntryLine {
  id             String @id @default(cuid())
  tenantId       String
  journalEntryId String
  lineNumber     Int
  accountId      String

  description  String? @db.VarChar(255)
  debitAmount  Decimal @default(0) @db.Decimal(14, 2)
  creditAmount Decimal @default(0) @db.Decimal(14, 2)

  // Dimensions (for reporting)
  customerId String?
  carrierId  String?
  loadId     String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  journalEntry JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      ChartOfAccount @relation(fields: [accountId], references: [id])

  @@unique([journalEntryId, lineNumber])
  @@index([tenantId])
  @@index([journalEntryId])
  @@index([accountId])
  @@index([externalId, sourceSystem])
}

model QuickbooksSyncLog {
  id           String  @id @default(cuid())
  tenantId     String
  entityType   String  @db.VarChar(50)
  entityId     String
  quickbooksId String? @db.VarChar(50)

  syncDirection String @db.VarChar(20) // TO_QB, FROM_QB
  syncStatus    String @db.VarChar(20) // SUCCESS, FAILED, PENDING

  payloadSent     Json?
  payloadReceived Json?
  errorMessage    String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime  @default(now())
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([syncStatus])
  @@index([externalId, sourceSystem])
}

// ==============================================
// LOAD BOARD MODULE
// ==============================================

model LoadPosting {
  id       String @id @default(cuid())
  tenantId String
  loadId   String

  // Posting details
  postingType String @db.VarChar(50) // INTERNAL, EXTERNAL, BOTH
  visibility  String @default("ALL_CARRIERS") @db.VarChar(50) // ALL_CARRIERS, PREFERRED_ONLY, SPECIFIC_CARRIERS

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, BOOKED, EXPIRED, CANCELLED

  // Rate visibility
  showRate   Boolean  @default(false)
  rateType   String?  @db.VarChar(50) // ALL_IN, PER_MILE
  postedRate Decimal? @db.Decimal(12, 2)
  rateMin    Decimal? @db.Decimal(12, 2)
  rateMax    Decimal? @db.Decimal(12, 2)

  // Origin (denormalized for search)
  originCity  String?  @db.VarChar(100)
  originState String?  @db.VarChar(50)
  originZip   String?  @db.VarChar(20)
  originLat   Decimal? @db.Decimal(10, 7)
  originLng   Decimal? @db.Decimal(10, 7)

  // Destination
  destCity  String?  @db.VarChar(100)
  destState String?  @db.VarChar(50)
  destZip   String?  @db.VarChar(20)
  destLat   Decimal? @db.Decimal(10, 7)
  destLng   Decimal? @db.Decimal(10, 7)

  // Load details (denormalized)
  equipmentType String?   @db.VarChar(50)
  totalMiles    Decimal?  @db.Decimal(10, 2)
  weightLbs     Decimal?  @db.Decimal(10, 2)
  pickupDate    DateTime?
  deliveryDate  DateTime?

  // External postings
  datPostingId       String? @db.VarChar(100)
  truckstopPostingId String? @db.VarChar(100)

  // Timing
  postedAt        DateTime  @default(now())
  expiresAt       DateTime?
  autoRefresh     Boolean   @default(true)
  refreshInterval Int       @default(4) // hours
  lastRefreshedAt DateTime?

  // Metrics
  viewCount    Int @default(0)
  inquiryCount Int @default(0)

  // Specific carriers (for SPECIFIC_CARRIERS visibility)
  carrierIds String[] // Array of carrier IDs

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load   Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  views  CarrierLoadView[]
  bids   LoadBid[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deletedAt])
  @@index([loadId])
  @@index([originState, originCity])
  @@index([destState, destCity])
  @@index([originState, destState])
  @@index([pickupDate])
  @@index([equipmentType])
  @@index([status])
  @@index([status, expiresAt])
  @@index([status, originState, expiresAt])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model CarrierLoadView {
  id        String @id @default(cuid())
  tenantId  String
  postingId String
  carrierId String

  viewedAt DateTime @default(now())
  source   String?  @db.VarChar(50) // INTERNAL, DAT, TRUCKSTOP, EMAIL

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  posting LoadPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  carrier Carrier     @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([postingId, carrierId])
  @@index([tenantId])
  @@index([postingId])
  @@index([carrierId])
  @@index([externalId, sourceSystem])
}

model LoadBid {
  id        String @id @default(cuid())
  tenantId  String
  postingId String
  loadId    String
  carrierId String

  // Bid details
  bidAmount Decimal @db.Decimal(12, 2)
  rateType  String? @db.VarChar(50) // ALL_IN, PER_MILE
  notes     String? @db.Text

  // Equipment offered
  truckNumber String? @db.VarChar(50)
  driverName  String? @db.VarChar(255)
  driverPhone String? @db.VarChar(50)

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, ACCEPTED, REJECTED, COUNTERED, EXPIRED, WITHDRAWN

  // Counter offer
  counterAmount Decimal?  @db.Decimal(12, 2)
  counterNotes  String?   @db.Text
  counterAt     DateTime?

  // Resolution
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Timing
  submittedAt DateTime  @default(now())
  expiresAt   DateTime?

  // Source
  source String? @db.VarChar(50) // INTERNAL, CARRIER_PORTAL, DAT, TRUCKSTOP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  posting LoadPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  load    Load        @relation(fields: [loadId], references: [id], onDelete: Cascade)
  carrier Carrier     @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deletedAt])
  @@index([postingId])
  @@index([postingId, status])
  @@index([carrierId])
  @@index([carrierId, status])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model LoadTender {
  id       String @id @default(cuid())
  tenantId String
  loadId   String

  // Tender settings
  tenderType String  @db.VarChar(50) // BROADCAST, WATERFALL, SPECIFIC
  tenderRate Decimal @db.Decimal(12, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, ACCEPTED, EXPIRED, CANCELLED

  // Timing
  expiresAt DateTime?

  // Waterfall settings
  waterfallTimeoutMinutes Int @default(30)
  currentPosition         Int @default(0)

  // Result
  acceptedByCarrierId String?
  acceptedAt          DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load              Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  acceptedByCarrier Carrier?          @relation(fields: [acceptedByCarrierId], references: [id], onDelete: SetNull)
  recipients        TenderRecipient[]

  @@index([tenantId])
  @@index([loadId])
  @@index([tenantId, status])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model TenderRecipient {
  id        String @id @default(cuid())
  tenantId  String
  tenderId  String
  carrierId String

  // Waterfall position (1 = first to offer)
  position Int

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, OFFERED, ACCEPTED, DECLINED, EXPIRED, SKIPPED

  // Timing
  offeredAt   DateTime?
  respondedAt DateTime?
  expiresAt   DateTime?

  // Response
  declineReason String? @db.Text

  // Notification
  notificationSent   Boolean @default(false)
  notificationMethod String? @db.VarChar(50) // EMAIL, SMS, APP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tender  LoadTender @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  carrier Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([tenderId, position])
  @@index([tenantId])
  @@index([tenderId])
  @@index([carrierId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// ==============================================
// COMMISSION MODULE
// ==============================================

model CommissionPlan {
  id       String @id @default(cuid())
  tenantId String

  // Plan details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Type
  planType String @db.VarChar(50) // FLAT_FEE, PERCENT_REVENUE, PERCENT_MARGIN, TIERED, CUSTOM

  // Status
  status    String  @default("ACTIVE") @db.VarChar(50) // ACTIVE, INACTIVE
  isDefault Boolean @default(false)

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Base rates
  flatAmount  Decimal? @db.Decimal(10, 2)
  percentRate Decimal? @db.Decimal(5, 2)

  // Basis
  calculationBasis String? @db.VarChar(50) // GROSS_REVENUE, NET_MARGIN, LINEHAUL

  // Conditions
  minimumMarginPercent Decimal? @db.Decimal(5, 2)

  // Custom rules
  rules Json @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tiers       CommissionPlanTier[]
  assignments UserCommissionAssignment[]
  entries     CommissionEntry[]

  @@unique([tenantId, name, effectiveDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([externalId, sourceSystem])
}

model CommissionPlanTier {
  id     String @id @default(cuid())
  planId String

  // Tier definition
  tierNumber Int
  tierName   String? @db.VarChar(100)

  // Thresholds
  thresholdType String   @db.VarChar(50) // REVENUE, LOAD_COUNT, MARGIN
  thresholdMin  Decimal  @db.Decimal(14, 2)
  thresholdMax  Decimal? @db.Decimal(14, 2)

  // Rate
  rateType   String  @db.VarChar(50) // FLAT, PERCENT
  rateAmount Decimal @db.Decimal(10, 2)

  // Period
  periodType String? @db.VarChar(50) // MONTHLY, QUARTERLY, ANNUAL

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  plan CommissionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, tierNumber])
  @@index([planId])
  @@index([externalId, sourceSystem])
}

model UserCommissionAssignment {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  planId   String

  // Override rates
  overrideRate Decimal? @db.Decimal(5, 2)
  overrideFlat Decimal? @db.Decimal(10, 2)

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Draw
  drawAmount      Decimal @default(0) @db.Decimal(10, 2)
  drawRecoverable Boolean @default(true)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   CommissionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@unique([tenantId, userId, effectiveDate])
  @@index([tenantId])
  @@index([userId])
  @@index([planId])
  @@index([externalId, sourceSystem])
}

model CustomerCommissionOverride {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Override rate
  rateType         String  @db.VarChar(50) // FLAT, PERCENT
  rateAmount       Decimal @db.Decimal(10, 2)
  calculationBasis String? @db.VarChar(50) // GROSS_REVENUE, NET_MARGIN

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, companyId, userId, effectiveDate])
  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([externalId, sourceSystem])
}

model CommissionEntry {
  id       String  @id @default(cuid())
  tenantId String
  userId   String
  loadId   String?
  orderId  String?

  // Entry type
  entryType String @db.VarChar(50) // LOAD_COMMISSION, BONUS, ADJUSTMENT, DRAW, DRAW_RECOVERY

  // Calculation details
  planId           String?
  calculationBasis String?  @db.VarChar(50)
  basisAmount      Decimal? @db.Decimal(12, 2)
  rateApplied      Decimal? @db.Decimal(5, 2)

  // Commission
  commissionAmount Decimal @db.Decimal(12, 2)

  // Split info
  isSplit       Boolean @default(false)
  splitPercent  Decimal @default(100) @db.Decimal(5, 2)
  parentEntryId String?

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, PAID, REVERSED

  // Period
  commissionPeriod DateTime @db.Date

  // Notes
  notes String? @db.Text

  // Reversal
  reversedAt     DateTime?
  reversedBy     String?
  reversalReason String?   @db.Text

  // Payout
  payoutId String?
  paidAt   DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  load         Load?             @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order        Order?            @relation(fields: [orderId], references: [id], onDelete: SetNull)
  plan         CommissionPlan?   @relation(fields: [planId], references: [id], onDelete: SetNull)
  parentEntry  CommissionEntry?  @relation("EntrySplits", fields: [parentEntryId], references: [id], onDelete: SetNull)
  splitEntries CommissionEntry[] @relation("EntrySplits")
  payout       CommissionPayout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([userId])
  @@index([loadId])
  @@index([tenantId, commissionPeriod])
  @@index([tenantId, status])
  @@index([externalId, sourceSystem])
}

model CommissionPayout {
  id           String   @id @default(cuid())
  tenantId     String
  payoutNumber String   @db.VarChar(50)
  payoutDate   DateTime @db.Date
  periodStart  DateTime @db.Date
  periodEnd    DateTime @db.Date
  userId       String

  // Amounts
  grossCommission Decimal @db.Decimal(12, 2)
  drawRecovery    Decimal @default(0) @db.Decimal(12, 2)
  adjustments     Decimal @default(0) @db.Decimal(12, 2)
  netPayout       Decimal @db.Decimal(12, 2)

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, PROCESSING, PAID, VOID

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Payment
  paymentMethod    String?   @db.VarChar(50) // CHECK, ACH, PAYROLL
  paymentReference String?   @db.VarChar(100)
  paidAt           DateTime?

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  approver User?             @relation("PayoutApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  entries  CommissionEntry[]

  @@unique([tenantId, payoutNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, paidAt])
  @@index([tenantId, deletedAt])
  @@index([userId])
  @@index([tenantId, periodStart])
  @@index([externalId, sourceSystem])
}

// ============================================
// DOCUMENTS MODULE
// ============================================

model Document {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Migration support
  externalId   String? @db.VarChar(100)
  sourceSystem String? @db.VarChar(50)

  // Document info
  name         String  @db.VarChar(255)
  description  String? @db.Text
  documentType String  @db.VarChar(50) // BOL, POD, RATE_CONFIRM, INVOICE, INSURANCE, CONTRACT, W9, CARRIER_AGREEMENT, OTHER

  // File details
  fileName      String  @db.VarChar(255)
  filePath      String  @db.VarChar(500)
  fileSize      Int
  mimeType      String  @db.VarChar(100)
  fileExtension String? @db.VarChar(20)

  // Storage
  storageProvider String  @default("S3") @db.VarChar(50) // S3, MINIO, LOCAL
  bucketName      String? @db.VarChar(100)

  // Entity association (polymorphic)
  entityType String? @db.VarChar(50) // LOAD, ORDER, CARRIER, COMPANY, USER
  entityId   String?

  // Additional associations
  loadId    String?
  orderId   String?
  carrierId String?
  companyId String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, ARCHIVED, DELETED, PROCESSING, FAILED

  // OCR Processing
  ocrProcessed   Boolean   @default(false)
  ocrText        String?   @db.Text
  ocrProcessedAt DateTime?

  // Metadata
  metadata Json     @default("{}")
  tags     String[] @db.VarChar(100)

  // Versioning
  version          Int     @default(1)
  parentDocumentId String?
  isLatestVersion  Boolean @default(true)

  // Security
  isPublic        Boolean   @default(false)
  accessToken     String?   @db.VarChar(100)
  accessExpiresAt DateTime?

  // Retention
  retentionDate DateTime? @db.Date

  // Custom fields
  customFields Json @default("{}")

  // Audit
  uploadedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load                  Load?               @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order                 Order?              @relation(fields: [orderId], references: [id], onDelete: SetNull)
  carrier               Carrier?            @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  company               Company?            @relation(fields: [companyId], references: [id], onDelete: SetNull)
  uploader              User?               @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  parentDocument        Document?           @relation("DocumentVersions", fields: [parentDocumentId], references: [id], onDelete: SetNull)
  childDocuments        Document[]          @relation("DocumentVersions")
  shares                DocumentShare[]
  folderDocuments       FolderDocument[]
  generatedDocuments    GeneratedDocument[]
  agentPayoutStatements AgentPayout[]       @relation("AgentPayoutStatementDocument")

  // Claims Service Relations
  claimDocuments         ClaimDocument[]
  contractAmendments     ContractAmendment[]
  factoringVerifications FactoringVerification[]

  @@index([tenantId])
  @@index([tenantId, documentType])
  @@index([tenantId, deletedAt])
  @@index([entityType, entityId])
  @@index([loadId])
  @@index([carrierId])
  @@index([companyId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model DocumentTemplate {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Template details
  name         String  @db.VarChar(255)
  description  String? @db.Text
  templateType String  @db.VarChar(50) // RATE_CONFIRM, BOL, INVOICE, CARRIER_PACKET, QUOTE, STATEMENT

  // Template content
  templateFormat   String  @db.VarChar(50) // HTML, PDF, DOCX
  templateContent  String? @db.Text // HTML/Handlebars template
  templateFilePath String? @db.VarChar(500)

  // Settings
  paperSize   String @default("LETTER") @db.VarChar(20) // LETTER, A4, LEGAL
  orientation String @default("PORTRAIT") @db.VarChar(20) // PORTRAIT, LANDSCAPE
  margins     Json   @default("{\"top\": 1, \"bottom\": 1, \"left\": 1, \"right\": 1}")

  // Branding
  includeLogo   Boolean @default(true)
  logoPosition  String  @default("TOP_LEFT") @db.VarChar(20)
  headerContent String? @db.Text
  footerContent String? @db.Text

  // Status
  status    String  @default("ACTIVE") @db.VarChar(50)
  isDefault Boolean @default(false)

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator            User?               @relation(fields: [createdById], references: [id], onDelete: SetNull)
  generatedDocuments GeneratedDocument[]

  @@unique([tenantId, name, templateType])
  @@index([tenantId])
  @@index([tenantId, templateType])
  @@index([externalId, sourceSystem])
}

model GeneratedDocument {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Generation details
  templateId String
  documentId String?

  // Source data
  entityType String @db.VarChar(50)
  entityId   String

  // Generation data
  dataSnapshot Json // Data used for generation

  // Status
  status       String  @default("PENDING") @db.VarChar(50) // PENDING, GENERATING, COMPLETED, FAILED
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Timing
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  requestedBy String?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template  DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  document  Document?        @relation(fields: [documentId], references: [id], onDelete: SetNull)
  requester User?            @relation(fields: [requestedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model DocumentShare {
  id String @id @default(uuid())

  // Document
  documentId String

  // Share type
  shareType String @db.VarChar(50) // LINK, EMAIL, PORTAL

  // Access
  accessToken    String  @unique @db.VarChar(100)
  accessPassword String? @db.VarChar(255) // Optional password (hashed)

  // Restrictions
  expiresAt     DateTime?
  maxViews      Int?
  maxDownloads  Int?
  allowDownload Boolean   @default(true)

  // Tracking
  viewCount      Int       @default(0)
  downloadCount  Int       @default(0)
  lastAccessedAt DateTime?

  // Recipient (for email shares)
  recipientEmail String? @db.VarChar(255)
  recipientName  String? @db.VarChar(255)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, EXPIRED, REVOKED

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  creator  User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([accessToken])
  @@index([externalId, sourceSystem])
}

model DocumentFolder {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Folder info
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentFolderId String?
  path           String? @db.VarChar(1000) // /root/subfolder/...

  // Association
  entityType String? @db.VarChar(50)
  entityId   String?

  // Settings
  isSystem Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentFolder    DocumentFolder?  @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  childFolders    DocumentFolder[] @relation("FolderHierarchy")
  creator         User?            @relation(fields: [createdById], references: [id], onDelete: SetNull)
  folderDocuments FolderDocument[]

  @@unique([tenantId, parentFolderId, name])
  @@index([tenantId])
  @@index([parentFolderId])
  @@index([entityType, entityId])
  @@index([externalId, sourceSystem])
}

model FolderDocument {
  folderId   String
  documentId String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  addedAt     DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  addedBy     String?
  createdById String?
  updatedById String?

  // Relations
  folder   DocumentFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  document Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  adder    User?          @relation(fields: [addedBy], references: [id], onDelete: SetNull)

  @@id([folderId, documentId])
}

// ============================================================================
// COMMUNICATION SERVICE (Service 11)
// ============================================================================

model CommunicationTemplate {
  id          String  @id @default(cuid())
  tenantId    String
  name        String  @db.VarChar(255)
  code        String  @db.VarChar(100) // LOAD_ASSIGNED, POD_REQUEST, etc.
  description String? @db.Text
  category    String? @db.VarChar(50) // LOAD, CARRIER, CUSTOMER, SYSTEM
  channel     String  @db.VarChar(50) // EMAIL, SMS, PUSH, IN_APP

  // Content (bilingual)
  subjectEn String? @db.VarChar(500)
  subjectEs String? @db.VarChar(500)
  bodyEn    String  @db.Text
  bodyEs    String? @db.Text

  // Email specific
  fromName  String? @db.VarChar(255)
  fromEmail String? @db.VarChar(255)
  replyTo   String? @db.VarChar(255)

  status   String  @default("ACTIVE") @db.VarChar(50)
  isSystem Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  logs   CommunicationLog[]

  @@unique([tenantId, code, channel])
  @@index([tenantId])
  @@index([code])
  @@index([channel])
  @@index([category])
  @@index([externalId, sourceSystem])
}

model CommunicationLog {
  id           String  @id @default(cuid())
  tenantId     String
  channel      String  @db.VarChar(50) // EMAIL, SMS, PUSH, IN_APP
  templateId   String?
  templateCode String? @db.VarChar(100)

  // Recipient
  recipientType  String? @db.VarChar(50) // USER, CARRIER, CONTACT, DRIVER
  recipientId    String?
  recipientEmail String? @db.VarChar(255)
  recipientPhone String? @db.VarChar(50)
  recipientName  String? @db.VarChar(255)

  // Content
  subject     String? @db.VarChar(500)
  body        String  @db.Text
  bodyHtml    String? @db.Text
  language    String  @default("en") @db.VarChar(10)
  attachments Json? // [{name, url, size}]

  // Entity association
  entityType String? @db.VarChar(50) // LOAD, ORDER, CARRIER, COMPANY
  entityId   String?

  // Status: PENDING, SENT, DELIVERED, FAILED, BOUNCED, OPENED, CLICKED
  status String @default("PENDING") @db.VarChar(50)

  // Tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  failedAt    DateTime?

  // Provider
  provider          String? @db.VarChar(50) // SENDGRID, TWILIO, FCM
  providerMessageId String? @db.VarChar(255)

  // Error handling
  errorMessage String?   @db.Text
  retryCount   Int       @default(0)
  lastRetryAt  DateTime?

  metadata Json @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template CommunicationTemplate? @relation(fields: [templateId], references: [id])

  @@index([tenantId])
  @@index([recipientType, recipientId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([channel])
  @@index([createdAt])
  @@index([templateCode])
  @@index([externalId, sourceSystem])
}

model SmsConversation {
  id              String  @id @default(cuid())
  tenantId        String
  phoneNumber     String  @db.VarChar(50)
  participantType String? @db.VarChar(50) // CARRIER, DRIVER, CONTACT
  participantId   String?
  participantName String? @db.VarChar(255)
  loadId          String?

  status             String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, CLOSED
  unreadCount        Int       @default(0)
  lastMessageAt      DateTime?
  lastMessagePreview String?   @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages SmsMessage[]

  @@unique([tenantId, phoneNumber, loadId])
  @@index([tenantId])
  @@index([phoneNumber])
  @@index([participantType, participantId])
  @@index([loadId])
  @@index([externalId, sourceSystem])
}

model SmsMessage {
  id             String @id @default(cuid())
  conversationId String
  direction      String @db.VarChar(20) // INBOUND, OUTBOUND
  body           String @db.Text
  mediaUrls      Json? // Array of media URLs

  // Status: PENDING, SENT, DELIVERED, FAILED, RECEIVED
  status String @default("PENDING") @db.VarChar(50)

  providerMessageId String? @db.VarChar(255)
  errorMessage      String? @db.Text

  sentAt      DateTime?
  deliveredAt DateTime?
  receivedAt  DateTime?
  readAt      DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  conversation SmsConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([direction])
  @@index([status])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model NotificationPreference {
  id       String @id @default(cuid())
  tenantId String
  userId   String @unique

  // Notification types (which events to notify)
  loadAssigned     Boolean @default(true)
  loadStatusChange Boolean @default(true)
  documentReceived Boolean @default(true)
  invoiceCreated   Boolean @default(true)
  paymentReceived  Boolean @default(true)
  claimFiled       Boolean @default(true)
  carrierExpiring  Boolean @default(true)

  // Channels (how to notify)
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Quiet hours
  quietHoursEnabled  Boolean @default(false)
  quietHoursStart    String? @db.VarChar(5) // HH:MM
  quietHoursEnd      String? @db.VarChar(5)
  quietHoursTimezone String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@index([externalId, sourceSystem])
}

model InAppNotification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  type      String  @db.VarChar(50) // LOAD, CARRIER, INVOICE, SYSTEM, etc.
  title     String  @db.VarChar(255)
  message   String  @db.Text
  icon      String? @db.VarChar(50)
  actionUrl String? @db.VarChar(500)

  entityType String? @db.VarChar(50)
  entityId   String?

  isRead Boolean   @default(false)
  readAt DateTime?

  expiresAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CARRIER SERVICE - CarrierCapacity Model
// ==============================================

model CarrierCapacity {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // Equipment
  equipmentType String @db.VarChar(50) // DRY_VAN, REEFER, FLATBED, STEP_DECK, etc.

  // Capacity
  availableUnits Int @default(0)
  totalUnits     Int

  // Location
  city    String?  @db.VarChar(100)
  state   String?  @db.VarChar(50)
  zipCode String?  @db.VarChar(20)
  lat     Decimal? @db.Decimal(10, 7)
  lng     Decimal? @db.Decimal(10, 7)

  // Timing
  effectiveDate DateTime  @db.Date
  expiresAt     DateTime? @db.Date

  // Status
  status CapacityStatus @default(AVAILABLE)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([equipmentType])
  @@index([state])
  @@index([effectiveDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// This file contains all new enums and models for pending Phase A services
// This content will be appended to schema.prisma

// ==============================================
// ENUMS FOR PENDING SERVICES
// ==============================================

// Carrier Service - CarrierCapacity
enum CapacityStatus {
  AVAILABLE
  COMMITTED
  INACTIVE
}

// Customer Portal (Service 12)
enum PortalUserRole {
  ADMIN
  USER
  VIEW_ONLY
}

enum PortalUserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum QuoteRequestStatus {
  SUBMITTED
  REVIEWING
  QUOTED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum PortalPaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// Carrier Portal (Service 13)
enum CarrierPortalUserRole {
  OWNER
  ADMIN
  DISPATCHER
  DRIVER
}

enum CarrierDocumentType {
  POD
  LUMPER_RECEIPT
  SCALE_TICKET
  BOL_SIGNED
  WEIGHT_TICKET
  OTHER
}

enum CarrierDocumentStatus {
  UPLOADED
  REVIEWING
  APPROVED
  REJECTED
}

enum QuickPayStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

// Contracts (Service 14)
enum ContractType {
  CUSTOMER_RATE
  CARRIER_RATE
  DEDICATED_CAPACITY
  VOLUME_COMMITMENT
  AGENT_AGREEMENT
}

enum ContractStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT_FOR_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
}

enum RateType {
  FLAT
  PER_MILE
  PER_CWT
  PER_PALLET
  PERCENTAGE
}

enum SLAType {
  ON_TIME_PICKUP
  ON_TIME_DELIVERY
  CLAIMS_RATIO
  TENDER_ACCEPTANCE
}

// Agent (Service 15)
enum AgentType {
  REFERRING
  SELLING
  HYBRID
}

enum AgentStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum AgentTier {
  STANDARD
  SILVER
  GOLD
  PLATINUM
}

enum AssignmentType {
  PRIMARY
  SECONDARY
  SPLIT
}

enum AssignmentStatus {
  ACTIVE
  SUNSET
  TRANSFERRED
  TERMINATED
}

enum LeadStatus {
  SUBMITTED
  IN_REVIEW
  QUALIFIED
  WORKING
  CONVERTED
  REJECTED
  EXPIRED
}

enum CommissionSplitType {
  PERCENT_OF_REP
  PERCENT_OF_MARGIN
  FLAT_PER_LOAD
  TIERED
}

enum AgreementStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

enum AgentCommissionStatus {
  CALCULATED
  APPROVED
  PAID
  ADJUSTED
  VOIDED
}

enum AgentPayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  PAID
  FAILED
}

// Factoring (Service 16)
enum NOAStatus {
  PENDING
  VERIFIED
  ACTIVE
  EXPIRED
  RELEASED
}

enum FactoringStatus {
  NONE
  FACTORED
  QUICK_PAY_ONLY
}

enum VerificationStatus {
  PENDING
  VERIFIED
  PARTIAL
  DECLINED
}

// HR (Service 17)
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMP
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

enum TimeOffType {
  PTO
  SICK
  VACATION
  PERSONAL
  FLOATING_HOLIDAY
}

enum TimeOffRequestStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

// Analytics (Service 18)
enum KPICategory {
  FINANCIAL
  OPERATIONAL
  CARRIER
  CUSTOMER
  SALES
}

enum AggregationType {
  SUM
  AVG
  COUNT
  MIN
  MAX
  RATIO
}

enum PeriodType {
  HOUR
  DAY
  WEEK
  MONTH
  QUARTER
  YEAR
}

enum ReportType {
  STANDARD
  CUSTOM
  AD_HOC
}

enum OutputFormat {
  PDF
  EXCEL
  CSV
  JSON
}

// Workflow (Service 19)
enum TriggerType {
  EVENT
  SCHEDULE
  MANUAL
  WEBHOOK
}

enum StepType {
  ACTION
  CONDITION
  APPROVAL
  WAIT
  PARALLEL
  LOOP
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  WAITING
}

enum ApprovalType {
  SINGLE
  ALL
  ANY
  SEQUENTIAL
}

// Integration Hub (Service 20)
enum IntegrationCategory {
  LOAD_BOARD
  ACCOUNTING
  ELD
  CRM
  RATING
  TMS
  DOCUMENT
  TRACKING
}

enum AuthType {
  API_KEY
  OAUTH2
  BASIC
  NONE
}

enum SyncFrequency {
  REALTIME
  HOURLY
  DAILY
  MANUAL
}

enum WebhookStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

enum CircuitBreakerState {
  CLOSED
  OPEN
  HALF_OPEN
}

// Search (Service 21)
enum SearchEntityType {
  ORDERS
  LOADS
  COMPANIES
  CARRIERS
  CONTACTS
  INVOICES
  DOCUMENTS
}

enum IndexStatus {
  ACTIVE
  REBUILDING
  ERROR
}

// Audit (Service 22)
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum AuditActionCategory {
  DATA
  AUTH
  ADMIN
  SYSTEM
}

enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AuditEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  PASSWORD_RESET
  MFA_ENABLED
  DATA_EXPORT
  PERMISSION_CHANGE
}

// Config (Service 23)
enum ConfigCategory {
  SECURITY
  LIMITS
  DEFAULTS
  INTEGRATIONS
  EMAIL
  NOTIFICATIONS
}

enum FeatureFlagStatus {
  ACTIVE
  DEPRECATED
  ARCHIVED
}

enum ConfigTemplateType {
  TENANT
  USER
}

// Scheduler (Service 24)
enum ScheduleType {
  CRON
  INTERVAL
  ONCE
  MANUAL
}

enum JobType {
  SYSTEM
  TENANT
  USER
}

enum JobExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum ReminderStatus {
  PENDING
  SENT
  SNOOZED
  DISMISSED
  COMPLETED
}

// Cache (Service 25)
enum CacheType {
  ENTITY
  QUERY
  SESSION
  CONFIG
}

enum InvalidationType {
  DELETE
  REFRESH
}

enum RateLimitScope {
  USER
  TENANT
  IP
  GLOBAL
}

// Help Desk (Service 26)
enum TicketSource {
  EMAIL
  PORTAL
  PHONE
  CHAT
  INTERNAL
}

enum TicketType {
  QUESTION
  PROBLEM
  INCIDENT
  REQUEST
}

enum TicketPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum TicketStatus {
  NEW
  OPEN
  PENDING
  ON_HOLD
  RESOLVED
  CLOSED
}

enum ReplyType {
  PUBLIC
  INTERNAL_NOTE
  SYSTEM
}

// Feedback (Service 27)
enum NPSCategory {
  PROMOTER
  PASSIVE
  DETRACTOR
}

enum SurveyType {
  NPS
  CSAT
  CUSTOM
  EXIT
  ONBOARDING
}

enum FeatureRequestStatus {
  SUBMITTED
  UNDER_REVIEW
  PLANNED
  IN_PROGRESS
  COMPLETED
  DECLINED
}

enum FeedbackType {
  BUG
  SUGGESTION
  COMPLAINT
  PRAISE
  OTHER
}

// ==============================================
// CUSTOMER PORTAL (Service 12) - Core Models
// ==============================================

model PortalUser {
  id        String @id @default(cuid())
  tenantId  String
  companyId String

  // User info
  email     String  @db.VarChar(255)
  password  String  @db.VarChar(255)
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  phone     String? @db.VarChar(20)

  // Role and status
  role   PortalUserRole   @default(USER)
  status PortalUserStatus @default(PENDING)

  // Verification
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  verificationToken String?   @unique @db.VarChar(255)

  // Session
  lastLoginAt DateTime?

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company                   Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sessions                  PortalSession[]
  quoteRequests             QuoteRequest[]
  activityLogs              PortalActivityLog[]
  payments                  PortalPayment[]
  portalSavedPaymentMethods PortalSavedPaymentMethod[]
  portalNotifications       PortalNotification[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([companyId])
  @@index([email])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model PortalSession {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Session data
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
  @@index([externalId, sourceSystem])
}

model QuoteRequest {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Request details
  requestNumber String  @unique @db.VarChar(50)
  subject       String? @db.VarChar(255)
  description   String? @db.Text

  // Shipment details
  originCity              String?   @db.VarChar(100)
  originState             String?   @db.VarChar(50)
  originZip               String?   @db.VarChar(20)
  destCity                String?   @db.VarChar(100)
  destState               String?   @db.VarChar(50)
  destZip                 String?   @db.VarChar(20)
  pickupDate              DateTime? @db.Date
  deliveryDate            DateTime? @db.Date
  equipmentType           String?   @db.VarChar(50)
  commodity               String?   @db.VarChar(255)
  weightLbs               Decimal?  @db.Decimal(10, 2)
  palletCount             Int?
  isHazmat                Boolean   @default(false)
  isTemperatureControlled Boolean   @default(false)
  tempRange               String?   @db.VarChar(50)

  // Status
  status QuoteRequestStatus @default(SUBMITTED)

  // Quote info
  quoteId        String?   @unique
  quotedAmount   Decimal?  @db.Decimal(12, 2)
  quotedAt       DateTime?
  quotedBy       String?
  quoteExpiresAt DateTime?

  // Response
  acceptedAt    DateTime?
  declinedAt    DateTime?
  declineReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  quote   Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([requestNumber])
  @@index([externalId, sourceSystem])
}

model PortalActivityLog {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Activity
  action      String  @db.VarChar(100)
  entityType  String? @db.VarChar(50)
  entityId    String?
  description String? @db.Text

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company?   @relation(fields: [companyId], references: [id])
  companyId String?

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model PortalPayment {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Payment details
  paymentNumber String  @unique @db.VarChar(50)
  amount        Decimal @db.Decimal(12, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Status
  status PortalPaymentStatus @default(PENDING)

  // Method
  paymentMethod  String  @db.VarChar(50) // CREDIT_CARD, ACH, WIRE
  lastFourDigits String? @db.VarChar(4)

  // Processor
  processorTransactionId String? @db.VarChar(255)
  processorResponse      Json?

  // Applied to
  invoiceIds String[] // Array of invoice IDs

  // Timing
  processedAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([paymentNumber])
  @@index([externalId, sourceSystem])
}

model PortalSavedPaymentMethod {
  id           String @id @default(cuid())
  tenantId     String
  portalUserId String

  // Payment method details
  paymentMethodType String  @db.VarChar(50) // CREDIT_CARD, ACH, WIRE
  lastFourDigits    String? @db.VarChar(4)
  cardBrand         String? @db.VarChar(50) // VISA, MASTERCARD, AMEX, DISCOVER
  expirationMonth   Int?
  expirationYear    Int?

  // Billing info
  billingName    String? @db.VarChar(255)
  billingAddress String? @db.VarChar(255)
  billingCity    String? @db.VarChar(100)
  billingState   String? @db.VarChar(2)
  billingZip     String? @db.VarChar(10)

  // Status
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // External reference (Stripe, etc)
  externalToken String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  portalUser PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([portalUserId])
  @@index([isDefault])
  @@index([externalId, sourceSystem])
}

model PortalBranding {
  id        String @id @default(cuid())
  tenantId  String
  companyId String @unique

  // Visual branding
  logoUrl        String? @db.VarChar(500)
  faviconUrl     String? @db.VarChar(500)
  primaryColor   String? @db.VarChar(7) // Hex color
  secondaryColor String? @db.VarChar(7)
  accentColor    String? @db.VarChar(7)

  // Custom styling
  customCss String? @db.Text
  customJs  String? @db.Text

  // Custom content
  headerHtml     String? @db.Text
  footerHtml     String? @db.Text
  welcomeMessage String? @db.Text

  // Domain
  customDomain String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([customDomain])
  @@index([externalId, sourceSystem])
}

enum PortalNotificationType {
  QUOTE_READY
  LOAD_UPDATE
  INVOICE_AVAILABLE
  PAYMENT_RECEIVED
  DOCUMENT_UPLOADED
  MESSAGE_RECEIVED
  SHIPMENT_DELAYED
  DELIVERY_CONFIRMED
  GENERAL
}

model PortalNotification {
  id           String @id @default(cuid())
  tenantId     String
  portalUserId String

  // Notification details
  notificationType PortalNotificationType
  title            String                 @db.VarChar(255)
  message          String                 @db.Text

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Action
  actionUrl String? @db.VarChar(500)

  // Related entity
  relatedEntityType String? @db.VarChar(50) // QUOTE, LOAD, ORDER, INVOICE, DOCUMENT
  relatedEntityId   String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  portalUser PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([portalUserId])
  @@index([isRead])
  @@index([notificationType])
  @@index([createdAt])
  @@index([relatedEntityType, relatedEntityId])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CARRIER PORTAL (Service 13) - Core Models
// ==============================================

model CarrierPortalUser {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // User info
  email     String  @db.VarChar(255)
  password  String  @db.VarChar(255)
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  phone     String? @db.VarChar(20)

  // Role and status
  role   CarrierPortalUserRole @default(DISPATCHER)
  status PortalUserStatus      @default(PENDING)

  // Verification
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  verificationToken String?   @unique @db.VarChar(255)

  // Session
  lastLoginAt DateTime?

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                     Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier                    Carrier                     @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  sessions                   CarrierPortalSession[]
  documents                  CarrierPortalDocument[]
  invoiceSubmissions         CarrierInvoiceSubmission[]
  quickPayRequests           CarrierQuickPayRequest[]
  activityLogs               CarrierPortalActivityLog[]
  carrierSavedLoads          CarrierSavedLoad[]
  carrierPortalNotifications CarrierPortalNotification[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([carrierId])
  @@index([email])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierPortalSession {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Session data
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  carrier   Carrier?          @relation(fields: [carrierId], references: [id])
  carrierId String?

  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
  @@index([externalId, sourceSystem])
}

model CarrierPortalDocument {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String?

  // Document info
  documentType CarrierDocumentType @default(POD)
  fileName     String              @db.VarChar(255)
  filePath     String              @db.VarChar(500)
  fileSize     Int
  mimeType     String              @db.VarChar(100)

  // Status
  status CarrierDocumentStatus @default(UPLOADED)

  // Review
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text
  rejectionNotes String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user    CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load    Load?             @relation(fields: [loadId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([documentType])
  @@index([externalId, sourceSystem])
}

model CarrierInvoiceSubmission {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String

  // Invoice details
  invoiceNumber String   @db.VarChar(50)
  amount        Decimal  @db.Decimal(12, 2)
  invoiceDate   DateTime @db.Date

  // Status
  status String @default("SUBMITTED") @db.VarChar(50)

  // Review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  // Linked settlement
  settlementId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier    Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user       CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load       Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  settlement Settlement?       @relation(fields: [settlementId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([externalId, sourceSystem])
}

model CarrierQuickPayRequest {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String

  // Request details
  requestedAmount Decimal @db.Decimal(12, 2)
  feePercent      Decimal @db.Decimal(5, 2)
  feeAmount       Decimal @db.Decimal(12, 2)
  netAmount       Decimal @db.Decimal(12, 2)

  // Status
  status QuickPayStatus @default(REQUESTED)

  // Decision
  approvedBy      String?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Processing
  processedAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user    CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load    Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierPortalActivityLog {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Activity
  action      String  @db.VarChar(100)
  entityType  String? @db.VarChar(50)
  entityId    String?
  description String? @db.Text

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  carrier   Carrier?          @relation(fields: [carrierId], references: [id])
  carrierId String?

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model CarrierSavedLoad {
  id                  String  @id @default(cuid())
  tenantId            String
  carrierPortalUserId String
  loadId              String?
  postingId           String? // Reference to external load board posting

  // Saved details
  notes        String?   @db.Text
  reminderDate DateTime? @db.Date

  // Metadata
  savedFrom String? @db.VarChar(100) // INTERNAL_BOARD, DAT, TRUCKSTOP, etc.

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   CarrierPortalUser @relation(fields: [carrierPortalUserId], references: [id], onDelete: Cascade)
  load   Load?             @relation(fields: [loadId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierPortalUserId])
  @@index([loadId])
  @@index([reminderDate])
  @@index([externalId, sourceSystem])
}

enum CarrierPortalNotificationType {
  LOAD_ASSIGNED
  LOAD_CANCELLED
  DOCUMENT_REQUEST
  PAYMENT_PROCESSED
  INVOICE_APPROVED
  INVOICE_REJECTED
  QUICK_PAY_APPROVED
  QUICK_PAY_REJECTED
  GENERAL
}

model CarrierPortalNotification {
  id                  String @id @default(cuid())
  tenantId            String
  carrierPortalUserId String

  // Notification details
  notificationType CarrierPortalNotificationType
  title            String                        @db.VarChar(255)
  message          String                        @db.Text

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Action
  actionUrl String? @db.VarChar(500)

  // Related entity
  relatedEntityType String? @db.VarChar(50)
  relatedEntityId   String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   CarrierPortalUser @relation(fields: [carrierPortalUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierPortalUserId])
  @@index([isRead])
  @@index([notificationType])
  @@index([createdAt])
  @@index([relatedEntityType, relatedEntityId])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CONTRACTS (Service 14) - Core Models
// ==============================================

model Contract {
  id             String @id @default(cuid())
  tenantId       String
  contractNumber String @unique @db.VarChar(50)

  // Type
  contractType ContractType

  // Parties
  customerId String?
  carrierId  String?
  agentId    String?

  // Contract details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Dates
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Status
  status ContractStatus @default(DRAFT)

  // Auto-renewal
  autoRenew       Boolean @default(false)
  renewalTermDays Int?
  noticeDays      Int?

  // Documents
  documentId       String? @unique
  signedDocumentId String?

  // E-signature
  esignProvider   String?   @db.VarChar(50)
  esignEnvelopeId String?   @db.VarChar(255)
  signedAt        DateTime?
  signedBy        String?

  // Financial
  minimumRevenue Decimal? @db.Decimal(12, 2)
  maximumRevenue Decimal? @db.Decimal(12, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Company?             @relation("CustomerContracts", fields: [customerId], references: [id], onDelete: SetNull)
  carrier             Carrier?             @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  agent               Agent?               @relation(fields: [agentId], references: [id], onDelete: SetNull)
  fuelSurchargeTables FuelSurchargeTable[]
  slas                ContractSLA[]
  volumeCommitments   VolumeCommitment[]
  contractRateTables  ContractRateTable[]
  contractAmendments  ContractAmendment[]
  contractMetrics     ContractMetric[]

  @@index([tenantId])
  @@index([contractNumber])
  @@index([contractType])
  @@index([customerId])
  @@index([carrierId])
  @@index([status])
  @@index([effectiveDate])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model FuelSurchargeTable {
  id         String  @id @default(cuid())
  tenantId   String
  contractId String?

  // Table info
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Settings
  basePrice Decimal @db.Decimal(5, 3) // Base fuel price (e.g., $1.20/gallon)
  isDefault Boolean @default(false)

  // Dates
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract          Contract?           @relation(fields: [contractId], references: [id], onDelete: SetNull)
  tiers             FuelSurchargeTier[]
  contractRateLanes ContractRateLane[]

  @@index([tenantId])
  @@index([contractId])
  @@index([status])
  @@index([effectiveDate])
  @@index([externalId, sourceSystem])
}

model FuelSurchargeTier {
  id      String @id @default(cuid())
  tableId String

  // Tier definition
  tierNumber Int

  // Price range
  priceMin Decimal  @db.Decimal(5, 3)
  priceMax Decimal? @db.Decimal(5, 3)

  // Surcharge
  surchargePercent Decimal @db.Decimal(5, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  table FuelSurchargeTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, tierNumber])
  @@index([tableId])
  @@index([externalId, sourceSystem])
}

model ContractSLA {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // SLA type
  slaType SLAType

  // Target
  targetPercent Decimal @db.Decimal(5, 2)

  // Measurement period
  measurementPeriod String @db.VarChar(50) // MONTHLY, QUARTERLY, ANNUAL

  // Penalty
  penaltyAmount  Decimal? @db.Decimal(12, 2)
  penaltyPercent Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([slaType])
  @@index([externalId, sourceSystem])
}

model VolumeCommitment {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // Commitment details
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date

  // Targets
  minimumLoads   Int?
  minimumRevenue Decimal? @db.Decimal(14, 2)
  minimumWeight  Decimal? @db.Decimal(14, 2)

  // Actuals (tracked)
  actualLoads   Int     @default(0)
  actualRevenue Decimal @default(0) @db.Decimal(14, 2)
  actualWeight  Decimal @default(0) @db.Decimal(14, 2)

  // Shortfall handling
  shortfallFee     Decimal? @db.Decimal(12, 2)
  shortfallPercent Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, MET, SHORTFALL, WAIVED

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([periodStart])
  @@index([status])
  @@index([externalId, sourceSystem])
}

enum ContractClauseType {
  PAYMENT_TERMS
  LIABILITY
  INSURANCE
  TERMINATION
  DISPUTE_RESOLUTION
  CONFIDENTIALITY
  COMPLIANCE
  FORCE_MAJEURE
  CUSTOM
}

model ContractTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  templateName    String       @db.VarChar(255)
  contractType    ContractType
  templateContent String       @db.Text
  defaultTerms    String?      @db.Text

  // Status
  isActive Boolean @default(true)
  version  Int     @default(1)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model ContractClause {
  id       String @id @default(cuid())
  tenantId String

  // Clause details
  clauseName String             @db.VarChar(255)
  clauseText String             @db.Text
  clauseType ContractClauseType

  // Settings
  isRequired   Boolean @default(false)
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clauseType])
  @@index([isActive])
  @@index([displayOrder])
  @@index([externalId, sourceSystem])
}

model ContractRateTable {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // Table details
  tableName      String    @db.VarChar(255)
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract  Contract           @relation(fields: [contractId], references: [id], onDelete: Cascade)
  rateLanes ContractRateLane[]

  @@index([tenantId])
  @@index([contractId])
  @@index([effectiveDate])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model ContractRateLane {
  id          String @id @default(cuid())
  tenantId    String
  rateTableId String

  // Lane details
  originCity  String  @db.VarChar(100)
  originState String  @db.VarChar(2)
  originZip   String? @db.VarChar(10)
  destCity    String  @db.VarChar(100)
  destState   String  @db.VarChar(2)
  destZip     String? @db.VarChar(10)

  // Equipment
  equipmentType String @db.VarChar(50)

  // Rate
  rateType   RateType
  rateAmount Decimal  @db.Decimal(10, 2)
  currency   String   @default("USD") @db.VarChar(3)

  // Fuel surcharge
  fuelSurchargeTableId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rateTable          ContractRateTable   @relation(fields: [rateTableId], references: [id], onDelete: Cascade)
  fuelSurchargeTable FuelSurchargeTable? @relation(fields: [fuelSurchargeTableId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([rateTableId])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([externalId, sourceSystem])
}

model ContractAmendment {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // Amendment details
  amendmentNumber Int      @default(1)
  effectiveDate   DateTime @db.Date
  description     String   @db.Text

  // Changes
  changedFields  Json @default("[]") // Array of changed field names
  previousValues Json @default("{}") // Object with previous values
  newValues      Json @default("{}") // Object with new values

  // Approval
  changedBy  String?
  approvedBy String?
  approvedAt DateTime?

  // Document
  documentId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([contractId])
  @@index([effectiveDate])
  @@index([amendmentNumber])
  @@index([externalId, sourceSystem])
}

enum MetricType {
  ON_TIME_DELIVERY
  LOAD_VOLUME
  REVENUE
  COST_PER_MILE
  CLAIMS_RATIO
  CUSTOM
}

model ContractMetric {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // Metric details
  metricType MetricType
  metricName String?    @db.VarChar(255) // For custom metrics

  // Period
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date

  // Values
  targetValue Decimal  @db.Decimal(15, 2)
  actualValue Decimal? @db.Decimal(15, 2)
  unit        String?  @db.VarChar(50) // loads, dollars, percentage, etc.

  // Status
  isMet    Boolean?
  variance Decimal? @db.Decimal(15, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([metricType])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([externalId, sourceSystem])
}

// ==============================================
// AGENT (Service 15) - Core Models
// ==============================================

model Agent {
  id       String @id @default(cuid())
  tenantId String

  // Agent Reference
  agentCode String @db.VarChar(20)

  // Company Info
  companyName     String  @db.VarChar(200)
  dbaName         String? @db.VarChar(200)
  legalEntityType String? @db.VarChar(50)
  taxId           String? @db.VarChar(20)

  // Address
  addressLine1 String? @db.VarChar(200)
  addressLine2 String? @db.VarChar(200)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(50)
  zip          String? @db.VarChar(20)
  country      String  @default("USA") @db.VarChar(3)

  // Primary Contact
  contactFirstName String  @db.VarChar(100)
  contactLastName  String  @db.VarChar(100)
  contactEmail     String  @db.VarChar(255)
  contactPhone     String? @db.VarChar(20)

  // Agent Type
  agentType AgentType

  // Territory & Industry
  territories   Json @default("[]")
  industryFocus Json @default("[]")

  // Status
  status AgentStatus @default(PENDING)

  // Onboarding
  applicationDate       DateTime?
  backgroundCheckStatus String?   @db.VarChar(20)
  backgroundCheckDate   DateTime?
  trainingCompleted     Boolean   @default(false)
  trainingCompletedDate DateTime?

  // Activation
  activatedAt DateTime?
  activatedBy String?

  // Tier
  tier AgentTier @default(STANDARD)

  // Payment Info
  paymentMethod   String? @db.VarChar(20)
  bankName        String? @db.VarChar(100)
  bankRouting     String? @db.VarChar(20)
  bankAccount     String? @db.VarChar(50)
  bankAccountType String? @db.VarChar(20)

  // Termination
  terminatedAt      DateTime?
  terminatedBy      String?
  terminationReason String?   @db.Text

  // Migration / Custom
  externalId   String? @db.VarChar(100)
  sourceSystem String? @db.VarChar(50)
  customFields Json    @default("{}")

  // Audit
  createdById String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts            AgentContact[]
  agreements          AgentAgreement[]
  customerAssignments AgentCustomerAssignment[]
  leads               AgentLead[]
  commissions         AgentCommission[]
  payouts             AgentPayout[]
  drawBalances        AgentDrawBalance[]
  portalUsers         AgentPortalUser[]
  contracts           Contract[]

  @@unique([tenantId, agentCode])
  @@index([tenantId])
  @@index([status])
  @@index([agentType])
  @@index([contactEmail])
}

model AgentAgreement {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  agreementNumber String  @db.VarChar(30)
  name            String? @db.VarChar(200)

  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  splitType      CommissionSplitType
  splitRate      Decimal?            @db.Decimal(5, 4)
  minimumPerLoad Decimal?            @db.Decimal(10, 2)

  tiers Json @default("[]")

  protectionPeriodMonths Int @default(12)

  sunsetEnabled      Boolean @default(false)
  sunsetPeriodMonths Int?    @default(12)
  sunsetSchedule     Json    @default("[]")

  drawAmount      Decimal? @db.Decimal(10, 2)
  drawFrequency   String?  @db.VarChar(20)
  drawRecoverable Boolean  @default(true)

  paymentDay    Int     @default(15)
  minimumPayout Decimal @default(100) @db.Decimal(10, 2)

  status              AgreementStatus @default(ACTIVE)
  version             Int             @default(1)
  previousAgreementId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent             Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  previousAgreement AgentAgreement?  @relation("AgreementVersions", fields: [previousAgreementId], references: [id])
  nextAgreements    AgentAgreement[] @relation("AgreementVersions")

  @@index([agentId])
  @@index([status])
  @@index([effectiveDate])
}

model AgentCustomerAssignment {
  id         String @id @default(cuid())
  tenantId   String
  agentId    String
  customerId String

  assignmentType AssignmentType

  protectionStart DateTime
  protectionEnd   DateTime?
  isProtected     Boolean   @default(true)

  splitPercent Decimal? @db.Decimal(5, 4)

  leadId String?
  source String? @db.VarChar(50)

  overrideSplitRate Decimal? @db.Decimal(5, 4)
  overrideReason    String?  @db.Text

  inSunset          Boolean   @default(false)
  sunsetStartDate   DateTime?
  currentSunsetRate Decimal?  @db.Decimal(5, 4)

  status AssignmentStatus @default(ACTIVE)

  terminatedAt         DateTime?
  terminatedReason     String?   @db.Text
  transferredToAgentId String?

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent       Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  customer    Company           @relation("AgentCustomerAssignments", fields: [customerId], references: [id], onDelete: Cascade)
  lead        AgentLead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  commissions AgentCommission[]

  @@unique([agentId, customerId])
  @@index([customerId])
  @@index([status])
  @@index([tenantId])
  @@index([assignmentType])
}

model AgentCommission {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  customerId   String?
  orderId      String?
  loadId       String?
  invoiceId    String?
  assignmentId String?

  loadRevenue        Decimal? @db.Decimal(12, 2)
  loadMargin         Decimal? @db.Decimal(12, 2)
  salesRepCommission Decimal? @db.Decimal(10, 2)

  splitRate      Decimal             @db.Decimal(5, 4)
  splitType      CommissionSplitType
  commissionBase Decimal             @db.Decimal(12, 2)

  grossCommission Decimal @db.Decimal(10, 2)
  adjustments     Decimal @default(0) @db.Decimal(10, 2)
  netCommission   Decimal @db.Decimal(10, 2)

  status AgentCommissionStatus @default(CALCULATED)

  commissionPeriod String?   @db.VarChar(7)
  payoutId         String?
  paidAt           DateTime?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent      Agent                    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  customer   Company?                 @relation(fields: [customerId], references: [id], onDelete: SetNull)
  order      Order?                   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  load       Load?                    @relation(fields: [loadId], references: [id], onDelete: SetNull)
  invoice    Invoice?                 @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  assignment AgentCustomerAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  payout     AgentPayout?             @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([agentId])
  @@index([customerId])
  @@index([orderId])
  @@index([loadId])
  @@index([invoiceId])
  @@index([status])
  @@index([commissionPeriod])
}

model AgentContact {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  email     String? @db.VarChar(255)
  phone     String? @db.VarChar(20)
  mobile    String? @db.VarChar(20)

  role      String? @db.VarChar(50)
  isPrimary Boolean @default(false)

  hasPortalAccess Boolean @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent       Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  portalUsers AgentPortalUser[] @relation("AgentContactPortalUsers")

  @@index([tenantId])
  @@index([agentId])
  @@index([isPrimary])
}

model AgentLead {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  leadNumber String @db.VarChar(20)

  companyName             String   @db.VarChar(200)
  website                 String?  @db.VarChar(255)
  industry                String?  @db.VarChar(100)
  estimatedMonthlyVolume  Int?
  estimatedMonthlyRevenue Decimal? @db.Decimal(12, 2)

  contactFirstName String  @db.VarChar(100)
  contactLastName  String  @db.VarChar(100)
  contactTitle     String? @db.VarChar(100)
  contactEmail     String? @db.VarChar(255)
  contactPhone     String? @db.VarChar(20)

  city  String? @db.VarChar(100)
  state String? @db.VarChar(50)

  leadSource String? @db.VarChar(50)
  notes      String? @db.Text

  primaryLanes   Json @default("[]")
  equipmentNeeds Json @default("[]")

  status LeadStatus @default(SUBMITTED)

  qualifiedBy     String?
  qualifiedAt     DateTime?
  rejectionReason String?

  convertedAt         DateTime?
  convertedCustomerId String?
  conversionDeadline  DateTime?

  assignedTo String?
  assignedAt DateTime?

  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent               Agent                     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  customer            Company?                  @relation(fields: [convertedCustomerId], references: [id], onDelete: SetNull)
  customerAssignments AgentCustomerAssignment[]

  @@unique([tenantId, leadNumber])
  @@index([agentId])
  @@index([status])
  @@index([conversionDeadline])
}

enum PaymentMethod {
  ACH
  CHECK
  WIRE
  CREDIT_CARD
}

model AgentPayout {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  payoutNumber String   @db.VarChar(30)
  periodStart  DateTime @db.Date
  periodEnd    DateTime @db.Date

  grossCommissions Decimal @db.Decimal(12, 2)
  adjustments      Decimal @default(0) @db.Decimal(10, 2)
  drawRecovery     Decimal @default(0) @db.Decimal(10, 2)
  netAmount        Decimal @db.Decimal(12, 2)

  status AgentPayoutStatus @default(PENDING)

  approvedBy String?
  approvedAt DateTime?

  paymentMethod    PaymentMethod?
  paymentReference String?        @db.VarChar(100)
  paymentDate      DateTime?      @db.Date

  statementDocumentId String?

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent             Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  statementDocument Document?         @relation("AgentPayoutStatementDocument", fields: [statementDocumentId], references: [id], onDelete: SetNull)
  commissions       AgentCommission[]

  @@index([tenantId])
  @@index([agentId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model AgentDrawBalance {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  period String @db.VarChar(7)

  drawAmount        Decimal   @db.Decimal(10, 2)
  drawPaidAt        DateTime?
  commissionsEarned Decimal   @default(0) @db.Decimal(10, 2)
  shortfall         Decimal   @default(0) @db.Decimal(10, 2)
  carryoverBalance  Decimal   @default(0) @db.Decimal(10, 2)
  amountRecovered   Decimal   @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent  Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([agentId])
  @@index([period])
}

model AgentPortalUser {
  id             String  @id @default(cuid())
  tenantId       String
  agentId        String
  agentContactId String?
  userId         String?

  email        String @db.VarChar(255)
  passwordHash String @db.VarChar(255)
  firstName    String @db.VarChar(100)
  lastName     String @db.VarChar(100)

  role   String @default("USER") @db.VarChar(20)
  status String @default("ACTIVE") @db.VarChar(20)

  lastLoginAt       DateTime?
  passwordChangedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent   Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  contact AgentContact? @relation("AgentContactPortalUsers", fields: [agentContactId], references: [id], onDelete: SetNull)
  user    User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([agentId])
  @@index([userId])
}

// ==============================================
// FACTORING (Service 16) - Core Models
// ==============================================

model FactoringCompany {
  id       String @id @default(cuid())
  tenantId String

  // Company details
  companyCode String @unique @db.VarChar(50)
  name        String @db.VarChar(255)

  // Contact
  email   String? @db.VarChar(255)
  phone   String? @db.VarChar(20)
  fax     String? @db.VarChar(20)
  address String? @db.Text

  // Settings
  verificationMethod String  @db.VarChar(50) // PHONE, EMAIL, FAX, API
  apiEndpoint        String? @db.VarChar(500)
  apiKey             String? @db.VarChar(255)

  // Timing
  verificationSLAHours Int @default(24)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  noaRecords       NOARecord[]
  carrierStatuses  CarrierFactoringStatus[]
  factoredPayments FactoredPayment[]

  @@index([tenantId])
  @@index([companyCode])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model NOARecord {
  id                 String @id @default(cuid())
  tenantId           String
  carrierId          String
  factoringCompanyId String

  // NOA details
  noaNumber   String  @unique @db.VarChar(50)
  noaDocument String? @db.VarChar(500) // Document path

  // Dates
  receivedDate   DateTime  @db.Date
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Verification
  verifiedBy     String?
  verifiedAt     DateTime?
  verifiedMethod String?   @db.VarChar(50)

  // Status
  status NOAStatus @default(PENDING)

  // Release
  releasedBy    String?
  releasedAt    DateTime?
  releaseReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier                Carrier                 @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  factoringCompany       FactoringCompany        @relation(fields: [factoringCompanyId], references: [id], onDelete: Cascade)
  factoringVerifications FactoringVerification[]

  @@index([tenantId])
  @@index([carrierId])
  @@index([factoringCompanyId])
  @@index([noaNumber])
  @@index([status])
  @@index([effectiveDate])
  @@index([externalId, sourceSystem])
}

model CarrierFactoringStatus {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String @unique

  // Current status
  factoringStatus    FactoringStatus @default(NONE)
  factoringCompanyId String?

  // Active NOA
  activeNoaId String?

  // Quick pay
  quickPayEnabled    Boolean  @default(false)
  quickPayFeePercent Decimal? @db.Decimal(5, 2)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier          Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  factoringCompany FactoringCompany? @relation(fields: [factoringCompanyId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([factoringCompanyId])
  @@index([factoringStatus])
  @@index([externalId, sourceSystem])
}

enum VerificationMethod {
  PHONE_CALL
  EMAIL
  FAX
  ONLINE_PORTAL
  MAIL
}

model FactoringVerification {
  id          String @id @default(cuid())
  tenantId    String
  noaRecordId String

  // Verification details
  verificationDate   DateTime           @db.Date
  verificationMethod VerificationMethod
  contactedPerson    String?            @db.VarChar(255)
  verificationStatus VerificationStatus

  // Documentation
  verificationDocumentId String?
  notes                  String? @db.Text

  // Next verification
  nextVerificationDate DateTime? @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  noaRecord            NOARecord @relation(fields: [noaRecordId], references: [id], onDelete: Cascade)
  verificationDocument Document? @relation(fields: [verificationDocumentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([noaRecordId])
  @@index([verificationDate])
  @@index([verificationStatus])
  @@index([nextVerificationDate])
  @@index([externalId, sourceSystem])
}

model FactoredPayment {
  id                 String @id @default(cuid())
  tenantId           String
  settlementId       String
  factoringCompanyId String

  // Payment details
  paymentAmount    Decimal       @db.Decimal(12, 2)
  paymentDate      DateTime      @db.Date
  paymentMethod    PaymentMethod
  verificationCode String?       @db.VarChar(100)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settlement       Settlement       @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  factoringCompany FactoringCompany @relation(fields: [factoringCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([settlementId])
  @@index([factoringCompanyId])
  @@index([paymentDate])
  @@index([externalId, sourceSystem])
}

// ==============================================
// HR (Service 17) - Core Models
// ==============================================

model Employee {
  id       String  @id @default(cuid())
  tenantId String
  userId   String? @unique

  // Employee details
  employeeNumber String  @unique @db.VarChar(50)
  firstName      String  @db.VarChar(100)
  lastName       String  @db.VarChar(100)
  email          String  @db.VarChar(255)
  phone          String? @db.VarChar(20)

  // Employment
  employmentType   EmploymentType
  employmentStatus EmploymentStatus @default(ACTIVE)
  departmentId     String?
  positionId       String?
  managerId        String?

  // Dates
  hireDate        DateTime  @db.Date
  terminationDate DateTime? @db.Date

  // Compensation
  annualSalary Decimal? @db.Decimal(12, 2)
  hourlyRate   Decimal? @db.Decimal(10, 2)

  // PTO
  ptoBalance  Decimal @default(0) @db.Decimal(6, 2)
  sickBalance Decimal @default(0) @db.Decimal(6, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  department          Department?         @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  position            Position?           @relation(fields: [positionId], references: [id], onDelete: SetNull)
  manager             Employee?           @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports       Employee[]          @relation("EmployeeManager")
  timeOffRequests     TimeOffRequest[]
  location            Location?           @relation(fields: [locationId], references: [id])
  locationId          String?
  employmentHistories EmploymentHistory[]
  timeOffBalances     TimeOffBalance[]
  timeEntries         TimeEntry[]
  onboardingTasks     OnboardingTask[]

  @@unique([tenantId, employeeNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([departmentId])
  @@index([managerId])
  @@index([employmentStatus])
  @@index([externalId, sourceSystem])
}

model Department {
  id       String @id @default(cuid())
  tenantId String

  // Department details
  code        String  @unique @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentDepartmentId String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentDepartment    Department?         @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id], onDelete: SetNull)
  childDepartments    Department[]        @relation("DepartmentHierarchy")
  employees           Employee[]
  employmentHistories EmploymentHistory[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentDepartmentId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Position {
  id       String @id @default(cuid())
  tenantId String

  // Position details
  code        String  @unique @db.VarChar(50)
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Compensation
  minSalary Decimal? @db.Decimal(12, 2)
  maxSalary Decimal? @db.Decimal(12, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees            Employee[]
  employmentHistories  EmploymentHistory[]
  onboardingChecklists OnboardingChecklist[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model TimeOffRequest {
  id         String @id @default(cuid())
  tenantId   String
  employeeId String

  // Request details
  requestType TimeOffType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  totalDays   Decimal     @db.Decimal(5, 2)

  // Reason
  reason String? @db.Text

  // Status
  status TimeOffRequestStatus @default(PENDING)

  // Approval
  approvedBy   String?
  approvedAt   DateTime?
  deniedBy     String?
  deniedAt     DateTime?
  denialReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([externalId, sourceSystem])
}

model Location {
  id       String @id @default(cuid())
  tenantId String

  // Location details
  locationCode String @unique @db.VarChar(50)
  name         String @db.VarChar(255)

  // Address
  address String? @db.VarChar(255)
  city    String? @db.VarChar(100)
  state   String? @db.VarChar(2)
  zip     String? @db.VarChar(10)
  country String? @default("US") @db.VarChar(2)

  // Contact
  phone String? @db.VarChar(20)

  // Settings
  isHeadquarters Boolean @default(false)
  timezone       String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees     Employee[]
  timeEntries   TimeEntry[]
  businessHours BusinessHours[]

  @@index([tenantId])
  @@index([tenantId, city, state])
  @@index([tenantId, zip])
  @@index([tenantId, deletedAt])
  @@index([locationCode])
  @@index([isHeadquarters])
  @@index([externalId, sourceSystem])
}

enum ChangeReason {
  PROMOTION
  TRANSFER
  SALARY_ADJUSTMENT
  DEMOTION
  DEPARTMENT_RESTRUCTURE
  OTHER
}

model EmploymentHistory {
  id         String @id @default(cuid())
  tenantId   String
  employeeId String

  // Position details
  positionId   String
  departmentId String
  startDate    DateTime  @db.Date
  endDate      DateTime? @db.Date

  // Change tracking
  changeReason ChangeReason?
  salaryAtTime Decimal?      @db.Decimal(12, 2)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  position   Position   @relation(fields: [positionId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@index([positionId])
  @@index([departmentId])
  @@index([startDate])
  @@index([endDate])
  @@index([externalId, sourceSystem])
}

model TimeOffBalance {
  id         String @id @default(cuid())
  tenantId   String
  employeeId String

  // Balance details
  timeOffType  TimeOffType
  year         Int
  balanceHours Decimal     @db.Decimal(8, 2)
  accrualRate  Decimal?    @db.Decimal(8, 2) // Hours per month
  maxBalance   Decimal?    @db.Decimal(8, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, timeOffType, year])
  @@index([tenantId])
  @@index([employeeId])
  @@index([year])
  @@index([externalId, sourceSystem])
}

model TimeEntry {
  id         String  @id @default(cuid())
  tenantId   String
  employeeId String
  locationId String?

  // Time details
  clockIn       DateTime  @db.Timestamp()
  clockOut      DateTime? @db.Timestamp()
  durationHours Decimal?  @db.Decimal(8, 2)

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([employeeId])
  @@index([locationId])
  @@index([clockIn])
  @@index([externalId, sourceSystem])
}

model OnboardingChecklist {
  id         String  @id @default(cuid())
  tenantId   String
  positionId String?

  // Checklist details
  checklistName String  @db.VarChar(255)
  description   String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  position Position?        @relation(fields: [positionId], references: [id], onDelete: SetNull)
  tasks    OnboardingTask[]

  @@index([tenantId])
  @@index([positionId])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model OnboardingTask {
  id          String  @id @default(cuid())
  tenantId    String
  checklistId String
  employeeId  String?

  // Task details
  taskName    String  @db.VarChar(255)
  description String? @db.Text

  // Timing
  dueDaysFromStart Int       @default(7)
  dueDate          DateTime? @db.Date
  completedDate    DateTime? @db.Date

  // Assignment
  assignedTo String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  checklist OnboardingChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  employee  Employee?           @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([checklistId])
  @@index([employeeId])
  @@index([dueDate])
  @@index([completedDate])
  @@index([externalId, sourceSystem])
}

// ==============================================
// ANALYTICS (Service 18) - Core Models
// ==============================================

model KPIDefinition {
  id       String @id @default(cuid())
  tenantId String

  // KPI details
  code        String      @unique @db.VarChar(100)
  name        String      @db.VarChar(255)
  description String?     @db.Text
  category    KPICategory

  // Calculation
  aggregationType AggregationType
  sourceQuery     String          @db.Text

  // Display
  unit   String? @db.VarChar(50)
  format String? @db.VarChar(50)

  // Thresholds
  targetValue   Decimal? @db.Decimal(14, 4)
  warningValue  Decimal? @db.Decimal(14, 4)
  criticalValue Decimal? @db.Decimal(14, 4)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  kpisnapshots     KPISnapshot[]
  dashboardWidgets DashboardWidget[]
  kpialerts        KPIAlert[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Dashboard {
  id       String @id @default(cuid())
  tenantId String

  // Dashboard details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Access
  isPublic Boolean @default(false)
  ownerId  String?

  // Layout
  layout Json @default("{}")

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dashboardWidgets DashboardWidget[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Report {
  id       String @id @default(cuid())
  tenantId String

  // Report details
  name        String     @db.VarChar(255)
  description String?    @db.Text
  reportType  ReportType

  // Query
  sourceQuery String @db.Text
  parameters  Json   @default("[]")

  // Output
  outputFormat OutputFormat @default(PDF)

  // Schedule
  isScheduled        Boolean @default(false)
  scheduleExpression String? @db.VarChar(255)

  // Access
  isPublic Boolean @default(false)
  ownerId  String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reportExecutions ReportExecution[]

  @@index([tenantId])
  @@index([reportType])
  @@index([ownerId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

enum TrendDirection {
  UP
  DOWN
  FLAT
}

model KPISnapshot {
  id              String @id @default(cuid())
  tenantId        String
  kpiDefinitionId String

  // Snapshot data
  snapshotDate    DateTime        @db.Date
  value           Decimal         @db.Decimal(15, 2)
  comparisonValue Decimal?        @db.Decimal(15, 2) // Previous period value
  trendDirection  TrendDirection?

  // Metadata
  metadata Json @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  kpiDefinition KPIDefinition @relation(fields: [kpiDefinitionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([kpiDefinitionId])
  @@index([snapshotDate])
  @@index([externalId, sourceSystem])
}

model DashboardWidget {
  id              String  @id @default(cuid())
  tenantId        String
  dashboardId     String
  kpiDefinitionId String?

  // Widget settings
  widgetType String  @db.VarChar(50) // CHART, TABLE, METRIC, GAUGE, LIST
  title      String? @db.VarChar(255)

  // Layout
  position Int @default(0)
  width    Int @default(12)
  height   Int @default(4)

  // Configuration
  configuration   Json @default("{}")
  refreshInterval Int? // Seconds

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dashboard     Dashboard      @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  kpiDefinition KPIDefinition? @relation(fields: [kpiDefinitionId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([dashboardId])
  @@index([kpiDefinitionId])
  @@index([position])
  @@index([externalId, sourceSystem])
}

model ReportTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  templateName String  @db.VarChar(255)
  reportType   String  @db.VarChar(100)
  description  String? @db.Text

  // Query
  queryTemplate String @db.Text

  // Parameters
  parameterDefinitions Json @default("[]")

  // Schedule
  scheduleConfig Json? @default("{}")

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions ReportExecution[]

  @@index([tenantId])
  @@index([reportType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model ReportExecution {
  id         String  @id @default(cuid())
  tenantId   String
  reportId   String?
  templateId String?

  // Execution details
  executedAt     DateTime        @default(now())
  parametersUsed Json            @default("{}")
  status         ExecutionStatus @default(PENDING)

  // Output
  outputFileUrl   String? @db.VarChar(500)
  executionTimeMs Int?
  rowCount        Int?

  // Error
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  report   Report?         @relation(fields: [reportId], references: [id], onDelete: SetNull)
  template ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([reportId])
  @@index([templateId])
  @@index([executedAt])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model SavedAnalyticsView {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // View details
  viewName   String @db.VarChar(255)
  entityType String @db.VarChar(100) // LOAD, ORDER, INVOICE, etc.

  // Configuration
  filters   Json @default("[]")
  columns   Json @default("[]")
  sortOrder Json @default("[]")

  // Sharing
  isPublic Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType])
  @@index([isPublic])
  @@index([externalId, sourceSystem])
}

model KPIAlert {
  id              String @id @default(cuid())
  tenantId        String
  kpiDefinitionId String

  // Alert config
  alertName      String         @db.VarChar(255)
  alertCondition AlertCondition
  thresholdValue Decimal        @db.Decimal(15, 2)

  // Notification
  notifyUsers Json @default("[]") // Array of user IDs

  // Status
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  kpiDefinition KPIDefinition @relation(fields: [kpiDefinitionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([kpiDefinitionId])
  @@index([isActive])
  @@index([lastTriggeredAt])
  @@index([externalId, sourceSystem])
}

model AnalyticsCache {
  id       String @id @default(cuid())
  tenantId String

  // Cache key
  cacheKey  String @unique @db.VarChar(255)
  queryHash String @db.VarChar(64)

  // Cached data
  resultData Json @default("{}")

  // Cache management
  createdAt DateTime @default(now())
  expiresAt DateTime
  hitCount  Int      @default(0)

  // Audit
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([queryHash])
  @@index([expiresAt])
  @@index([hitCount])
}

// ==============================================
// WORKFLOW (Service 19) - Core Models
// ==============================================

model Workflow {
  id       String @id @default(cuid())
  tenantId String

  // Workflow details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Trigger
  triggerType       TriggerType
  triggerEvent      String?     @db.VarChar(100)
  triggerConditions Json        @default("{}")

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Version
  version Int @default(1)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions            WorkflowExecution[]
  workflowSteps         WorkflowStep[]
  scheduledWorkflowRuns ScheduledWorkflowRun[]

  @@index([tenantId])
  @@index([triggerType])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WorkflowExecution {
  id         String @id @default(cuid())
  tenantId   String
  workflowId String

  // Execution details
  triggerData Json

  // Status
  status WorkflowExecutionStatus @default(PENDING)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Result
  result       Json?
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow       Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepExecutions StepExecution[]

  @@index([tenantId])
  @@index([workflowId])
  @@index([status])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ApprovalRequest {
  id       String @id @default(cuid())
  tenantId String

  // Request details
  requestNumber String  @db.VarChar(50)
  title         String  @db.VarChar(255)
  description   String? @db.Text

  // Type
  approvalType ApprovalType

  // Entity
  entityType String @db.VarChar(50)
  entityId   String

  // Approvers
  approverIds String[] // Array of user IDs

  // Status
  status String @default("PENDING") @db.VarChar(50)

  // Timing
  dueDate DateTime? @db.Date

  // Decision
  decidedBy String?
  decidedAt DateTime?
  decision  String?   @db.VarChar(50) // APPROVED, REJECTED
  comments  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, requestNumber])
  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([externalId, sourceSystem])
}

model WorkflowStep {
  id         String @id @default(cuid())
  tenantId   String
  workflowId String

  // Step details
  stepNumber Int
  stepName   String   @db.VarChar(255)
  stepType   StepType

  // Action configuration
  actionConfig Json @default("{}")

  // Logic
  conditionLogic String? @db.Text

  // Timing
  timeoutSeconds Int?  @default(3600)
  retryConfig    Json? @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow   Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executions StepExecution[]

  @@unique([workflowId, stepNumber])
  @@index([tenantId])
  @@index([workflowId])
  @@index([stepType])
  @@index([externalId, sourceSystem])
}

model StepExecution {
  id                  String @id @default(cuid())
  tenantId            String
  workflowExecutionId String
  workflowStepId      String

  // Execution details
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  status      ExecutionStatus @default(PENDING)

  // Data
  inputData  Json  @default("{}")
  outputData Json? @default("{}")

  // Error
  errorMessage String? @db.Text
  retryCount   Int     @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflowExecution WorkflowExecution @relation(fields: [workflowExecutionId], references: [id], onDelete: Cascade)
  workflowStep      WorkflowStep      @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowExecutionId])
  @@index([workflowStepId])
  @@index([status])
  @@index([startedAt])
  @@index([externalId, sourceSystem])
}

model WorkflowTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  templateName String  @db.VarChar(255)
  category     String? @db.VarChar(100)
  description  String? @db.Text

  // Configuration
  triggerConfig Json @default("{}")
  stepsJson     Json @default("[]")

  // Status
  isSystem Boolean @default(false)
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
  @@index([isSystem])
  @@index([externalId, sourceSystem])
}

model ScheduledWorkflowRun {
  id         String @id @default(cuid())
  tenantId   String
  workflowId String

  // Schedule
  scheduleExpression String    @db.VarChar(255) // Cron expression
  lastRunAt          DateTime?
  nextRunAt          DateTime? @db.Timestamp()

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([nextRunAt])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

// ==============================================
// INTEGRATION HUB (Service 20) - Core Models
// ==============================================

model Integration {
  id       String @id @default(cuid())
  tenantId String

  // Integration details
  name        String              @db.VarChar(255)
  description String?             @db.Text
  category    IntegrationCategory
  provider    String              @db.VarChar(100)

  // Authentication
  authType    AuthType
  apiKey      String?  @db.VarChar(500)
  apiSecret   String?  @db.VarChar(500)
  oauthTokens Json?

  // Configuration
  config Json @default("{}")

  // Sync settings
  syncFrequency SyncFrequency
  lastSyncAt    DateTime?
  nextSyncAt    DateTime?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  webhookDeliveries         WebhookDelivery[]
  apirequestLogs            APIRequestLog[]
  syncJobs                  SyncJob[]
  circuitBreakerStateRecord CircuitBreakerStateRecord?

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@index([tenantId, deletedAt])
  @@index([category])
  @@index([provider])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WebhookEndpoint {
  id       String @id @default(cuid())
  tenantId String

  // Endpoint details
  name        String  @db.VarChar(255)
  url         String  @db.VarChar(500)
  description String? @db.Text

  // Events
  events String[] // Array of event types

  // Security
  secret String? @db.VarChar(255)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries           WebhookDelivery[]
  webhookSubscriptions WebhookSubscription[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deletedAt])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WebhookDelivery {
  id            String  @id @default(cuid())
  tenantId      String
  endpointId    String?
  integrationId String?

  // Event
  event   String @db.VarChar(100)
  payload Json

  // Delivery
  requestHeaders  Json?
  requestBody     Json?
  responseStatus  Int?
  responseHeaders Json?
  responseBody    String? @db.Text

  // Status
  status WebhookStatus @default(PENDING)

  // Retry
  attempts    Int       @default(0)
  lastAttempt DateTime?
  nextRetry   DateTime?

  // Error
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  endpoint    WebhookEndpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)
  integration Integration?     @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([endpointId])
  @@index([integrationId])
  @@index([status])
  @@index([event])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model IntegrationProviderConfig {
  id       String @id @default(cuid())
  tenantId String

  // Provider details
  providerName     String  @db.VarChar(255)
  category         String  @db.VarChar(100) // CRM, ACCOUNTING, COMMUNICATION, LOAD_BOARD, etc.
  authType         String  @db.VarChar(50) // OAUTH2, API_KEY, BASIC, JWT
  baseUrl          String? @db.VarChar(500)
  documentationUrl String? @db.VarChar(500)
  logoUrl          String? @db.VarChar(500)

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model WebhookSubscription {
  id                String @id @default(cuid())
  tenantId          String
  webhookEndpointId String

  // Subscription details
  eventType        String @db.VarChar(100)
  filterConditions Json   @default("{}")

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  endpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([webhookEndpointId])
  @@index([eventType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model APIRequestLog {
  id            String @id @default(cuid())
  tenantId      String
  integrationId String

  // Request details
  endpoint       String @db.VarChar(500)
  method         String @db.VarChar(10) // GET, POST, PUT, PATCH, DELETE
  requestHeaders Json   @default("{}")
  requestBody    Json?  @default("{}")

  // Response
  responseStatus Int
  responseBody   Json? @default("{}")
  durationMs     Int

  // Timestamp
  timestamp DateTime @default(now())

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([integrationId])
  @@index([timestamp])
  @@index([endpoint])
}

model TransformationTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  templateName String @db.VarChar(255)
  sourceFormat String @db.VarChar(100)
  targetFormat String @db.VarChar(100)

  // Transformation
  transformationLogic String @db.Text // JSONata, jq, or custom script
  testCases           Json   @default("[]")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sourceFormat])
  @@index([targetFormat])
  @@index([externalId, sourceSystem])
}

enum SyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

model SyncJob {
  id            String @id @default(cuid())
  tenantId      String
  integrationId String

  // Job details
  jobType   String        @db.VarChar(100)
  direction SyncDirection
  schedule  String?       @db.VarChar(255) // Cron expression

  // Status
  lastSyncAt       DateTime?
  recordsProcessed Int?            @default(0)
  recordsFailed    Int?            @default(0)
  status           ExecutionStatus @default(PENDING)

  // Error
  lastError String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([integrationId])
  @@index([lastSyncAt])
  @@index([status])
  @@index([externalId, sourceSystem])
}

enum CircuitState {
  CLOSED
  OPEN
  HALF_OPEN
}

model CircuitBreakerStateRecord {
  id            String @id @default(cuid())
  tenantId      String
  integrationId String @unique

  // State
  state            CircuitState @default(CLOSED)
  failureCount     Int          @default(0)
  lastFailureAt    DateTime?
  nextRetryAt      DateTime?
  halfOpenAttempts Int          @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([nextRetryAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// SEARCH (Service 21) - Core Models
// ==============================================

model SavedSearch {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Search details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Entity
  entityType SearchEntityType

  // Query
  query   Json
  filters Json @default("{}")

  // Settings
  isPublic Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType])
  @@index([externalId, sourceSystem])
}

model SearchHistory {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Search details
  entityType SearchEntityType
  searchTerm String           @db.VarChar(500)

  // Result
  resultCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType])
  @@index([searchTerm])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model SearchIndex {
  id       String @id @default(cuid())
  tenantId String

  // Index details
  entityType    String @db.VarChar(100)
  indexName     String @db.VarChar(255)
  fieldsIndexed Json   @default("[]") // Array of field names

  // Status
  lastUpdated   DateTime @default(now())
  documentCount Int      @default(0)
  status        String   @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, entityType])
  @@index([tenantId])
  @@index([entityType])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model SearchSuggestion {
  id       String @id @default(cuid())
  tenantId String

  // Suggestion details
  entityType     String   @db.VarChar(100)
  suggestionText String   @db.VarChar(255)
  frequency      Int      @default(1)
  lastUsed       DateTime @default(now())

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType])
  @@index([suggestionText])
  @@index([frequency])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model SearchSynonym {
  id       String @id @default(cuid())
  tenantId String

  // Synonym details
  term          String  @db.VarChar(255)
  synonymsArray Json    @default("[]") // Array of synonyms
  entityType    String? @db.VarChar(100)

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([term])
  @@index([entityType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

enum IndexOperation {
  CREATE
  UPDATE
  DELETE
  REINDEX
}

model SearchIndexQueue {
  id       String @id @default(cuid())
  tenantId String

  // Queue item details
  entityType String         @db.VarChar(100)
  entityId   String         @db.VarChar(255)
  operation  IndexOperation
  priority   Int            @default(5) // 1-10, higher = more urgent

  // Processing
  processedAt DateTime?
  retryCount  Int       @default(0)
  lastError   String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([operation])
  @@index([priority])
  @@index([processedAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// AUDIT (Service 22) - Core Models
// ==============================================

model AuditLog {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?

  // Action
  action   AuditAction
  category AuditActionCategory
  severity AuditSeverity       @default(INFO)

  // Entity
  entityType String? @db.VarChar(50)
  entityId   String?

  // Details
  description String? @db.Text
  metadata    Json    @default("{}")

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, action])
  @@index([tenantId, entityType])
  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ChangeHistory {
  id       String  @id @default(cuid())
  tenantId String
  userId   String?

  // Entity
  entityType String @db.VarChar(50)
  entityId   String

  // Change
  field    String  @db.VarChar(100)
  oldValue String? @db.Text
  newValue String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([field])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

enum LoginMethod {
  PASSWORD
  SSO
  OAUTH
  MFA
  API_KEY
}

model AccessLog {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?

  // Access details
  resourceType String @db.VarChar(50)
  resourceId   String @db.VarChar(255)
  action       String @db.VarChar(100)

  // Decision
  granted      Boolean
  denialReason String? @db.Text

  // Context
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text
  timestamp DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  @@index([granted])
}

model LoginAudit {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?

  // Login details
  email         String      @db.VarChar(255)
  loginMethod   LoginMethod
  success       Boolean
  failureReason String?     @db.Text

  // Context
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text
  mfaUsed   Boolean  @default(false)
  sessionId String?  @db.VarChar(255)
  timestamp DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([email])
  @@index([timestamp])
  @@index([success])
}

model APIAuditLog {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?
  apiKeyId String?

  // API call details
  endpoint       String @db.VarChar(500)
  method         String @db.VarChar(10)
  requestParams  Json?  @default("{}")
  responseStatus Int
  responseTimeMs Int

  // Context
  ipAddress String?  @db.VarChar(45)
  timestamp DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([apiKeyId])
  @@index([endpoint])
  @@index([timestamp])
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PENDING_VERIFICATION
  EXPIRED
}

model ComplianceCheckpoint {
  id       String @id @default(cuid())
  tenantId String

  // Checkpoint details
  checkpointName String @db.VarChar(255)
  entityType     String @db.VarChar(50)
  entityId       String @db.VarChar(255)
  requirement    String @db.Text

  // Verification
  status     ComplianceStatus @default(PENDING_VERIFICATION)
  verifiedBy String?
  verifiedAt DateTime?
  expiryDate DateTime?        @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([expiryDate])
  @@index([externalId, sourceSystem])
}

enum AuditSeverityLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model AuditAlert {
  id       String @id @default(cuid())
  tenantId String

  // Alert details
  alertName         String             @db.VarChar(255)
  triggerConditions Json               @default("{}")
  severity          AuditSeverityLevel

  // Notification
  notifyUsers Json @default("[]")

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  incidents AuditAlertIncident[]

  @@index([tenantId])
  @@index([severity])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model AuditAlertIncident {
  id           String @id @default(cuid())
  tenantId     String
  auditAlertId String

  // Incident details
  triggeredAt DateTime           @default(now())
  triggerData Json               @default("{}")
  severity    AuditSeverityLevel

  // Resolution
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  notes          String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditAlert AuditAlert @relation(fields: [auditAlertId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([auditAlertId])
  @@index([triggeredAt])
  @@index([severity])
  @@index([resolvedAt])
  @@index([externalId, sourceSystem])
}

model AuditRetentionPolicy {
  id       String @id @default(cuid())
  tenantId String

  // Policy details
  entityType       String @db.VarChar(100)
  retentionDays    Int
  archiveAfterDays Int?
  deleteAfterDays  Int?

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, entityType])
  @@index([tenantId])
  @@index([entityType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CONFIG (Service 23) - Core Models
// ==============================================

model SystemConfig {
  id String @id @default(cuid())

  // Config details
  category ConfigCategory
  key      String         @unique @db.VarChar(100)
  value    Json

  // Metadata
  description String? @db.Text
  dataType    String  @db.VarChar(50) // STRING, NUMBER, BOOLEAN, JSON

  // Validation
  validationRules Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  @@index([category])
  @@index([key])
  @@index([externalId, sourceSystem])
}

model FeatureFlag {
  id String @id @default(cuid())

  // Flag details
  key         String            @unique @db.VarChar(100)
  name        String            @db.VarChar(255)
  description String?           @db.Text
  status      FeatureFlagStatus @default(ACTIVE)

  // Rollout
  enabled        Boolean @default(false)
  rolloutPercent Int     @default(0)

  // Targeting
  tenantIds String[] // Array of tenant IDs
  userIds   String[] // Array of user IDs

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  createdById          String?
  updatedById          String?
  featureFlagOverrides FeatureFlagOverride[]

  @@index([key])
  @@index([status])
  @@index([enabled])
  @@index([externalId, sourceSystem])
}

enum DataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DATE
}

model TenantConfig {
  id       String @id @default(cuid())
  tenantId String

  // Config details
  configKey   String   @db.VarChar(255)
  configValue Json
  dataType    DataType @default(STRING)
  isEncrypted Boolean  @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, configKey])
  @@index([tenantId])
  @@index([configKey])
  @@index([externalId, sourceSystem])
}

model UserPreference {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Preference details
  preferenceKey   String   @db.VarChar(255)
  preferenceValue Json
  dataType        DataType @default(STRING)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, preferenceKey])
  @@index([tenantId])
  @@index([userId])
  @@index([preferenceKey])
  @@index([externalId, sourceSystem])
}

model FeatureFlagOverride {
  id            String  @id @default(cuid())
  featureFlagId String
  tenantId      String?
  userId        String?

  // Override
  overrideValue Boolean
  expiresAt     DateTime? @db.Timestamp()

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  tenant      Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([featureFlagId])
  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([externalId, sourceSystem])
}

model ConfigTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  templateName  String  @db.VarChar(255)
  templateType  String  @db.VarChar(100)
  configSchema  Json    @default("{}")
  defaultValues Json    @default("{}")
  isSystem      Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([templateType])
  @@index([isSystem])
  @@index([externalId, sourceSystem])
}

model ConfigHistory {
  id       String @id @default(cuid())
  tenantId String

  // Change details
  configKey    String   @db.VarChar(255)
  oldValue     Json?
  newValue     Json
  changedBy    String?
  changeReason String?  @db.Text
  changedAt    DateTime @default(now())

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([configKey])
  @@index([changedAt])
  @@index([changedBy])
  @@index([externalId, sourceSystem])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model BusinessHours {
  id         String  @id @default(cuid())
  tenantId   String
  locationId String?

  // Business hours
  dayOfWeek DayOfWeek
  openTime  String    @db.VarChar(5) // HH:MM format
  closeTime String    @db.VarChar(5)
  isClosed  Boolean   @default(false)
  timezone  String    @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([locationId])
  @@index([dayOfWeek])
  @@index([externalId, sourceSystem])
}

model Holiday {
  id       String @id @default(cuid())
  tenantId String

  // Holiday details
  holidayName String   @db.VarChar(255)
  holidayDate DateTime @db.Date
  isRecurring Boolean  @default(false)
  countryCode String?  @db.VarChar(2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([holidayDate])
  @@index([countryCode])
  @@index([externalId, sourceSystem])
}

enum ResetFrequency {
  NEVER
  DAILY
  MONTHLY
  YEARLY
}

model NumberSequence {
  id       String @id @default(cuid())
  tenantId String

  // Sequence details
  sequenceName   String         @db.VarChar(255)
  prefix         String?        @db.VarChar(20)
  currentNumber  Int            @default(1)
  increment      Int            @default(1)
  padding        Int            @default(4) // Zero-padding length
  resetFrequency ResetFrequency @default(NEVER)
  lastResetAt    DateTime?      @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sequenceName])
  @@index([tenantId])
  @@index([sequenceName])
  @@index([externalId, sourceSystem])
}

// ==============================================
// SCHEDULER (Service 24) - Core Models
// ==============================================

model ScheduledJob {
  id       String  @id @default(cuid())
  tenantId String?

  // Identifiers
  code String? @db.VarChar(100)

  // Job details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Type
  jobType      JobType
  scheduleType ScheduleType

  // Handler
  handler   String  @default("noop") @db.VarChar(255)
  parameters Json   @default("{}")

  // Schedule
  cronExpression  String?   @db.VarChar(255)
  intervalSeconds Int?
  runAt           DateTime?
  timezone        String    @default("UTC") @db.VarChar(100)

  // Settings
  timeoutSeconds    Int  @default(300)
  maxRetries        Int  @default(3)
  retryDelaySeconds Int  @default(60)
  priority          Int  @default(5)
  queue             String @default("default") @db.VarChar(100)
  allowConcurrent   Boolean @default(false)
  maxInstances      Int     @default(1)

  // Status
  status     String  @default("ACTIVE") @db.VarChar(50)
  isEnabled  Boolean @default(true)
  lastRunAt  DateTime?
  lastRunStatus     String? @db.VarChar(50)
  lastRunDurationMs Int?
  nextRunAt         DateTime?
  runCount          Int @default(0)
  failureCount      Int @default(0)

  // Legacy compatibility
  handlerName     String?  @db.VarChar(255)
  intervalMinutes Int?
  scheduledAt     DateTime?
  timeoutMinutes  Int?
  retryAttempts   Int?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant?         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions   JobExecution[]
  dependencies JobDependency[] @relation("JobDependencies")
  dependents   JobDependency[] @relation("DependentJobs")
  alerts       JobAlert[]
  lock         JobLock?

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([jobType])
  @@index([status])
  @@index([nextRunAt])
  @@index([queue, priority])
  @@index([externalId, sourceSystem])
}

model JobExecution {
  id       String @id @default(cuid())
  jobId    String
  tenantId String?

  // Ordering
  executionNumber Int @default(1)
  attemptNumber   Int @default(1)

  // Timing
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  durationMs  Int?

  // Worker
  workerId       String? @db.VarChar(100)
  workerHostname String? @db.VarChar(255)

  // Payload
  parameters Json?

  // Status
  status      JobExecutionStatus @default(PENDING)
  result      Json?
  errorMessage String? @db.Text

  // Progress
  progressPercent Int @default(0)
  progressMessage String?

  // Retry
  retryOf   String?
  willRetry Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  job ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
  @@index([status, scheduledAt])
  @@index([tenantId, createdAt])
  @@index([retryOf])
  @@index([externalId, sourceSystem])
}

model JobDependency {
  id             String @id @default(cuid())
  jobId          String
  dependsOnJobId String

  dependencyType String @default("SUCCESS") @db.VarChar(20)

  createdAt DateTime @default(now())

  job         ScheduledJob @relation("JobDependencies", fields: [jobId], references: [id], onDelete: Cascade)
  dependsOnJob ScheduledJob @relation("DependentJobs", fields: [dependsOnJobId], references: [id], onDelete: Cascade)

  @@unique([jobId, dependsOnJobId])
}

model JobLock {
  id       String @id @default(cuid())
  jobId    String @unique
  tenantId String?

  workerId   String @db.VarChar(100)
  lockedAt   DateTime
  expiresAt  DateTime
  lastHeartbeat DateTime?

  job ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
}

model JobTemplate {
  id                String @id @default(cuid())
  code              String @unique @db.VarChar(100)
  name              String
  description       String? @db.Text
  category          String? @db.VarChar(100)
  handler           String
  defaultSchedule   String?
  defaultParameters Json              @default("{}")
  isSystemRequired  Boolean           @default(false)
  isTenantConfigurable Boolean        @default(true)
  createdAt         DateTime          @default(now())
}

model JobAlert {
  id       String @id @default(cuid())
  jobId    String

  alertType         String @db.VarChar(50)
  thresholdValue    Int?
  notificationChannels Json
  recipients        Json
  isEnabled         Boolean @default(true)

  createdAt DateTime @default(now())

  job ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

model ScheduledTask {
  id       String @id @default(cuid())
  tenantId String

  // Task details
  taskType    String   @db.VarChar(100)
  referenceType String? @db.VarChar(50)
  referenceId   String? @db.VarChar(255)

  // Schedule
  scheduledAt DateTime @db.Timestamp()
  timezone    String   @default("UTC") @db.VarChar(100)

  // Payload
  payload Json @default("{}")
  handler String @db.VarChar(255)

  // Settings
  priority       Int  @default(5)
  timeoutSeconds Int  @default(60)

  // Status
  status      TaskStatus @default(PENDING)
  processedAt DateTime?
  errorMessage String? @db.Text
  completedAt DateTime?

  // Legacy compatibility
  taskName     String?   @db.VarChar(255)
  entityType   String?   @db.VarChar(50)
  entityId     String?   @db.VarChar(255)
  scheduledFor DateTime? @db.Timestamp()
  taskData     Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([taskType])
  @@index([scheduledAt, status])
  @@index([referenceType, referenceId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Reminder {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Reminder details
  title       String   @db.VarChar(255)
  description String?  @db.Text
  remindAt    DateTime @db.Timestamp()
  timezone    String?  @db.VarChar(100)

  // References
  referenceType String? @db.VarChar(50)
  referenceId   String? @db.VarChar(255)
  referenceUrl  String? @db.VarChar(500)

  // Recurrence
  isRecurring       Boolean  @default(false)
  recurrenceRule    String?  @db.VarChar(255)
  recurrenceEndDate DateTime?

  // Notifications
  notificationChannels Json @default("[\"in_app\"]")

  // Status
  status        ReminderStatus @default(PENDING)
  snoozedUntil  DateTime?      @db.Timestamp()
  snoozeCount   Int            @default(0)
  sentAt        DateTime?
  dismissedAt   DateTime?
  completedAt   DateTime?

  // Legacy compatibility
  reminderType String?  @db.VarChar(100)
  message      String?  @db.Text
  entityType   String?  @db.VarChar(50)
  entityId     String?  @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([remindAt])
  @@index([status])
  @@index([referenceType, referenceId])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CACHE (Service 25) - Core Models
// ==============================================

model CacheConfig {
  id       String @id @default(cuid())
  tenantId String

  // Cache details
  cacheType CacheType
  key       String    @db.VarChar(255)

  // Settings
  ttlSeconds Int @default(3600)

  // Tags
  tags String[] // For group invalidation

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, cacheType, key])
  @@index([tenantId])
  @@index([cacheType])
  @@index([externalId, sourceSystem])
}

model CacheStats {
  id       String  @id @default(cuid())
  tenantId String?

  // Period
  statDate DateTime @db.Date
  statHour Int // 0-23

  // Metrics
  cacheType   String @db.VarChar(50)
  hits        Int    @default(0)
  misses      Int    @default(0)
  sets        Int    @default(0)
  deletes     Int    @default(0)
  expirations Int    @default(0)

  // Size
  keysCount   Int?
  memoryBytes BigInt?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, statDate, statHour, cacheType])
  @@index([tenantId])
  @@index([statDate, statHour])
  @@index([externalId, sourceSystem])
}

model CacheInvalidationRule {
  id       String @id @default(cuid())
  tenantId String

  // Trigger
  triggerEvent String @db.VarChar(100) // order.updated, carrier.approved

  // Cache to invalidate
  cachePattern     String @db.VarChar(200) // Pattern with wildcards
  invalidationType String @db.VarChar(20) // DELETE, REFRESH

  // Status
  isEnabled Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([triggerEvent])
  @@index([isEnabled])
  @@index([externalId, sourceSystem])
}

model DistributedLock {
  id       String  @id @default(cuid())
  tenantId String?

  // Lock details
  lockKey  String @db.VarChar(200)
  holderId String @db.VarChar(100)

  // Timing
  acquiredAt DateTime
  expiresAt  DateTime
  releasedAt DateTime?

  // Context
  purpose String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([lockKey, acquiredAt])
  @@index([externalId, sourceSystem])
}

model RateLimit {
  id       String  @id @default(cuid())
  tenantId String?

  // Rate limit details
  scope      RateLimitScope
  identifier String         @db.VarChar(255) // user_id, tenant_id, ip, etc

  // Limits
  maxRequests   Int
  windowSeconds Int

  // Current usage
  currentRequests Int      @default(0)
  windowStartsAt  DateTime @default(now())

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([scope, identifier])
  @@index([tenantId])
  @@index([scope])
  @@index([identifier])
  @@index([windowStartsAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// HELP DESK (Service 26) - Core Models
// ==============================================

model SupportTicket {
  id       String @id @default(cuid())
  tenantId String

  // Ticket details
  ticketNumber String         @unique @db.VarChar(50)
  subject      String         @db.VarChar(500)
  description  String         @db.Text
  source       TicketSource
  type         TicketType
  priority     TicketPriority @default(NORMAL)
  status       TicketStatus   @default(NEW)

  // Requester
  requesterId    String?
  requesterName  String? @db.VarChar(255)
  requesterEmail String? @db.VarChar(255)

  // Assignment
  assignedToId String?
  teamId       String?

  // SLA
  firstResponseDue DateTime?
  resolutionDue    DateTime?
  firstRespondedAt DateTime?

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?   @db.Text

  // Satisfaction
  satisfactionRating  Int?
  satisfactionComment String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replies TicketReply[]

  @@index([tenantId])
  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model TicketReply {
  id       String @id @default(cuid())
  tenantId String
  ticketId String

  // Reply details
  replyType ReplyType
  body      String    @db.Text
  bodyHtml  String?   @db.Text

  // Author
  authorId   String?
  authorName String? @db.VarChar(255)

  // Attachments
  attachments Json? // [{name, url, size}]

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ticketId])
  @@index([replyType])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model KBArticle {
  id       String @id @default(cuid())
  tenantId String

  // Article details
  title   String  @db.VarChar(500)
  content String  @db.Text
  summary String? @db.VarChar(1000)

  // Category
  categoryId String?

  // SEO
  slug     String  @db.VarChar(500)
  keywords String? @db.Text

  // Visibility
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  // Stats
  viewCount      Int @default(0)
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isPublished])
  @@index([externalId, sourceSystem])
}

model SupportTeam {
  id       String @id @default(cuid())
  tenantId String

  // Team details
  name        String  @db.VarChar(100)
  description String? @db.Text
  email       String? @db.VarChar(255) // Team email address

  // Settings
  autoAssign       Boolean @default(false) // Auto-assign to team members
  assignmentMethod String  @default("ROUND_ROBIN") @db.VarChar(20) // ROUND_ROBIN, LOAD_BALANCED

  // Manager
  managerId String?

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members SupportTeamMember[]

  @@index([tenantId])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model SupportTeamMember {
  id     String @id @default(cuid())
  teamId String
  userId String

  // Role
  role String @default("MEMBER") @db.VarChar(20) // LEAD, MEMBER

  // Capacity
  maxOpenTickets     Int @default(20)
  currentTicketCount Int @default(0)

  // Status
  isAvailable Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  team SupportTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([isAvailable])
  @@index([externalId, sourceSystem])
}

model SlaPolicy {
  id       String @id @default(cuid())
  tenantId String

  // Policy details
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Conditions (when to apply)
  conditions Json // {priority: ['URGENT'], category: ['TECHNICAL']}

  // Targets (in minutes)
  firstResponseTarget Int // Time to first response
  resolutionTarget    Int // Time to resolution

  // Business hours
  useBusinessHours Boolean @default(true)

  // Priority
  priority Int @default(0) // Higher = check first

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@index([priority])
  @@index([externalId, sourceSystem])
}

model EscalationRule {
  id       String @id @default(cuid())
  tenantId String

  // Rule details
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Trigger
  triggerType    String @db.VarChar(30) // SLA_BREACH, NO_RESPONSE, CUSTOMER_REPLY
  triggerMinutes Int? // Minutes after trigger

  // Conditions
  conditions Json? // {priority: ['URGENT']}

  // Actions
  actionType   String @db.VarChar(30) // NOTIFY, REASSIGN, CHANGE_PRIORITY
  actionConfig Json // {notify_users: [], reassign_to: 'team_id'}

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@index([triggerType])
  @@index([externalId, sourceSystem])
}

model CannedResponse {
  id       String @id @default(cuid())
  tenantId String

  // Template details
  title    String  @db.VarChar(200)
  content  String  @db.Text
  category String? @db.VarChar(100)

  // Usage
  useCount Int @default(0)

  // Visibility
  isPublic Boolean @default(false) // Available to all agents
  ownerId  String? // Creator, can be NULL for public templates

  // Status
  isActive Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@index([category])
  @@index([ownerId])
  @@index([externalId, sourceSystem])
}

// ==============================================
// FEEDBACK (Service 27) - Core Models
// ==============================================

model NPSSurvey {
  id       String @id @default(cuid())
  tenantId String

  // Survey details
  surveyNumber     String  @unique @db.VarChar(50)
  question         String  @db.Text
  followUpQuestion String? @db.Text

  // Target
  targetType String @db.VarChar(50) // ALL, CUSTOMERS, CARRIERS

  // Schedule
  scheduledAt DateTime? @db.Date
  expiresAt   DateTime? @db.Date

  // Status
  status String @default("DRAFT") @db.VarChar(50)

  // Stats
  responseCount Int  @default(0)
  npsScore      Int?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  responses NPSResponse[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
  @@index([externalId, sourceSystem])
}

model NPSResponse {
  id       String @id @default(cuid())
  tenantId String
  surveyId String

  // Respondent
  respondentType  String? @db.VarChar(50)
  respondentId    String?
  respondentEmail String? @db.VarChar(255)

  // Response
  score    Int
  category NPSCategory
  feedback String?     @db.Text

  // Follow-up
  followUpResponse String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  survey NPSSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([surveyId])
  @@index([category])
  @@index([score])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model FeatureRequest {
  id       String @id @default(cuid())
  tenantId String

  // Request details
  title       String @db.VarChar(500)
  description String @db.Text

  // Submitter
  submitterId    String?
  submitterName  String? @db.VarChar(255)
  submitterEmail String? @db.VarChar(255)

  // Status
  status FeatureRequestStatus @default(SUBMITTED)

  // Priority
  voteCount Int @default(0)

  // Implementation
  implementedAt DateTime?
  releaseNotes  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  votes    FeatureRequestVote[]
  comments FeatureRequestComment[]

  @@index([tenantId])
  @@index([status])
  @@index([voteCount])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model FeatureRequestVote {
  id        String @id @default(cuid())
  requestId String

  // Voter
  userId     String?
  voterEmail String? @db.VarChar(255)

  // Vote (could extend to weighted voting)
  voteWeight Int @default(1)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  request FeatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, userId])
  @@index([requestId])
  @@index([userId])
  @@index([externalId, sourceSystem])
}

model FeatureRequestComment {
  id        String @id @default(cuid())
  requestId String

  // Author
  authorType   String  @db.VarChar(20) // USER, ADMIN
  authorUserId String?
  authorName   String  @db.VarChar(200)

  // Content
  content    String  @db.Text
  isOfficial Boolean @default(false) // Official response

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  request FeatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([authorUserId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model Survey {
  id       String @id @default(cuid())
  tenantId String

  // Survey details
  title       String  @db.VarChar(300)
  description String? @db.Text

  // Configuration
  surveyType String @db.VarChar(30) // CSAT, CUSTOM, EXIT, ONBOARDING
  questions  Json // Array of question objects

  // Settings
  anonymous           Boolean @default(false)
  requireAllQuestions Boolean @default(false)
  showProgress        Boolean @default(true)
  thankYouMessage     String? @db.Text
  redirectUrl         String? @db.VarChar(500)

  // Targeting
  triggerEvent  String? @db.VarChar(100)
  targetSegment Json?

  // Status
  status String @default("DRAFT") @db.VarChar(20)

  // Timing
  startDate DateTime?
  endDate   DateTime?

  // Metrics
  sentCount     Int @default(0)
  responseCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  responses SurveyResponse[]

  @@index([tenantId])
  @@index([status])
  @@index([surveyType])
  @@index([externalId, sourceSystem])
}

model SurveyResponse {
  id       String @id @default(cuid())
  surveyId String
  tenantId String

  // Respondent
  userId          String?
  respondentEmail String? @db.VarChar(255)

  // Responses
  answers Json // {question_id: answer}

  // Completion
  completionPercentage  Int  @default(100)
  timeToCompleteSeconds Int?

  // Context
  responseChannel String? @db.VarChar(30)
  userAgent       String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([surveyId])
  @@index([userId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model FeedbackWidget {
  id       String @id @default(cuid())
  tenantId String

  // Widget details
  name        String  @db.VarChar(200)
  description String? @db.Text

  // Placement
  placement String @db.VarChar(50) // BOTTOM_RIGHT, MODAL, INLINE
  pages     Json? // Array of page patterns

  // Configuration
  widgetType   String @db.VarChar(30) // RATING, TEXT, EMOJI
  config       Json // Widget-specific config
  triggerRules Json? // Conditions to show widget

  // Status
  isActive Boolean @default(true)

  // Metrics
  impressionCount Int @default(0)
  responseCount   Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CREDIT SERVICE (Service 16) - Enums
// ==============================================

enum CreditApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  CONDITIONAL_APPROVAL
  DENIED
  EXPIRED
}

enum CreditLimitStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  EXCEEDED
}

enum CreditHoldReason {
  PAYMENT_OVERDUE
  CREDIT_LIMIT_EXCEEDED
  FRAUD_SUSPECTED
  INSUFFICIENT_INSURANCE
  CARRIER_OOS
  MANUAL_HOLD
}

enum CollectionActivityType {
  CALL
  EMAIL
  LETTER
  LEGAL_NOTICE
  COLLECTIONS_AGENCY
}

enum PaymentPlanStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

// ==============================================
// CLAIMS SERVICE (Service 09) - Enums
// ==============================================

enum ClaimType {
  CARGO_DAMAGE
  CARGO_LOSS
  SHORTAGE
  LATE_DELIVERY
  OVERCHARGE
  OTHER
}

enum ClaimStatus {
  DRAFT
  SUBMITTED
  UNDER_INVESTIGATION
  PENDING_DOCUMENTATION
  APPROVED
  DENIED
  SETTLED
  CLOSED
}

enum ClaimDisposition {
  CARRIER_LIABILITY
  SHIPPER_LIABILITY
  RECEIVER_LIABILITY
  SHARED_LIABILITY
  NO_LIABILITY
}

enum SubrogationStatus {
  PENDING
  IN_PROGRESS
  RECOVERED
  UNRECOVERABLE
  CLOSED
}

// ==============================================
// EDI SERVICE (Service 28) - Enums
// ==============================================

enum EdiTransactionType {
  EDI_204 // Load Tender
  EDI_214 // Shipment Status
  EDI_210 // Freight Invoice
  EDI_211 // Bill of Lading
  EDI_990 // Load Tender Response
  EDI_997 // Functional Acknowledgment
  EDI_315 // Status Details
  EDI_322 // Terminal Operations
}

enum EdiDirection {
  INBOUND
  OUTBOUND
}

enum EdiMessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  ACKNOWLEDGED
  ERROR
  REJECTED
}

enum EdiCommunicationProtocol {
  FTP
  SFTP
  FTPS
  AS2
  HTTPS
  VAN
}

enum EdiValidationStatus {
  VALID
  WARNING
  ERROR
}

// ==============================================
// SAFETY SERVICE (Service 29) - Enums
// ==============================================

enum SaferDataStatus {
  ACTIVE
  INACTIVE
  OUT_OF_SERVICE
}

enum CSABasicType {
  UNSAFE_DRIVING
  HOS_COMPLIANCE
  DRIVER_FITNESS
  CONTROLLED_SUBSTANCES
  VEHICLE_MAINTENANCE
  HAZMAT_COMPLIANCE
  CRASH_INDICATOR
}

enum InsuranceType {
  AUTO_LIABILITY
  CARGO
  GENERAL_LIABILITY
  WORKERS_COMP
  UMBRELLA
  BOND
}

enum DQFDocumentType {
  APPLICATION
  MVR
  PSP
  MEDICAL_CARD
  DRUG_TEST
  ROAD_TEST
  CLEARINGHOUSE
  EMPLOYMENT_VERIFICATION
}

enum SafetyIncidentType {
  ACCIDENT
  CITATION
  INSPECTION_VIOLATION
  DOT_AUDIT_FINDING
  INSURANCE_CLAIM
}

enum SafetyAlertType {
  INSURANCE_EXPIRING
  AUTHORITY_EXPIRING
  CSA_THRESHOLD_EXCEEDED
  OUT_OF_SERVICE
  VIOLATION_PATTERN
}

// ==============================================
// RATE INTELLIGENCE SERVICE (Service 35) - Enums
// ==============================================

enum RateProvider {
  DAT
  TRUCKSTOP
  INTERNAL
}

enum AlertCondition {
  RATE_INCREASE
  RATE_DECREASE
  RATE_THRESHOLD
}

// ==============================================
// LOAD BOARD EXTERNAL SERVICE (Service 32) - Enums
// ==============================================

enum LoadBoardProviderType {
  DAT
  TRUCKSTOP
  SYLECTUS
  TRUCKER_TOOLS
  LOAD_BOARD
}

enum LoadPostStatus {
  DRAFT
  POSTED
  RESPONDED
  COVERED
  EXPIRED
  CANCELLED
}

enum PostLeadStatus {
  NEW
  CONTACTED
  QUOTED
  ACCEPTED
  DECLINED
}

enum PostingFrequency {
  IMMEDIATE
  HOURLY
  DAILY
  MANUAL
}

// ==============================================
// CREDIT SERVICE (Service 16) - Models
// ==============================================

model CreditApplication {
  id         String  @id @default(cuid())
  tenantId   String
  companyId  String
  customerId String?

  // Application info
  applicationNumber String                  @unique @db.VarChar(50)
  status            CreditApplicationStatus @default(PENDING)
  requestedLimit    Decimal                 @db.Decimal(12, 2)
  approvedLimit     Decimal?                @db.Decimal(12, 2)

  // Business info
  businessName    String   @db.VarChar(255)
  dbaName         String?  @db.VarChar(255)
  federalTaxId    String?  @db.VarChar(20)
  dunsNumber      String?  @db.VarChar(20)
  yearsInBusiness Int?
  businessType    String?  @db.VarChar(100)
  annualRevenue   Decimal? @db.Decimal(15, 2)

  // References
  bankName          String? @db.VarChar(255)
  bankAccountNumber String? @db.VarChar(100)
  bankContactName   String? @db.VarChar(255)
  bankContactPhone  String? @db.VarChar(20)

  // Trade references (JSON array)
  tradeReferences Json?

  // Ownership
  ownerName    String? @db.VarChar(255)
  ownerSSN     String? @db.VarChar(20)
  ownerAddress String? @db.Text

  // Credit check
  creditScore     Int?
  creditCheckDate DateTime?
  creditReportUrl String?   @db.VarChar(500)

  // Decision
  reviewedById String?
  reviewedAt   DateTime?
  denialReason String?   @db.Text
  conditions   String?   @db.Text

  // Dates
  approvedAt DateTime?
  expiresAt  DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([applicationNumber])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model CreditLimit {
  id         String  @id @default(cuid())
  tenantId   String
  companyId  String
  customerId String?

  // Limit details
  creditLimit     Decimal           @db.Decimal(12, 2)
  availableCredit Decimal           @db.Decimal(12, 2)
  usedCredit      Decimal           @default(0) @db.Decimal(12, 2)
  status          CreditLimitStatus @default(ACTIVE)

  // Payment terms
  paymentTerms    String? @db.VarChar(100) // NET_30, NET_60, etc.
  gracePeriodDays Int     @default(0)

  // Limits
  singleLoadLimit Decimal? @db.Decimal(12, 2)
  monthlyLimit    Decimal? @db.Decimal(12, 2)

  // Review
  lastReviewDate      DateTime?
  nextReviewDate      DateTime?
  reviewFrequencyDays Int       @default(90)

  // Approval
  approvedById String?
  approvedAt   DateTime?
  expiresAt    DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([tenantId, companyId])
  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CreditHold {
  id         String  @id @default(cuid())
  tenantId   String
  companyId  String
  customerId String?

  // Hold details
  reason      CreditHoldReason
  description String?          @db.Text
  amountHeld  Decimal?         @db.Decimal(12, 2)

  // Status
  isActive Boolean @default(true)

  // Resolution
  resolvedById    String?
  resolvedAt      DateTime?
  resolutionNotes String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([reason])
  @@index([isActive])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model CollectionActivity {
  id         String  @id @default(cuid())
  tenantId   String
  companyId  String
  customerId String?
  invoiceId  String?

  // Activity details
  activityType CollectionActivityType
  subject      String?                @db.VarChar(500)
  description  String?                @db.Text
  outcome      String?                @db.Text

  // Contact info
  contactedName  String? @db.VarChar(255)
  contactedTitle String? @db.VarChar(100)
  contactedPhone String? @db.VarChar(20)
  contactedEmail String? @db.VarChar(255)

  // Follow-up
  followUpDate  DateTime?
  followUpNotes String?   @db.Text

  // Results
  promisedPaymentDate DateTime?
  promisedAmount      Decimal?  @db.Decimal(12, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([companyId])
  @@index([invoiceId])
  @@index([activityType])
  @@index([followUpDate])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model PaymentPlan {
  id         String  @id @default(cuid())
  tenantId   String
  companyId  String
  customerId String?

  // Plan details
  planNumber        String            @unique @db.VarChar(50)
  totalAmount       Decimal           @db.Decimal(12, 2)
  amountPaid        Decimal           @default(0) @db.Decimal(12, 2)
  remainingBalance  Decimal           @db.Decimal(12, 2)
  installmentAmount Decimal           @db.Decimal(12, 2)
  installmentCount  Int
  installmentsPaid  Int               @default(0)
  status            PaymentPlanStatus @default(ACTIVE)

  // Schedule
  firstPaymentDate DateTime  @db.Date
  frequency        String    @db.VarChar(50) // WEEKLY, BIWEEKLY, MONTHLY
  nextPaymentDate  DateTime? @db.Date

  // Terms
  interestRate Decimal? @db.Decimal(5, 2)
  lateFeePct   Decimal? @db.Decimal(5, 2)
  lateFeeFixed Decimal? @db.Decimal(10, 2)

  // Invoices included (JSON array of invoice IDs)
  invoiceIds Json?

  // Approval
  approvedById String?
  approvedAt   DateTime?

  // Completion
  completedAt        DateTime?
  defaultedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([planNumber])
  @@index([nextPaymentDate])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CLAIMS SERVICE (Service 09) - Models
// ==============================================

model Claim {
  id        String  @id @default(cuid())
  tenantId  String
  loadId    String?
  orderId   String?
  carrierId String?
  companyId String?

  // Claim info
  claimNumber String            @unique @db.VarChar(50)
  claimType   ClaimType
  status      ClaimStatus       @default(DRAFT)
  disposition ClaimDisposition?

  // Amounts
  claimedAmount  Decimal  @db.Decimal(12, 2)
  approvedAmount Decimal? @db.Decimal(12, 2)
  paidAmount     Decimal  @default(0) @db.Decimal(12, 2)

  // Incident details
  incidentDate     DateTime @db.Date
  incidentLocation String?  @db.VarChar(500)
  description      String   @db.Text

  // Claimant
  claimantName    String  @db.VarChar(255)
  claimantCompany String? @db.VarChar(255)
  claimantEmail   String? @db.VarChar(255)
  claimantPhone   String? @db.VarChar(20)

  // Dates
  filedDate    DateTime  @default(now()) @db.Date
  receivedDate DateTime? @db.Date
  dueDate      DateTime? @db.Date
  closedDate   DateTime? @db.Date

  // Assignment
  assignedToId String?

  // Investigation
  investigationNotes String? @db.Text
  rootCause          String? @db.Text
  preventionNotes    String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load               Load?               @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order              Order?              @relation(fields: [orderId], references: [id], onDelete: SetNull)
  carrier            Carrier?            @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  company            Company?            @relation(fields: [companyId], references: [id], onDelete: SetNull)
  items              ClaimItem[]
  documents          ClaimDocument[]
  notes              ClaimNote[]
  timeline           ClaimTimeline[]
  adjustments        ClaimAdjustment[]
  subrogationRecords SubrogationRecord[]
  contacts           ClaimContact[]

  @@index([tenantId])
  @@index([loadId])
  @@index([orderId])
  @@index([carrierId])
  @@index([companyId])
  @@index([claimNumber])
  @@index([status])
  @@index([claimType])
  @@index([incidentDate])
  @@index([externalId, sourceSystem])
}

model ClaimItem {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Item details
  description String  @db.VarChar(500)
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  totalValue  Decimal @db.Decimal(12, 2)

  // Damage
  damageType   String? @db.VarChar(100)
  damageExtent String? @db.VarChar(100)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([externalId, sourceSystem])
}

model ClaimDocument {
  id         String @id @default(cuid())
  tenantId   String
  claimId    String
  documentId String

  // Document classification
  documentType String  @db.VarChar(100) // PROOF_OF_DELIVERY, INVOICE, PHOTOS, POLICE_REPORT, etc.
  description  String? @db.VarChar(500)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim    Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([documentId])
  @@index([externalId, sourceSystem])
}

model ClaimNote {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Note details
  note       String  @db.Text
  noteType   String? @db.VarChar(50) // INTERNAL, EXTERNAL, INVESTIGATION
  isInternal Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ClaimTimeline {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Event details
  eventType   String  @db.VarChar(100) // STATUS_CHANGE, DOCUMENT_ADDED, NOTE_ADDED, PAYMENT_MADE, etc.
  eventData   Json?
  description String? @db.VarChar(500)
  oldValue    String? @db.VarChar(500)
  newValue    String? @db.VarChar(500)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([eventType])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ClaimAdjustment {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Adjustment details
  adjustmentType String  @db.VarChar(100) // DEDUCTIBLE, DEPRECIATION, SALVAGE, OTHER
  amount         Decimal @db.Decimal(12, 2)
  reason         String  @db.Text

  // Approval
  approvedById String?
  approvedAt   DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([adjustmentType])
  @@index([externalId, sourceSystem])
}

model SubrogationRecord {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Subrogation details
  targetParty     String            @db.VarChar(255)
  targetPartyType String            @db.VarChar(100) // CARRIER, SHIPPER, RECEIVER, THIRD_PARTY
  amountSought    Decimal           @db.Decimal(12, 2)
  amountRecovered Decimal           @default(0) @db.Decimal(12, 2)
  status          SubrogationStatus @default(PENDING)

  // Legal
  attorneyName String?   @db.VarChar(255)
  attorneyFirm String?   @db.VarChar(255)
  caseNumber   String?   @db.VarChar(100)
  filingDate   DateTime? @db.Date

  // Resolution
  settlementDate   DateTime? @db.Date
  settlementAmount Decimal?  @db.Decimal(12, 2)
  closedDate       DateTime? @db.Date
  closureReason    String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([status])
  @@index([targetPartyType])
  @@index([externalId, sourceSystem])
}

model ClaimContact {
  id       String @id @default(cuid())
  tenantId String
  claimId  String

  // Contact details
  contactType String  @db.VarChar(100) // CLAIMANT, WITNESS, INSURANCE_ADJUSTER, ATTORNEY, etc.
  name        String  @db.VarChar(255)
  company     String? @db.VarChar(255)
  title       String? @db.VarChar(100)
  email       String? @db.VarChar(255)
  phone       String? @db.VarChar(20)
  address     String? @db.Text
  notes       String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  claim  Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([claimId])
  @@index([contactType])
  @@index([externalId, sourceSystem])
}

// ==============================================
// EDI SERVICE (Service 28) - Models
// ==============================================

model EdiTradingPartner {
  id       String @id @default(cuid())
  tenantId String

  // Partner info
  partnerName String  @db.VarChar(255)
  partnerType String  @db.VarChar(50) // CUSTOMER, CARRIER, BROKER, 3PL
  isActive    Boolean @default(true)

  // EDI identifiers
  isaId String  @unique @db.VarChar(15) // ISA sender/receiver ID
  gsId  String? @db.VarChar(15) // GS application sender/receiver ID
  duns  String? @db.VarChar(9)
  scac  String? @db.VarChar(4)

  // Communication
  protocol        EdiCommunicationProtocol
  ftpHost         String?                  @db.VarChar(255)
  ftpPort         Int?
  ftpUsername     String?                  @db.VarChar(100)
  ftpPassword     String?                  @db.VarChar(500) // encrypted
  ftpInboundPath  String?                  @db.VarChar(500)
  ftpOutboundPath String?                  @db.VarChar(500)
  as2Url          String?                  @db.VarChar(500)
  as2Identifier   String?                  @db.VarChar(255)
  vanMailbox      String?                  @db.VarChar(100)

  // Settings
  sendFunctionalAck    Boolean @default(true)
  requireFunctionalAck Boolean @default(true)
  testMode             Boolean @default(false)

  // Mappings (JSON for custom field mappings)
  fieldMappings Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages            EdiMessage[]
  transactionMappings EdiTransactionMapping[]
  communicationLogs   EdiCommunicationLog[]

  @@index([tenantId])
  @@index([isaId])
  @@index([partnerType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model EdiMessage {
  id               String @id @default(cuid())
  tenantId         String
  tradingPartnerId String

  // Message identification
  messageId       String             @unique @db.VarChar(100)
  transactionType EdiTransactionType
  direction       EdiDirection
  status          EdiMessageStatus   @default(PENDING)

  // Control numbers
  isaControlNumber String @db.VarChar(9)
  gsControlNumber  String @db.VarChar(9)
  stControlNumber  String @db.VarChar(9)

  // Related entity
  entityType String? @db.VarChar(50) // LOAD, ORDER, INVOICE, etc.
  entityId   String?

  // Content
  rawContent    String @db.Text // Original EDI content
  parsedContent Json? // Parsed JSON structure

  // Processing
  processedAt      DateTime?
  validationStatus EdiValidationStatus?
  validationErrors Json?
  retryCount       Int                  @default(0)
  lastRetryAt      DateTime?

  // Acknowledgment
  functionalAckId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tradingPartner  EdiTradingPartner   @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)
  batches         EdiBatchMessage[]
  acknowledgments EdiAcknowledgment[]
  errors          EdiError[]

  @@index([tenantId])
  @@index([tradingPartnerId])
  @@index([transactionType])
  @@index([direction])
  @@index([status])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model EdiTransactionMapping {
  id               String @id @default(cuid())
  tenantId         String
  tradingPartnerId String

  // Transaction type
  transactionType EdiTransactionType

  // Mapping configuration (JSON)
  fieldMappings  Json // Maps EDI segment/element to internal field
  defaultValues  Json?
  transformRules Json?

  // Validation rules
  validationRules Json?
  isActive        Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tradingPartner EdiTradingPartner @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)

  @@unique([tenantId, tradingPartnerId, transactionType])
  @@index([tenantId])
  @@index([tradingPartnerId])
  @@index([transactionType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model EdiControlNumber {
  id       String @id @default(cuid())
  tenantId String

  // Control number type
  controlType String @db.VarChar(10) // ISA, GS, ST

  // Current value
  currentNumber Int @default(0)

  // Configuration
  prefix   String? @db.VarChar(10)
  suffix   String? @db.VarChar(10)
  minValue Int     @default(1)
  maxValue Int     @default(999999999)

  // Scoping (optional - for partner-specific numbering)
  tradingPartnerId String?
  transactionType  EdiTransactionType?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, controlType, tradingPartnerId, transactionType])
  @@index([tenantId])
  @@index([controlType])
  @@index([externalId, sourceSystem])
}

model EdiBatch {
  id       String @id @default(cuid())
  tenantId String

  // Batch info
  batchNumber    String @unique @db.VarChar(50)
  batchType      String @db.VarChar(50) // OUTBOUND, INBOUND
  messageCount   Int    @default(0)
  processedCount Int    @default(0)
  errorCount     Int    @default(0)

  // Processing
  startedAt   DateTime?
  completedAt DateTime?
  status      String    @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages EdiBatchMessage[]

  @@index([tenantId])
  @@index([batchNumber])
  @@index([status])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model EdiBatchMessage {
  id        String @id @default(cuid())
  tenantId  String
  batchId   String
  messageId String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  batch   EdiBatch   @relation(fields: [batchId], references: [id], onDelete: Cascade)
  message EdiMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([batchId, messageId])
  @@index([tenantId])
  @@index([batchId])
  @@index([messageId])
  @@index([externalId, sourceSystem])
}

model EdiCommunicationLog {
  id               String @id @default(cuid())
  tenantId         String
  tradingPartnerId String

  // Communication details
  direction EdiDirection
  protocol  EdiCommunicationProtocol
  action    String                   @db.VarChar(50) // SEND, RECEIVE, CONNECT, DISCONNECT
  status    String                   @db.VarChar(50) // SUCCESS, FAILED

  // Content
  fileName     String? @db.VarChar(500)
  fileSize     Int?
  messageCount Int?

  // Result
  responseCode String? @db.VarChar(50)
  errorMessage String? @db.Text

  // Timing
  startedAt   DateTime
  completedAt DateTime?
  durationMs  Int?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tradingPartner EdiTradingPartner @relation(fields: [tradingPartnerId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tradingPartnerId])
  @@index([direction])
  @@index([status])
  @@index([startedAt])
  @@index([externalId, sourceSystem])
}

model EdiEventTrigger {
  id       String @id @default(cuid())
  tenantId String

  // Trigger config
  triggerName     String             @db.VarChar(255)
  eventType       String             @db.VarChar(100) // LOAD_STATUS_CHANGE, LOAD_ASSIGNED, etc.
  transactionType EdiTransactionType
  isActive        Boolean            @default(true)

  // Conditions (JSON)
  conditions Json? // When to trigger

  // Target partners (JSON array of partner IDs)
  targetPartners Json?

  // Template/mapping
  messageTemplate String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventType])
  @@index([transactionType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model EdiCodeList {
  id       String @id @default(cuid())
  tenantId String

  // Code list info
  listName     String  @db.VarChar(100) // EQUIPMENT_TYPE, STATUS_CODE, etc.
  ediCode      String  @db.VarChar(50)
  internalCode String  @db.VarChar(50)
  description  String? @db.VarChar(500)
  isActive     Boolean @default(true)

  // Context (optional - for partner-specific codes)
  tradingPartnerId String?
  transactionType  EdiTransactionType?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, listName, ediCode, tradingPartnerId])
  @@index([tenantId])
  @@index([listName])
  @@index([ediCode])
  @@index([internalCode])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model EdiAcknowledgment {
  id                String @id @default(cuid())
  tenantId          String
  originalMessageId String

  // Acknowledgment details (997)
  ackControlNumber String   @db.VarChar(9)
  ackStatus        String   @db.VarChar(50) // ACCEPTED, ACCEPTED_WITH_ERRORS, REJECTED
  errorCodes       Json?
  receivedAt       DateTime

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  originalMessage EdiMessage @relation(fields: [originalMessageId], references: [id], onDelete: Cascade)

  @@unique([tenantId, ackControlNumber])
  @@index([tenantId])
  @@index([originalMessageId])
  @@index([ackStatus])
  @@index([receivedAt])
  @@index([externalId, sourceSystem])
}

model EdiError {
  id        String @id @default(cuid())
  tenantId  String
  messageId String

  // Error details
  errorType    String  @db.VarChar(100) // VALIDATION, PARSING, MAPPING, COMMUNICATION
  errorCode    String? @db.VarChar(50)
  errorMessage String  @db.Text
  segment      String? @db.VarChar(10)
  elementPath  String? @db.VarChar(255)
  severity     String  @db.VarChar(20) // ERROR, WARNING

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  message EdiMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([messageId])
  @@index([errorType])
  @@index([severity])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// SAFETY SERVICE (Service 29) - Models
// ==============================================

model FmcsaCarrierRecord {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String @unique

  // FMCSA identifiers
  dotNumber String? @db.VarChar(20)
  mcNumber  String? @db.VarChar(20)
  legalName String? @db.VarChar(255)
  dbaName   String? @db.VarChar(255)

  // Operating status
  operatingStatus  SaferDataStatus?
  outOfServiceDate DateTime?

  // Authority
  commonAuthority   Boolean @default(false)
  contractAuthority Boolean @default(false)
  brokerAuthority   Boolean @default(false)

  // Physical address
  physicalAddress String? @db.Text
  physicalCity    String? @db.VarChar(100)
  physicalState   String? @db.VarChar(2)
  physicalZip     String? @db.VarChar(10)

  // Mailing address
  mailingAddress String? @db.Text
  mailingCity    String? @db.VarChar(100)
  mailingState   String? @db.VarChar(2)
  mailingZip     String? @db.VarChar(10)

  // Phone
  phone String? @db.VarChar(20)

  // Fleet data
  powerUnitCount Int?
  driverCount    Int?

  // SAFER data
  saferDataJson Json?
  lastSyncedAt  DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier   Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  csaScores CsaScore[]

  @@index([tenantId])
  @@index([carrierId])
  @@index([dotNumber])
  @@index([mcNumber])
  @@index([operatingStatus])
  @@index([externalId, sourceSystem])
}

model CsaScore {
  id            String  @id @default(cuid())
  tenantId      String
  carrierId     String
  fmcsaRecordId String?

  // BASIC category
  basicType CSABasicType

  // Score data
  score            Decimal? @db.Decimal(5, 2)
  percentile       Int?
  threshold        Int?
  isAboveThreshold Boolean  @default(false)
  isAlert          Boolean  @default(false)

  // Inspection data
  inspectionCount   Int @default(0)
  violationCount    Int @default(0)
  oosViolationCount Int @default(0)

  // Effective period
  measurementPeriod String?  @db.VarChar(50) // 12_MONTHS, 24_MONTHS
  asOfDate          DateTime @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier     Carrier             @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  fmcsaRecord FmcsaCarrierRecord? @relation(fields: [fmcsaRecordId], references: [id], onDelete: SetNull)

  @@unique([tenantId, carrierId, basicType, asOfDate])
  @@index([tenantId])
  @@index([carrierId])
  @@index([basicType])
  @@index([isAlert])
  @@index([asOfDate])
  @@index([externalId, sourceSystem])
}

model CarrierInsurance {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // Insurance type
  insuranceType InsuranceType

  // Coverage details
  policyNumber   String  @db.VarChar(100)
  carrierName    String  @db.VarChar(255)
  coverageAmount Decimal @db.Decimal(15, 2)

  // Dates
  effectiveDate  DateTime @db.Date
  expirationDate DateTime @db.Date
  isExpired      Boolean  @default(false)

  // Agent/contact
  agentName  String? @db.VarChar(255)
  agentPhone String? @db.VarChar(20)
  agentEmail String? @db.VarChar(255)

  // Certificate
  certificateUrl String? @db.VarChar(500)

  // Verification
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?
  verifiedById String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([insuranceType])
  @@index([expirationDate])
  @@index([isExpired])
  @@index([externalId, sourceSystem])
}

model DriverQualificationFile {
  id       String @id @default(cuid())
  tenantId String
  driverId String

  // Document type
  documentType DQFDocumentType

  // Document details
  documentNumber String? @db.VarChar(100)
  documentUrl    String? @db.VarChar(500)

  // Dates
  issueDate      DateTime? @db.Date
  expirationDate DateTime? @db.Date
  isExpired      Boolean   @default(false)

  // Verification
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?
  verifiedById String?

  // Clearinghouse query (for FMCSA drug & alcohol)
  clearinghouseStatus String?   @db.VarChar(50)
  lastQueryDate       DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([driverId])
  @@index([documentType])
  @@index([expirationDate])
  @@index([isExpired])
  @@index([externalId, sourceSystem])
}

model SafetyIncident {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String?
  driverId  String?
  loadId    String?

  // Incident details
  incidentType SafetyIncidentType
  incidentDate DateTime           @db.Date
  location     String?            @db.VarChar(500)
  description  String             @db.Text

  // Severity
  severity        String? @db.VarChar(50) // MINOR, MAJOR, CRITICAL
  injuriesCount   Int     @default(0)
  fatalitiesCount Int     @default(0)

  // Out of service
  wasOutOfService Boolean @default(false)
  oosReason       String? @db.Text

  // Citations/violations
  citationNumber String?  @db.VarChar(100)
  violationCodes Json? // Array of violation codes
  fineAmount     Decimal? @db.Decimal(10, 2)

  // Investigation
  investigationNotes String? @db.Text
  reportUrl          String? @db.VarChar(500)

  // CSA impact
  csaPoints Decimal? @db.Decimal(5, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  driver  Driver?  @relation(fields: [driverId], references: [id], onDelete: SetNull)
  load    Load?    @relation(fields: [loadId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([driverId])
  @@index([loadId])
  @@index([incidentType])
  @@index([incidentDate])
  @@index([severity])
  @@index([externalId, sourceSystem])
}

model SafetyInspection {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String?
  driverId  String?

  // Inspection details
  inspectionNumber   String   @db.VarChar(100)
  inspectionDate     DateTime @db.Date
  inspectionLevel    Int? // 1-6
  inspectionState    String?  @db.VarChar(2)
  inspectionLocation String?  @db.VarChar(500)

  // Results
  totalViolations Int     @default(0)
  oosViolations   Int     @default(0)
  wasOutOfService Boolean @default(false)

  // Violations (JSON array)
  violations Json?

  // BASIC categories affected (JSON array)
  basicsAffected Json?

  // Report
  reportNumber String? @db.VarChar(100)
  reportUrl    String? @db.VarChar(500)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  driver  Driver?  @relation(fields: [driverId], references: [id], onDelete: SetNull)

  @@unique([tenantId, inspectionNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([driverId])
  @@index([inspectionDate])
  @@index([wasOutOfService])
  @@index([externalId, sourceSystem])
}

model SafetyAlert {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String?

  // Alert details
  alertType    SafetyAlertType
  alertMessage String          @db.Text
  severity     String          @db.VarChar(50) // LOW, MEDIUM, HIGH, CRITICAL

  // Related data
  relatedEntityType String? @db.VarChar(50) // INSURANCE, CSA_SCORE, INSPECTION, etc.
  relatedEntityId   String?

  // Status
  isActive         Boolean   @default(true)
  acknowledgedAt   DateTime?
  acknowledgedById String?
  resolvedAt       DateTime?
  resolvedById     String?
  resolutionNotes  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([alertType])
  @@index([severity])
  @@index([isActive])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model AuthorityChange {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // Change details
  changeType  String   @db.VarChar(100) // AUTHORITY_GRANTED, AUTHORITY_REVOKED, STATUS_CHANGE, etc.
  changeDate  DateTime @db.Date
  oldValue    String?  @db.Text
  newValue    String?  @db.Text
  description String?  @db.Text

  // Source
  sourceAgency String? @db.VarChar(100) // FMCSA, STATE_DOT, etc.

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([changeType])
  @@index([changeDate])
  @@index([externalId, sourceSystem])
}

model CarrierWatchlist {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // Watchlist details
  reason    String @db.Text
  riskLevel String @db.VarChar(50) // LOW, MEDIUM, HIGH, CRITICAL

  // Restrictions
  isRestricted Boolean @default(false)
  restrictions String? @db.Text

  // Review
  nextReviewDate      DateTime? @db.Date
  reviewFrequencyDays Int?

  // Status
  isActive        Boolean   @default(true)
  resolvedAt      DateTime?
  resolvedById    String?
  resolutionNotes String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([riskLevel])
  @@index([isActive])
  @@index([nextReviewDate])
  @@index([externalId, sourceSystem])
}

model SafetyAuditTrail {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String?

  // Audit event
  eventType        String @db.VarChar(100) // COMPLIANCE_CHECK, INSURANCE_VERIFIED, etc.
  eventDescription String @db.Text
  eventData        Json?

  // Source
  performedById String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([eventType])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// RATE INTELLIGENCE SERVICE (Service 35) - Models
// ==============================================

model RateQuery {
  id       String @id @default(cuid())
  tenantId String

  // Query parameters
  originCity    String  @db.VarChar(100)
  originState   String  @db.VarChar(2)
  originZip     String? @db.VarChar(10)
  destCity      String  @db.VarChar(100)
  destState     String  @db.VarChar(2)
  destZip       String? @db.VarChar(10)
  equipmentType String  @db.VarChar(50)

  // Provider results
  provider   RateProvider
  lowRate    Decimal?     @db.Decimal(10, 2)
  highRate   Decimal?     @db.Decimal(10, 2)
  avgRate    Decimal?     @db.Decimal(10, 2)
  confidence String?      @db.VarChar(50) // HIGH, MEDIUM, LOW

  // Market data
  loadVolume  Int?
  truckVolume Int?
  marketTrend String? @db.VarChar(50) // UP, DOWN, FLAT

  // Cached data
  queryHash   String   @db.VarChar(64) // MD5 of query params for deduplication
  cachedUntil DateTime

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, queryHash])
  @@index([tenantId])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([provider])
  @@index([cachedUntil])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model RateHistory {
  id       String @id @default(cuid())
  tenantId String

  // Lane identification
  originCity    String @db.VarChar(100)
  originState   String @db.VarChar(2)
  destCity      String @db.VarChar(100)
  destState     String @db.VarChar(2)
  equipmentType String @db.VarChar(50)

  // Rate data
  provider RateProvider
  avgRate  Decimal      @db.Decimal(10, 2)
  lowRate  Decimal      @db.Decimal(10, 2)
  highRate Decimal      @db.Decimal(10, 2)

  // Market conditions
  loadVolume       Int?
  truckVolume      Int?
  loadToTruckRatio Decimal? @db.Decimal(5, 2)

  // Time period
  weekStartDate DateTime @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, originState, destState, equipmentType, weekStartDate, provider])
  @@index([tenantId])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([weekStartDate])
  @@index([provider])
  @@index([externalId, sourceSystem])
}

model RateAlert {
  id       String @id @default(cuid())
  tenantId String

  // Lane identification
  laneDescription String  @db.VarChar(500)
  originCity      String? @db.VarChar(100)
  originState     String  @db.VarChar(2)
  destCity        String? @db.VarChar(100)
  destState       String  @db.VarChar(2)
  equipmentType   String  @db.VarChar(50)

  // Alert conditions
  condition        AlertCondition
  thresholdValue   Decimal        @db.Decimal(10, 2)
  comparisonPeriod String         @db.VarChar(50) // DAILY, WEEKLY, MONTHLY

  // Notification
  notifyUserIds Json? // Array of user IDs to notify
  notifyEmails  Json? // Array of email addresses

  // Status
  isActive        Boolean   @default(true)
  lastTriggeredAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history RateAlertHistory[]

  @@index([tenantId])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model RateAlertHistory {
  id       String @id @default(cuid())
  tenantId String
  alertId  String

  // Trigger details
  triggeredAt   DateTime
  oldRate       Decimal  @db.Decimal(10, 2)
  newRate       Decimal  @db.Decimal(10, 2)
  changePercent Decimal  @db.Decimal(5, 2)

  // Notification sent
  notificationSent Boolean @default(false)
  notifiedUserIds  Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  alert  RateAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([alertId])
  @@index([triggeredAt])
  @@index([externalId, sourceSystem])
}

model LaneAnalytics {
  id       String @id @default(cuid())
  tenantId String

  // Lane identification
  originState   String @db.VarChar(2)
  destState     String @db.VarChar(2)
  equipmentType String @db.VarChar(50)

  // Performance metrics
  totalLoads     Int     @default(0)
  avgRate        Decimal @db.Decimal(10, 2)
  avgMargin      Decimal @db.Decimal(5, 2)
  avgTransitDays Decimal @db.Decimal(4, 1)
  onTimePercent  Decimal @db.Decimal(5, 2)

  // Provider comparison
  datAvgRate       Decimal? @db.Decimal(10, 2)
  truckstopAvgRate Decimal? @db.Decimal(10, 2)

  // Market position
  vsMarketPercent Decimal? @db.Decimal(5, 2) // How our rate compares to market avg

  // Time period
  periodType  String   @db.VarChar(20) // WEEK, MONTH, QUARTER, YEAR
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, originState, destState, equipmentType, periodType, periodStart])
  @@index([tenantId])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([periodType])
  @@index([periodStart])
  @@index([externalId, sourceSystem])
}

model RateProviderConfig {
  id       String @id @default(cuid())
  tenantId String

  // Provider details
  provider RateProvider

  // API credentials (encrypted)
  apiKey      String? @db.VarChar(500)
  apiSecret   String? @db.VarChar(500)
  apiEndpoint String? @db.VarChar(500)
  username    String? @db.VarChar(255)
  password    String? @db.VarChar(500)

  // Configuration
  isActive          Boolean @default(true)
  rateLimitPerHour  Int?
  cacheDurationMins Int     @default(60)

  // Usage tracking
  queriesThisMonth Int       @default(0)
  lastQueryAt      DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
  @@index([tenantId])
  @@index([provider])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

// ==============================================
// LOAD BOARD EXTERNAL SERVICE (Service 32) - Models
// ==============================================

model LoadBoardProvider {
  id       String @id @default(cuid())
  tenantId String

  // Provider details
  providerType LoadBoardProviderType @unique

  // API credentials (encrypted)
  apiKey      String? @db.VarChar(500)
  apiSecret   String? @db.VarChar(500)
  apiEndpoint String? @db.VarChar(500)
  username    String? @db.VarChar(255)
  password    String? @db.VarChar(500)

  // Configuration
  isActive     Boolean @default(true)
  autoPost     Boolean @default(false)
  postingRules Json? // Conditions for auto-posting

  // Rate limits
  postsPerDay    Int?
  postsThisMonth Int  @default(0)

  // Usage tracking
  lastPostAt DateTime?
  totalPosts Int       @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accounts LoadBoardAccount[]

  @@index([tenantId])
  @@index([providerType])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model LoadBoardAccount {
  id         String @id @default(cuid())
  tenantId   String
  providerId String

  // Account details
  accountName   String  @db.VarChar(255)
  accountNumber String? @db.VarChar(100)

  // Credentials (per-account, if different from provider)
  accountUsername String? @db.VarChar(255)
  accountPassword String? @db.VarChar(500)
  accountApiKey   String? @db.VarChar(500)

  // Status
  isActive       Boolean   @default(true)
  isVerified     Boolean   @default(false)
  lastVerifiedAt DateTime?

  // Usage
  postsThisMonth Int @default(0)
  totalPosts     Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider LoadBoardProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  posts    LoadPost[]

  @@index([tenantId])
  @@index([providerId])
  @@index([isActive])
  @@index([externalId, sourceSystem])
}

model LoadPost {
  id        String  @id @default(cuid())
  tenantId  String
  accountId String
  loadId    String?
  orderId   String?

  // Post details
  postNumber     String         @unique @db.VarChar(50)
  externalPostId String?        @db.VarChar(100) // ID from load board
  status         LoadPostStatus @default(DRAFT)

  // Load details
  originCity    String    @db.VarChar(100)
  originState   String    @db.VarChar(2)
  originZip     String?   @db.VarChar(10)
  destCity      String    @db.VarChar(100)
  destState     String    @db.VarChar(2)
  destZip       String?   @db.VarChar(10)
  pickupDate    DateTime  @db.Date
  deliveryDate  DateTime? @db.Date
  equipmentType String    @db.VarChar(50)
  length        Int?
  weight        Int?
  commodity     String?   @db.VarChar(255)

  // Rates
  postedRate Decimal @db.Decimal(10, 2)
  currency   String  @default("USD") @db.VarChar(3)

  // Contact info
  contactName  String? @db.VarChar(255)
  contactPhone String? @db.VarChar(20)
  contactEmail String? @db.VarChar(255)

  // Dates
  postedAt  DateTime?
  expiresAt DateTime?
  removedAt DateTime?

  // Performance
  views     Int @default(0)
  clicks    Int @default(0)
  leadCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account  LoadBoardAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  load     Load?            @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order    Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  leads    PostLead[]
  rateData RateData[]

  @@index([tenantId])
  @@index([accountId])
  @@index([loadId])
  @@index([orderId])
  @@index([postNumber])
  @@index([status])
  @@index([originState])
  @@index([destState])
  @@index([pickupDate])
  @@index([postedAt])
  @@index([externalId, sourceSystem])
}

model PostLead {
  id        String  @id @default(cuid())
  tenantId  String
  postId    String
  carrierId String?

  // Lead details
  carrierName  String  @db.VarChar(255)
  carrierMC    String? @db.VarChar(20)
  carrierDOT   String? @db.VarChar(20)
  contactName  String  @db.VarChar(255)
  contactPhone String  @db.VarChar(20)
  contactEmail String? @db.VarChar(255)

  // Quote/response
  quotedRate    Decimal?  @db.Decimal(10, 2)
  availableDate DateTime? @db.Date
  equipmentInfo String?   @db.Text
  notes         String?   @db.Text

  // Status
  status PostLeadStatus @default(NEW)

  // Follow-up
  contactedAt     DateTime?
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?

  // Outcome
  acceptedAt     DateTime?
  declinedAt     DateTime?
  declinedReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  post    LoadPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  carrier Carrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([postId])
  @@index([carrierId])
  @@index([status])
  @@index([createdAt])
  @@index([nextFollowUpAt])
  @@index([externalId, sourceSystem])
}

model CapacitySearch {
  id        String  @id @default(cuid())
  tenantId  String
  accountId String?

  // Search parameters
  searchNumber  String   @unique @db.VarChar(50)
  originCity    String?  @db.VarChar(100)
  originState   String   @db.VarChar(2)
  originRadius  Int? // miles
  destCity      String?  @db.VarChar(100)
  destState     String   @db.VarChar(2)
  destRadius    Int? // miles
  equipmentType String   @db.VarChar(50)
  availableDate DateTime @db.Date

  // Optional filters
  minLength Int?
  minWeight Int?
  maxAge    String? @db.VarChar(50) // e.g., "24h", "7d"

  // Results
  resultCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  results CapacityResult[]

  @@index([tenantId])
  @@index([searchNumber])
  @@index([originState])
  @@index([destState])
  @@index([equipmentType])
  @@index([availableDate])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model CapacityResult {
  id       String @id @default(cuid())
  tenantId String
  searchId String

  // Carrier/truck details
  carrierName  String  @db.VarChar(255)
  carrierMC    String? @db.VarChar(20)
  carrierDOT   String? @db.VarChar(20)
  contactName  String? @db.VarChar(255)
  contactPhone String? @db.VarChar(20)

  // Truck details
  truckLocation String   @db.VarChar(500)
  truckCity     String?  @db.VarChar(100)
  truckState    String?  @db.VarChar(2)
  truckZip      String?  @db.VarChar(10)
  equipmentType String   @db.VarChar(50)
  availableDate DateTime @db.Date
  length        Int?
  comments      String?  @db.Text

  // Contact status
  contacted   Boolean   @default(false)
  contactedAt DateTime?
  interested  Boolean?
  notes       String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  search CapacitySearch @relation(fields: [searchId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([searchId])
  @@index([truckState])
  @@index([equipmentType])
  @@index([availableDate])
  @@index([contacted])
  @@index([externalId, sourceSystem])
}

model PostingRule {
  id        String  @id @default(cuid())
  tenantId  String
  accountId String?

  // Rule details
  ruleName String  @db.VarChar(255)
  isActive Boolean @default(true)

  // Conditions (JSON)
  conditions Json // e.g., { "minMargin": 15, "lanes": ["CA-TX"], "equipmentTypes": ["VAN"] }

  // Posting settings
  frequency       PostingFrequency
  scheduleTime    String?          @db.VarChar(10) // e.g., "14:00" for 2 PM
  expirationHours Int?

  // Performance
  rulesMatched    Int       @default(0)
  postsCreated    Int       @default(0)
  lastTriggeredAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([accountId])
  @@index([isActive])
  @@index([frequency])
  @@index([externalId, sourceSystem])
}

model PostingSchedule {
  id       String  @id @default(cuid())
  tenantId String
  postId   String?
  ruleId   String?

  // Schedule details
  scheduledFor DateTime
  status       String   @default("PENDING") @db.VarChar(50) // PENDING, COMPLETED, FAILED, CANCELLED

  // Execution
  executedAt   DateTime?
  errorMessage String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([postId])
  @@index([ruleId])
  @@index([scheduledFor])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model RateData {
  id       String @id @default(cuid())
  tenantId String
  postId   String

  // Market rate data from load board
  marketLowRate    Decimal? @db.Decimal(10, 2)
  marketHighRate   Decimal? @db.Decimal(10, 2)
  marketAvgRate    Decimal? @db.Decimal(10, 2)
  similarLoadCount Int?
  dataSource       String?  @db.VarChar(50)
  asOfDate         DateTime @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  post   LoadPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([postId])
  @@index([asOfDate])
  @@index([externalId, sourceSystem])
}

model BoardMetric {
  id        String  @id @default(cuid())
  tenantId  String
  accountId String?

  // Metrics period
  periodType  String   @db.VarChar(20) // DAY, WEEK, MONTH
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date

  // Post metrics
  postsCreated Int @default(0)
  postsActive  Int @default(0)
  postsExpired Int @default(0)
  postsCovered Int @default(0)

  // Engagement metrics
  totalViews     Int @default(0)
  totalClicks    Int @default(0)
  totalLeads     Int @default(0)
  leadsContacted Int @default(0)
  leadsConverted Int @default(0)

  // Rates
  avgClickRate      Decimal? @db.Decimal(5, 2)
  avgConversionRate Decimal? @db.Decimal(5, 2)
  avgPostedRate     Decimal? @db.Decimal(10, 2)
  avgAcceptedRate   Decimal? @db.Decimal(10, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, accountId, periodType, periodStart])
  @@index([tenantId])
  @@index([accountId])
  @@index([periodType])
  @@index([periodStart])
  @@index([externalId, sourceSystem])
}
