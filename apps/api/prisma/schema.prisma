// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & ADMIN SERVICE (Service 01)
// ============================================================================

model Tenant {
  id                 String    @id @default(cuid())
  name               String    @db.VarChar(255)
  slug               String    @unique @db.VarChar(255)
  domain             String?   @db.VarChar(255)
  settings           Json      @default("{}")
  features           Json      @default("{}")
  branding           Json      @default("{}")
  status             String    @default("ACTIVE") @db.VarChar(20) // ACTIVE, INACTIVE, SUSPENDED, TRIAL
  trialEndsAt        DateTime?
  subscriptionPlan   String?   @db.VarChar(50)
  subscriptionStatus String?   @db.VarChar(20)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  users               User[]
  roles               Role[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]

  // CRM Relations
  companies       Company[]
  contacts        Contact[]
  opportunities   Opportunity[]
  activities      Activity[]
  hubspotSyncLogs HubspotSyncLog[]

  // Sales Relations
  quotes            Quote[]
  quoteStops        QuoteStop[]
  quoteAccessorials QuoteAccessorial[]
  rateContracts     RateContract[]
  contractLaneRates ContractLaneRate[]
  accessorialRates  AccessorialRate[]
  salesQuotas       SalesQuota[]

  // TMS Core Relations
  orders          Order[]
  loads           Load[]
  stops           Stop[]
  orderItems      OrderItem[]
  checkCalls      CheckCall[]
  statusHistories StatusHistory[]

  // Carrier Relations
  carriers                  Carrier[]
  carrierContacts           CarrierContact[]
  drivers                   Driver[]
  insuranceCertificates     InsuranceCertificate[]
  carrierDocuments          CarrierDocument[]
  carrierPerformanceHistory CarrierPerformanceHistory[]
  fmcsaComplianceLogs       FmcsaComplianceLog[]

  // Accounting Relations
  chartOfAccounts     ChartOfAccount[]
  invoices            Invoice[]
  invoiceLineItems    InvoiceLineItem[]
  settlements         Settlement[]
  settlementLineItems SettlementLineItem[]
  paymentsReceived    PaymentReceived[]
  paymentApplications PaymentApplication[]
  paymentsMade        PaymentMade[]
  journalEntries      JournalEntry[]
  journalEntryLines   JournalEntryLine[]
  quickbooksSyncLog   QuickbooksSyncLog[]

  // Load Board Relations
  loadPostings     LoadPosting[]
  carrierLoadViews CarrierLoadView[]
  loadBids         LoadBid[]
  loadTenders      LoadTender[]
  tenderRecipients TenderRecipient[]

  // Commission Relations
  commissionPlans             CommissionPlan[]
  userCommissionAssignments   UserCommissionAssignment[]
  customerCommissionOverrides CustomerCommissionOverride[]
  commissionEntries           CommissionEntry[]
  commissionPayouts           CommissionPayout[]

  // Documents Relations
  documents          Document[]
  documentTemplates  DocumentTemplate[]
  generatedDocuments GeneratedDocument[]
  documentFolders    DocumentFolder[]

  // Communication Relations
  communicationTemplates  CommunicationTemplate[]
  communicationLogs       CommunicationLog[]
  smsConversations        SmsConversation[]
  notificationPreferences NotificationPreference[]
  inAppNotifications      InAppNotification[]

  // Carrier Relations (Additional)
  carrierCapacities CarrierCapacity[]

  // Customer Portal Relations
  portalUsers        PortalUser[]
  portalSessions     PortalSession[]
  quoteRequests      QuoteRequest[]
  portalActivityLogs PortalActivityLog[]
  portalPayments     PortalPayment[]

  // Carrier Portal Relations
  carrierPortalUsers        CarrierPortalUser[]
  carrierPortalSessions     CarrierPortalSession[]
  carrierPortalDocuments    CarrierPortalDocument[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]
  carrierQuickPayRequests   CarrierQuickPayRequest[]
  carrierPortalActivityLogs CarrierPortalActivityLog[]

  // Contracts Relations
  contracts           Contract[]
  fuelSurchargeTables FuelSurchargeTable[]
  contractSLAs        ContractSLA[]
  volumeCommitments   VolumeCommitment[]

  // Agent Relations
  agents                   Agent[]
  agentAgreements          AgentAgreement[]
  agentCustomerAssignments AgentCustomerAssignment[]
  agentCommissions         AgentCommission[]

  // Factoring Relations
  factoringCompanies       FactoringCompany[]
  noaRecords               NOARecord[]
  carrierFactoringStatuses CarrierFactoringStatus[]

  // HR Relations
  employees       Employee[]
  departments     Department[]
  positions       Position[]
  timeOffRequests TimeOffRequest[]

  // Analytics Relations
  kpiDefinitions KPIDefinition[]
  dashboards     Dashboard[]
  reports        Report[]

  // Workflow Relations
  workflows          Workflow[]
  workflowExecutions WorkflowExecution[]
  approvalRequests   ApprovalRequest[]

  // Integration Hub Relations
  integrations      Integration[]
  webhookEndpoints  WebhookEndpoint[]
  webhookDeliveries WebhookDelivery[]

  // Search Relations
  savedSearches SavedSearch[]
  searchHistory SearchHistory[]

  // Audit Relations
  auditLogs     AuditLog[]
  changeHistory ChangeHistory[]

  // Cache Relations
  cacheConfigs CacheConfig[]
  rateLimits   RateLimit[]

  // Scheduler Relations
  scheduledJobs ScheduledJob[]

  // Help Desk Relations
  supportTickets SupportTicket[]
  ticketReplies  TicketReply[]
  kbArticles     KBArticle[]

  // Feedback Relations
  npsSurveys      NPSSurvey[]
  npsResponses    NPSResponse[]
  featureRequests FeatureRequest[]

  @@index([slug])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model User {
  id                  String    @id @default(cuid())
  tenantId            String
  email               String    @db.VarChar(255)
  passwordHash        String    @db.VarChar(255)
  emailVerifiedAt     DateTime?
  firstName           String    @db.VarChar(100)
  lastName            String    @db.VarChar(100)
  phone               String?   @db.VarChar(20)
  avatarUrl           String?   @db.VarChar(500)
  timezone            String    @default("America/Chicago") @db.VarChar(50)
  locale              String    @default("en") @db.VarChar(10)
  status              String    @default("INVITED") @db.VarChar(20) // INVITED, ACTIVE, INACTIVE, LOCKED
  lastLoginAt         DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  roleId              String?

  // MFA (Multi-Factor Authentication) - Phase B
  mfaEnabled Boolean @default(false)
  mfaSecret  String? @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role                Role?                @relation(fields: [roleId], references: [id], onDelete: SetNull)
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  createdBy           User?                @relation("UserCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy           User?                @relation("UserUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  createdUsers        User[]               @relation("UserCreatedBy")
  updatedUsers        User[]               @relation("UserUpdatedBy")

  // CRM Relations
  assignedCompanies  Company[]     @relation("CompanyAssignedUser")
  ownedOpportunities Opportunity[] @relation("OpportunityOwner")
  ownedActivities    Activity[]    @relation("ActivityOwner")

  // Sales Relations
  salesQuotes Quote[]      @relation("QuoteSalesRep")
  salesQuotas SalesQuota[]

  // TMS Core Relations
  salesOrders Order[] @relation("OrderSalesRep")

  // Commission Relations
  commissionAssignments       UserCommissionAssignment[]
  customerCommissionOverrides CustomerCommissionOverride[]
  commissionEntries           CommissionEntry[]
  commissionPayouts           CommissionPayout[]
  approvedPayouts             CommissionPayout[]           @relation("PayoutApprover")

  // Documents Relations
  uploadedDocuments    Document[]          @relation
  createdTemplates     DocumentTemplate[]
  generatedDocuments   GeneratedDocument[]
  documentShares       DocumentShare[]
  createdFolders       DocumentFolder[]
  addedFolderDocuments FolderDocument[]

  // Communication Relations
  notificationPreference NotificationPreference?
  inAppNotifications     InAppNotification[]
  employee               Employee?

  @@unique([tenantId, email])
  @@index([email])
  @@index([tenantId])
  @@index([status])
  @@index([roleId])
  @@index([externalId, sourceSystem])
}

model Role {
  id          String  @id @default(cuid())
  tenantId    String? // NULL for system roles
  name        String  @db.VarChar(100)
  description String? @db.Text
  permissions Json    @default("[]") // Array of permission strings
  isSystem    Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  User[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isSystem])
}

model Session {
  id               String    @id @default(cuid())
  tenantId         String?
  userId           String
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  tenantId  String?
  userId    String
  tokenHash String    @db.VarChar(255)
  expiresAt DateTime
  usedAt    DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ============================================================================
// CRM SERVICE (Service 02)
// ============================================================================

model Company {
  id          String  @id @default(cuid())
  tenantId    String
  name        String  @db.VarChar(255)
  legalName   String? @db.VarChar(255)
  dbaName     String? @db.VarChar(255)
  companyType String  @db.VarChar(50) // CUSTOMER, PROSPECT, PARTNER, VENDOR
  status      String  @default("ACTIVE") @db.VarChar(50)
  industry    String? @db.VarChar(100)
  segment     String? @db.VarChar(50) // ENTERPRISE, MID_MARKET, SMB
  tier        String? @db.VarChar(20) // PLATINUM, GOLD, SILVER, BRONZE
  website     String? @db.VarChar(255)
  phone       String? @db.VarChar(50)
  email       String? @db.VarChar(255)

  // Address
  addressLine1 String? @db.VarChar(255)
  addressLine2 String? @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(50)
  postalCode   String? @db.VarChar(20)
  country      String  @default("USA") @db.VarChar(3)

  // Billing
  creditLimit  Decimal? @db.Decimal(12, 2)
  paymentTerms String?  @db.VarChar(50) // NET30, NET15, COD, PREPAID
  taxId        String?  @db.VarChar(50)
  dunsNumber   String?  @db.VarChar(20)

  // Operations defaults
  defaultPickupInstructions   String? @db.Text
  defaultDeliveryInstructions String? @db.Text
  requiresAppointment         Boolean @default(false)
  requiresLumper              Boolean @default(false)

  // Hierarchy & Assignment
  parentCompanyId String?
  assignedUserId  String?

  // HubSpot Integration
  hubspotId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentCompany  Company?      @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: SetNull)
  childCompanies Company[]     @relation("CompanyHierarchy")
  assignedUser   User?         @relation("CompanyAssignedUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  contacts       Contact[]
  opportunities  Opportunity[]
  activities     Activity[]

  // Sales Relations
  quotes        Quote[]
  rateContracts RateContract[]

  // TMS Core Relations
  orders Order[] @relation("OrderCustomer")

  // Accounting Relations
  invoices         Invoice[]
  paymentsReceived PaymentReceived[]

  // Commission Relations
  commissionOverrides CustomerCommissionOverride[]

  // Documents Relations
  documents Document[]

  // Additional Relations
  portalUsers              PortalUser[]
  quoteRequests            QuoteRequest[]
  portalActivityLogs       PortalActivityLog[]
  portalPayments           PortalPayment[]
  contractsAsCustomer      Contract[]                @relation("CustomerContracts")
  agentCustomerAssignments AgentCustomerAssignment[] @relation("AgentCustomerAssignments")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([companyType])
  @@index([status])
  @@index([assignedUserId])
  @@index([hubspotId])
  @@index([externalId, sourceSystem])
}

model Contact {
  id                     String  @id @default(cuid())
  tenantId               String
  companyId              String?
  firstName              String  @db.VarChar(100)
  lastName               String  @db.VarChar(100)
  title                  String? @db.VarChar(100)
  department             String? @db.VarChar(100)
  roleType               String? @db.VarChar(50) // PRIMARY, BILLING, SHIPPING, OPERATIONS, EXECUTIVE
  email                  String? @db.VarChar(255)
  phone                  String? @db.VarChar(50)
  mobile                 String? @db.VarChar(50)
  fax                    String? @db.VarChar(50)
  preferredContactMethod String? @db.VarChar(20) // EMAIL, PHONE, SMS
  language               String  @default("en") @db.VarChar(10)
  timezone               String? @db.VarChar(50)
  status                 String  @default("ACTIVE") @db.VarChar(50)
  isPrimary              Boolean @default(false)
  receivesInvoices       Boolean @default(false)
  receivesTracking       Boolean @default(false)

  // HubSpot Integration
  hubspotId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company       Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  opportunities Opportunity[] @relation("OpportunityPrimaryContact")
  activities    Activity[]

  // Sales Relations
  quotes Quote[]

  // TMS Core Relations
  orders Order[] @relation("OrderContact")

  @@index([tenantId])
  @@index([companyId])
  @@index([email])
  @@index([isPrimary])
  @@index([hubspotId])
  @@index([externalId, sourceSystem])
}

model Opportunity {
  id                     String    @id @default(cuid())
  tenantId               String
  companyId              String
  name                   String    @db.VarChar(255)
  description            String?   @db.Text
  stage                  String    @db.VarChar(50) // LEAD, QUALIFIED, PROPOSAL, NEGOTIATION, WON, LOST
  probability            Int       @default(0) // 0-100
  estimatedValue         Decimal?  @db.Decimal(12, 2)
  estimatedLoadsPerMonth Int?
  avgLoadValue           Decimal?  @db.Decimal(10, 2)
  expectedCloseDate      DateTime?
  actualCloseDate        DateTime?
  serviceTypes           String[]  @db.VarChar(50) // FTL, LTL, DRAYAGE, etc.
  lanes                  Json      @default("[]") // [{origin, destination, volume}]
  competition            String?   @db.Text
  winReason              String?   @db.Text
  lossReason             String?   @db.Text
  primaryContactId       String?
  ownerId                String

  // HubSpot Integration
  hubspotDealId String? @db.VarChar(50)

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company        Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  primaryContact Contact?   @relation("OpportunityPrimaryContact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  owner          User       @relation("OpportunityOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  activities     Activity[]

  @@index([tenantId])
  @@index([companyId])
  @@index([stage])
  @@index([ownerId])
  @@index([expectedCloseDate])
  @@index([hubspotDealId])
  @@index([externalId, sourceSystem])
}

model Activity {
  id              String    @id @default(cuid())
  tenantId        String
  entityType      String    @db.VarChar(50) // COMPANY, CONTACT, OPPORTUNITY, ORDER
  entityId        String
  activityType    String    @db.VarChar(50) // CALL, EMAIL, MEETING, NOTE, TASK
  subject         String?   @db.VarChar(255)
  description     String?   @db.Text
  activityDate    DateTime  @default(now())
  durationMinutes Int?
  dueDate         DateTime?
  completedAt     DateTime?
  priority        String?   @db.VarChar(20) // HIGH, MEDIUM, LOW
  status          String    @default("PENDING") @db.VarChar(50)
  ownerId         String?

  // Linked entities (optional polymorphic)
  companyId     String?
  contactId     String?
  opportunityId String?

  // HubSpot Integration
  hubspotEngagementId String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company     Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  owner       User?        @relation("ActivityOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([activityType])
  @@index([activityDate])
  @@index([dueDate])
  @@index([status])
  @@index([ownerId])
  @@index([companyId])
  @@index([contactId])
  @@index([opportunityId])
  @@index([hubspotEngagementId])
  @@index([externalId, sourceSystem])
}

model HubspotSyncLog {
  id              String  @id @default(cuid())
  tenantId        String
  entityType      String  @db.VarChar(50) // COMPANY, CONTACT, OPPORTUNITY, ACTIVITY
  entityId        String
  hubspotId       String  @db.VarChar(50)
  syncDirection   String  @db.VarChar(20) // TO_HUBSPOT, FROM_HUBSPOT
  syncStatus      String  @db.VarChar(20) // SUCCESS, FAILED, PENDING
  payloadSent     Json?
  payloadReceived Json?
  errorMessage    String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  syncedAt  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([hubspotId])
  @@index([syncStatus])
  @@index([syncedAt])
}

// ============================================================================
// SALES SERVICE (Service 03)
// ============================================================================

model Quote {
  id            String  @id @default(cuid())
  tenantId      String
  quoteNumber   String  @db.VarChar(50)
  version       Int     @default(1)
  parentQuoteId String?
  companyId     String?
  contactId     String?

  // Quick quote customer info (when no company)
  customerName  String? @db.VarChar(255)
  customerEmail String? @db.VarChar(255)
  customerPhone String? @db.VarChar(50)

  status        String  @default("DRAFT") @db.VarChar(50) // DRAFT, SENT, VIEWED, ACCEPTED, REJECTED, EXPIRED, CONVERTED
  serviceType   String  @db.VarChar(50) // FTL, LTL, PARTIAL, DRAYAGE
  equipmentType String? @db.VarChar(50) // DRY_VAN, REEFER, FLATBED, etc.

  // Dates
  pickupDate          DateTime?
  pickupWindowStart   String?   @db.VarChar(10)
  pickupWindowEnd     String?   @db.VarChar(10)
  deliveryDate        DateTime?
  deliveryWindowStart String?   @db.VarChar(10)
  deliveryWindowEnd   String?   @db.VarChar(10)
  isFlexibleDates     Boolean   @default(false)

  // Cargo
  commodity      String?  @db.VarChar(255)
  weightLbs      Decimal? @db.Decimal(10, 2)
  pieces         Int?
  pallets        Int?
  dimensions     Json? // {length, width, height, unit}
  isHazmat       Boolean  @default(false)
  hazmatClass    String?  @db.VarChar(20)
  temperatureMin Decimal? @db.Decimal(5, 2)
  temperatureMax Decimal? @db.Decimal(5, 2)

  // Pricing
  totalMiles        Decimal? @db.Decimal(10, 2)
  linehaulRate      Decimal? @db.Decimal(12, 2)
  fuelSurcharge     Decimal? @db.Decimal(12, 2)
  accessorialsTotal Decimal? @db.Decimal(12, 2)
  totalAmount       Decimal  @db.Decimal(12, 2)
  marginAmount      Decimal? @db.Decimal(12, 2)
  marginPercent     Decimal? @db.Decimal(5, 2)
  currency          String   @default("USD") @db.VarChar(3)

  // Rate source
  rateSource     String?  @db.VarChar(50) // MANUAL, CONTRACT, MARKET, CALCULATED
  marketRateLow  Decimal? @db.Decimal(12, 2)
  marketRateAvg  Decimal? @db.Decimal(12, 2)
  marketRateHigh Decimal? @db.Decimal(12, 2)

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Conversion
  convertedOrderId String?
  convertedAt      DateTime?

  // Tracking
  sentAt          DateTime?
  viewedAt        DateTime?
  respondedAt     DateTime?
  rejectionReason String?   @db.Text

  // Notes
  internalNotes       String? @db.Text
  customerNotes       String? @db.Text
  specialInstructions String? @db.Text

  salesRepId String?

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentQuote  Quote?             @relation("QuoteVersions", fields: [parentQuoteId], references: [id], onDelete: SetNull)
  childQuotes  Quote[]            @relation("QuoteVersions")
  company      Company?           @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact      Contact?           @relation(fields: [contactId], references: [id], onDelete: SetNull)
  salesRep     User?              @relation("QuoteSalesRep", fields: [salesRepId], references: [id], onDelete: SetNull)
  stops        QuoteStop[]
  accessorials QuoteAccessorial[]

  // TMS Core Relations
  orders       Order[]
  quoteRequest QuoteRequest?

  @@unique([tenantId, quoteNumber, version])
  @@index([tenantId])
  @@index([status])
  @@index([companyId])
  @@index([salesRepId])
  @@index([pickupDate])
  @@index([externalId, sourceSystem])
}

model QuoteStop {
  id                  String   @id @default(cuid())
  tenantId            String
  quoteId             String
  stopSequence        Int
  stopType            String   @db.VarChar(20) // PICKUP, DELIVERY
  facilityName        String?  @db.VarChar(255)
  addressLine1        String   @db.VarChar(255)
  addressLine2        String?  @db.VarChar(255)
  city                String   @db.VarChar(100)
  state               String   @db.VarChar(50)
  postalCode          String   @db.VarChar(20)
  country             String   @default("USA") @db.VarChar(3)
  latitude            Decimal? @db.Decimal(10, 7)
  longitude           Decimal? @db.Decimal(10, 7)
  contactName         String?  @db.VarChar(255)
  contactPhone        String?  @db.VarChar(50)
  contactEmail        String?  @db.VarChar(255)
  appointmentRequired Boolean  @default(false)
  earliestTime        String?  @db.VarChar(10)
  latestTime          String?  @db.VarChar(10)
  instructions        String?  @db.Text
  milesToNext         Decimal? @db.Decimal(10, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, stopSequence])
  @@index([quoteId])
}

model QuoteAccessorial {
  id              String  @id @default(cuid())
  tenantId        String
  quoteId         String
  accessorialType String  @db.VarChar(50)
  description     String? @db.VarChar(255)
  quantity        Decimal @default(1) @db.Decimal(10, 2)
  unitRate        Decimal @db.Decimal(10, 2)
  totalAmount     Decimal @db.Decimal(12, 2)
  isBillable      Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model RateContract {
  id                          String   @id @default(cuid())
  tenantId                    String
  contractNumber              String   @db.VarChar(50)
  name                        String   @db.VarChar(255)
  companyId                   String
  status                      String   @default("ACTIVE") @db.VarChar(50) // DRAFT, ACTIVE, EXPIRED, TERMINATED
  effectiveDate               DateTime
  expirationDate              DateTime
  paymentTerms                String?  @db.VarChar(50)
  autoRenew                   Boolean  @default(false)
  renewalNoticeDays           Int      @default(30)
  defaultFuelSurchargeType    String?  @db.VarChar(50) // DOE_NATIONAL, DOE_REGIONAL, CUSTOM
  defaultFuelSurchargePercent Decimal? @db.Decimal(5, 2)
  minimumMarginPercent        Decimal? @db.Decimal(5, 2)
  notes                       String?  @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  laneRates        ContractLaneRate[]
  accessorialRates AccessorialRate[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([effectiveDate])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model ContractLaneRate {
  id                     String    @id @default(cuid())
  tenantId               String
  contractId             String
  originCity             String?   @db.VarChar(100)
  originState            String?   @db.VarChar(50)
  originZip              String?   @db.VarChar(20)
  originZone             String?   @db.VarChar(50)
  originRadiusMiles      Int?
  destinationCity        String?   @db.VarChar(100)
  destinationState       String?   @db.VarChar(50)
  destinationZip         String?   @db.VarChar(20)
  destinationZone        String?   @db.VarChar(50)
  destinationRadiusMiles Int?
  serviceType            String?   @db.VarChar(50) // FTL, LTL, PARTIAL
  equipmentType          String?   @db.VarChar(50)
  rateType               String    @db.VarChar(50) // PER_MILE, FLAT, PER_CWT
  rateAmount             Decimal   @db.Decimal(12, 2)
  minimumCharge          Decimal?  @db.Decimal(12, 2)
  fuelIncluded           Boolean   @default(false)
  fuelSurchargeType      String?   @db.VarChar(50)
  fuelSurchargePercent   Decimal?  @db.Decimal(5, 2)
  volumeMin              Int?
  volumeMax              Int?
  effectiveDate          DateTime?
  expirationDate         DateTime?
  notes                  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract RateContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([originState, originCity])
  @@index([destinationState, destinationCity])
}

model AccessorialRate {
  id                    String   @id @default(cuid())
  tenantId              String
  contractId            String? // NULL for tenant-wide defaults
  accessorialType       String   @db.VarChar(50)
  name                  String   @db.VarChar(255)
  description           String?  @db.Text
  rateType              String   @db.VarChar(50) // FLAT, PER_HOUR, PER_MILE, PERCENT
  rateAmount            Decimal  @db.Decimal(10, 2)
  minimumCharge         Decimal? @db.Decimal(10, 2)
  maximumCharge         Decimal? @db.Decimal(10, 2)
  appliesToServiceTypes String[] @db.VarChar(50) // FTL, LTL, etc.
  isDefault             Boolean  @default(false)
  status                String   @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract RateContract? @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([accessorialType])
}

model SalesQuota {
  id                 String   @id @default(cuid())
  tenantId           String
  userId             String
  periodType         String   @db.VarChar(20) // MONTHLY, QUARTERLY, ANNUAL
  periodStart        DateTime
  periodEnd          DateTime
  revenueTarget      Decimal? @db.Decimal(14, 2)
  loadsTarget        Int?
  newCustomersTarget Int?
  revenueActual      Decimal  @default(0) @db.Decimal(14, 2)
  loadsActual        Int      @default(0)
  newCustomersActual Int      @default(0)
  status             String   @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, periodStart])
  @@index([tenantId])
  @@index([userId])
  @@index([periodStart, periodEnd])
}

// ============================================================================
// TMS CORE SERVICE (Service 04)
// ============================================================================

model Order {
  id                String  @id @default(cuid())
  tenantId          String
  orderNumber       String  @db.VarChar(50)
  customerReference String? @db.VarChar(100)
  poNumber          String? @db.VarChar(100)
  bolNumber         String? @db.VarChar(100)
  customerId        String
  customerContactId String?
  quoteId           String?
  salesRepId        String?

  status String @default("PENDING") @db.VarChar(30) // PENDING, QUOTED, BOOKED, DISPATCHED, IN_TRANSIT, DELIVERED, INVOICED, COMPLETED, CANCELLED

  // Pricing
  customerRate       Decimal? @db.Decimal(10, 2)
  accessorialCharges Decimal  @default(0) @db.Decimal(10, 2)
  fuelSurcharge      Decimal  @default(0) @db.Decimal(10, 2)
  totalCharges       Decimal? @db.Decimal(10, 2)
  currency           String   @default("USD") @db.VarChar(3)

  // Cargo
  commodity      String?  @db.VarChar(255)
  commodityClass String?  @db.VarChar(10)
  weightLbs      Decimal? @db.Decimal(10, 2)
  pieceCount     Int?
  palletCount    Int?
  equipmentType  String?  @db.VarChar(30)

  // Hazmat
  isHazmat    Boolean @default(false)
  hazmatClass String? @db.VarChar(20)

  // Temperature
  temperatureMin Decimal? @db.Decimal(5, 2)
  temperatureMax Decimal? @db.Decimal(5, 2)

  // Dates
  orderDate            DateTime  @default(now())
  requiredDeliveryDate DateTime?
  actualDeliveryDate   DateTime?

  // Notes
  specialInstructions String? @db.Text
  internalNotes       String? @db.Text

  // Flags
  isHot       Boolean @default(false)
  isTeam      Boolean @default(false)
  isExpedited Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer        Company         @relation("OrderCustomer", fields: [customerId], references: [id], onDelete: Restrict)
  customerContact Contact?        @relation("OrderContact", fields: [customerContactId], references: [id], onDelete: SetNull)
  quote           Quote?          @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  salesRep        User?           @relation("OrderSalesRep", fields: [salesRepId], references: [id], onDelete: SetNull)
  loads           Load[]
  stops           Stop[]
  items           OrderItem[]
  statusHistory   StatusHistory[]

  // Accounting Relations
  invoices         Invoice[]
  invoiceLineItems InvoiceLineItem[]

  // Commission Relations
  commissionEntries CommissionEntry[]

  // Documents Relations
  documents        Document[]
  agentCommissions AgentCommission[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([externalId, sourceSystem])
}

model Load {
  id         String  @id @default(cuid())
  tenantId   String
  loadNumber String  @db.VarChar(50)
  orderId    String
  carrierId  String?

  // Driver info
  driverName    String? @db.VarChar(100)
  driverPhone   String? @db.VarChar(20)
  truckNumber   String? @db.VarChar(20)
  trailerNumber String? @db.VarChar(20)

  status String @default("PENDING") @db.VarChar(30) // PENDING, TENDERED, ACCEPTED, AT_PICKUP, PICKED_UP, IN_TRANSIT, AT_DELIVERY, DELIVERED, COMPLETED

  // Pricing
  carrierRate      Decimal? @db.Decimal(10, 2)
  accessorialCosts Decimal  @default(0) @db.Decimal(10, 2)
  fuelAdvance      Decimal  @default(0) @db.Decimal(10, 2)
  totalCost        Decimal? @db.Decimal(10, 2)

  // Tracking
  currentLocationLat Decimal?  @db.Decimal(10, 7)
  currentLocationLng Decimal?  @db.Decimal(10, 7)
  currentCity        String?   @db.VarChar(100)
  currentState       String?   @db.VarChar(50)
  lastTrackingUpdate DateTime?
  eta                DateTime?

  // Equipment
  equipmentType        String? @db.VarChar(30)
  equipmentLength      Int?
  equipmentWeightLimit Int?

  // Timestamps
  dispatchedAt DateTime?
  pickedUpAt   DateTime?
  deliveredAt  DateTime?

  // Rate confirmation
  rateConfirmationSent   Boolean @default(false)
  rateConfirmationSigned Boolean @default(false)

  dispatchNotes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  carrier       Carrier?        @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  stops         Stop[]
  checkCalls    CheckCall[]
  statusHistory StatusHistory[]

  // Accounting Relations
  invoices            Invoice[]
  invoiceLineItems    InvoiceLineItem[]
  settlementLineItems SettlementLineItem[]

  // Load Board Relations
  postings LoadPosting[]
  bids     LoadBid[]
  tenders  LoadTender[]

  // Commission Relations
  commissionEntries CommissionEntry[]

  // Documents Relations
  documents                 Document[]
  carrierPortalDocuments    CarrierPortalDocument[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]
  carrierQuickPayRequests   CarrierQuickPayRequest[]
  agentCommissions          AgentCommission[]

  @@unique([tenantId, loadNumber])
  @@index([tenantId])
  @@index([orderId])
  @@index([carrierId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Stop {
  id           String  @id @default(cuid())
  tenantId     String
  orderId      String
  loadId       String?
  stopType     String  @db.VarChar(20) // PICKUP, DELIVERY, STOP
  stopSequence Int

  // Location
  facilityName String?  @db.VarChar(255)
  addressLine1 String   @db.VarChar(255)
  addressLine2 String?  @db.VarChar(255)
  city         String   @db.VarChar(100)
  state        String   @db.VarChar(50)
  postalCode   String   @db.VarChar(20)
  country      String   @default("USA") @db.VarChar(50)
  latitude     Decimal? @db.Decimal(10, 7)
  longitude    Decimal? @db.Decimal(10, 7)

  // Contact
  contactName  String? @db.VarChar(100)
  contactPhone String? @db.VarChar(20)
  contactEmail String? @db.VarChar(255)

  // Appointment
  appointmentRequired  Boolean   @default(false)
  appointmentDate      DateTime?
  appointmentTimeStart String?   @db.VarChar(10)
  appointmentTimeEnd   String?   @db.VarChar(10)
  appointmentNumber    String?   @db.VarChar(50)

  status     String    @default("PENDING") @db.VarChar(20) // PENDING, EN_ROUTE, ARRIVED, LOADING, COMPLETED
  arrivedAt  DateTime?
  departedAt DateTime?

  // Cargo at stop
  weightLbs   Decimal? @db.Decimal(10, 2)
  pieceCount  Int?
  palletCount Int?

  // Instructions
  specialInstructions String? @db.Text
  driverInstructions  String? @db.Text
  accessorials        Json    @default("[]")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  load          Load?           @relation(fields: [loadId], references: [id], onDelete: SetNull)
  items         OrderItem[]
  statusHistory StatusHistory[]

  @@unique([orderId, stopSequence])
  @@index([tenantId])
  @@index([orderId])
  @@index([loadId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model OrderItem {
  id               String   @id @default(cuid())
  tenantId         String
  orderId          String
  stopId           String?
  description      String   @db.VarChar(255)
  quantity         Int      @default(1)
  quantityType     String?  @db.VarChar(20) // PIECES, PALLETS, SKIDS, CRATES
  weightLbs        Decimal? @db.Decimal(10, 2)
  dimensionsLength Int?
  dimensionsWidth  Int?
  dimensionsHeight Int?
  commodityClass   String?  @db.VarChar(10)
  nmfcCode         String?  @db.VarChar(20)
  isHazmat         Boolean  @default(false)
  hazmatClass      String?  @db.VarChar(20)
  unNumber         String?  @db.VarChar(20)
  sku              String?  @db.VarChar(100)
  lotNumber        String?  @db.VarChar(100)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  stop   Stop?  @relation(fields: [stopId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([orderId])
  @@index([stopId])
  @@index([externalId, sourceSystem])
}

model CheckCall {
  id             String    @id @default(cuid())
  tenantId       String
  loadId         String
  city           String?   @db.VarChar(100)
  state          String?   @db.VarChar(50)
  latitude       Decimal?  @db.Decimal(10, 7)
  longitude      Decimal?  @db.Decimal(10, 7)
  status         String?   @db.VarChar(30)
  notes          String?   @db.Text
  contacted      String?   @db.VarChar(50) // DRIVER, DISPATCHER, TRACKING_SYSTEM
  contactMethod  String?   @db.VarChar(20) // PHONE, TEXT, APP, GPS
  eta            DateTime?
  milesRemaining Int?
  source         String?   @db.VarChar(30) // MANUAL, MACROPOINT, ELD, DRIVER_APP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load   Load   @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([loadId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model StatusHistory {
  id         String  @id @default(cuid())
  tenantId   String
  entityType String  @db.VarChar(20) // ORDER, LOAD, STOP
  entityId   String
  oldStatus  String? @db.VarChar(30)
  newStatus  String  @db.VarChar(30)
  notes      String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])
  orderId String?
  load    Load?   @relation(fields: [loadId], references: [id])
  loadId  String?
  stop    Stop?   @relation(fields: [stopId], references: [id])
  stopId  String?

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ============================================================================
// CARRIER SERVICE (Service 05)
// ============================================================================

model Carrier {
  id          String  @id @default(cuid())
  tenantId    String
  mcNumber    String? @db.VarChar(20)
  dotNumber   String? @db.VarChar(20)
  scacCode    String? @db.VarChar(10)
  carrierCode String? @db.VarChar(50)
  legalName   String  @db.VarChar(255)
  dbaName     String? @db.VarChar(255)
  companyType String? @db.VarChar(50) // CARRIER, OWNER_OPERATOR, BROKER, ASSET_BASED

  // Primary contact
  primaryContactName  String? @db.VarChar(255)
  primaryContactEmail String? @db.VarChar(255)
  primaryContactPhone String? @db.VarChar(50)
  dispatchEmail       String? @db.VarChar(255)
  dispatchPhone       String? @db.VarChar(50)
  afterHoursPhone     String? @db.VarChar(50)

  // Address
  addressLine1 String? @db.VarChar(255)
  addressLine2 String? @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(50)
  postalCode   String? @db.VarChar(20)
  country      String  @default("USA") @db.VarChar(3)

  // Tax & Banking
  taxId                String?  @db.VarChar(50)
  w9OnFile             Boolean  @default(false)
  taxClassification    String?  @db.VarChar(50)
  paymentTerms         String?  @db.VarChar(50) // QUICK_PAY, NET30, NET15
  quickPayFeePercent   Decimal? @db.Decimal(5, 2)
  factoringCompany     String?  @db.VarChar(255)
  factoringAccount     String?  @db.VarChar(100)
  bankName             String?  @db.VarChar(255)
  bankRoutingNumber    String?  @db.VarChar(50)
  bankAccountNumberEnc String?  @db.VarChar(255) // Encrypted
  bankAccountType      String?  @db.VarChar(20) // CHECKING, SAVINGS

  // Equipment & Service
  equipmentTypes String[] @db.VarChar(50)
  truckCount     Int?
  trailerCount   Int?
  serviceStates  String[] @db.VarChar(3)
  preferredLanes Json     @default("[]") // [{origin_state, dest_state}]

  // Status & Qualification
  status            String    @default("PENDING") @db.VarChar(50) // PENDING, ACTIVE, SUSPENDED, INACTIVE, BLACKLISTED
  qualificationTier String?   @db.VarChar(20) // PLATINUM, GOLD, SILVER, BRONZE, UNQUALIFIED
  qualificationDate DateTime?

  // FMCSA Data
  fmcsaAuthorityStatus   String?   @db.VarChar(50)
  fmcsaCommonAuthority   Boolean?
  fmcsaContractAuthority Boolean?
  fmcsaBrokerAuthority   Boolean?
  fmcsaSafetyRating      String?   @db.VarChar(50)
  fmcsaOutOfService      Boolean   @default(false)
  fmcsaLastChecked       DateTime?

  // Performance Metrics
  complianceScore    Int? // 0-100
  safetyScore        Int? // 0-100
  totalLoads         Int      @default(0)
  onTimePickupRate   Decimal? @db.Decimal(5, 2)
  onTimeDeliveryRate Decimal? @db.Decimal(5, 2)
  claimsRate         Decimal? @db.Decimal(5, 2)
  avgRating          Decimal? @db.Decimal(3, 2)

  // Communication
  preferredLanguage       String  @default("en") @db.VarChar(10)
  communicationPreference String? @db.VarChar(20) // EMAIL, PHONE, SMS, APP

  // Notes
  internalNotes   String? @db.Text
  onboardingNotes String? @db.Text

  // Migration support
  externalId   String?  @db.VarChar(255)
  sourceSystem String?  @db.VarChar(100)
  customFields Json     @default("{}")
  tags         String[] @db.VarChar(100)

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant                Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts              CarrierContact[]
  drivers               Driver[]
  insuranceCertificates InsuranceCertificate[]
  documents             CarrierDocument[]
  performanceHistory    CarrierPerformanceHistory[]
  complianceLogs        FmcsaComplianceLog[]
  loads                 Load[]

  // Accounting Relations
  settlements  Settlement[]
  paymentsMade PaymentMade[]

  // Load Board Relations
  loadViews        CarrierLoadView[]
  loadBids         LoadBid[]
  tendersAccepted  LoadTender[]
  tenderRecipients TenderRecipient[]

  // Documents Relations
  carrierDocuments Document[]

  // Additional Relations
  capacities         CarrierCapacity[]
  portalUsers        CarrierPortalUser[]
  portalSessions     CarrierPortalSession[]
  portalDocuments    CarrierPortalDocument[]
  invoiceSubmissions CarrierInvoiceSubmission[]
  quickPayRequests   CarrierQuickPayRequest[]
  portalActivityLogs CarrierPortalActivityLog[]
  contracts          Contract[]
  noaRecords         NOARecord[]
  factoringStatus    CarrierFactoringStatus?

  @@unique([tenantId, mcNumber])
  @@unique([tenantId, dotNumber])
  @@index([tenantId])
  @@index([mcNumber])
  @@index([dotNumber])
  @@index([scacCode])
  @@index([status])
  @@index([qualificationTier])
  @@index([equipmentTypes])
  @@index([serviceStates])
  @@index([externalId, sourceSystem])
}

model CarrierContact {
  id                   String  @id @default(cuid())
  tenantId             String
  carrierId            String
  firstName            String  @db.VarChar(100)
  lastName             String  @db.VarChar(100)
  title                String? @db.VarChar(100)
  role                 String? @db.VarChar(50) // OWNER, DISPATCHER, ACCOUNTING, SAFETY, DRIVER
  email                String? @db.VarChar(255)
  phone                String? @db.VarChar(50)
  mobile               String? @db.VarChar(50)
  isPrimary            Boolean @default(false)
  receivesRateConfirms Boolean @default(false)
  receivesPodRequests  Boolean @default(false)
  receivesPayments     Boolean @default(false)
  preferredLanguage    String  @default("en") @db.VarChar(10)
  isActive             Boolean @default(true)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([carrierId])
  @@index([isPrimary])
  @@index([role])
  @@index([isActive])
}

model Driver {
  id            String    @id @default(cuid())
  tenantId      String
  carrierId     String
  firstName     String    @db.VarChar(100)
  lastName      String    @db.VarChar(100)
  email         String?   @db.VarChar(255)
  phone         String?   @db.VarChar(50)
  cdlNumber     String?   @db.VarChar(50)
  cdlState      String?   @db.VarChar(3)
  cdlExpiration DateTime?
  cdlClass      String?   @db.VarChar(5) // A, B, C
  endorsements  String[]  @db.VarChar(20) // H, N, P, S, T, X
  status        String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, INACTIVE, SUSPENDED

  // Location tracking
  currentLocationLat Decimal?  @db.Decimal(10, 7)
  currentLocationLng Decimal?  @db.Decimal(10, 7)
  locationUpdatedAt  DateTime?

  // Performance
  totalLoads Int      @default(0)
  onTimeRate Decimal? @db.Decimal(5, 2)
  avgRating  Decimal? @db.Decimal(3, 2)

  // Integration
  preferredLanguage String  @default("en") @db.VarChar(10)
  appUserId         String?
  eldProvider       String? @db.VarChar(50)
  eldDriverId       String? @db.VarChar(100)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([tenantId, carrierId, cdlNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([status])
  @@index([cdlExpiration])
  @@index([externalId, sourceSystem])
}

model InsuranceCertificate {
  id                    String    @id @default(cuid())
  tenantId              String
  carrierId             String
  insuranceType         String    @db.VarChar(50) // AUTO_LIABILITY, CARGO, GENERAL_LIABILITY, WORKERS_COMP
  policyNumber          String?   @db.VarChar(100)
  insuranceCompany      String    @db.VarChar(255)
  coverageAmount        Decimal   @db.Decimal(14, 2)
  deductible            Decimal?  @db.Decimal(12, 2)
  effectiveDate         DateTime
  expirationDate        DateTime
  certificateHolderName String?   @db.VarChar(255)
  additionalInsured     Boolean   @default(false)
  documentUrl           String?   @db.VarChar(500)
  status                String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, EXPIRING_SOON, EXPIRED, CANCELLED
  verified              Boolean   @default(false)
  verifiedById          String?
  verifiedAt            DateTime?
  expirationNotified30  Boolean   @default(false)
  expirationNotified14  Boolean   @default(false)
  expirationNotified7   Boolean   @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([carrierId, insuranceType, policyNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([insuranceType])
  @@index([expirationDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierDocument {
  id              String    @id @default(cuid())
  tenantId        String
  carrierId       String
  documentType    String    @db.VarChar(50) // W9, CARRIER_AGREEMENT, AUTHORITY_LETTER, VOID_CHECK, OTHER
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  filePath        String?   @db.VarChar(500)
  fileSize        Int?
  mimeType        String?   @db.VarChar(100)
  status          String    @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED, EXPIRED
  reviewedById    String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text
  expirationDate  DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([documentType])
  @@index([status])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model CarrierPerformanceHistory {
  id                  String   @id @default(cuid())
  tenantId            String
  carrierId           String
  periodType          String   @db.VarChar(20) // WEEKLY, MONTHLY, QUARTERLY
  periodStart         DateTime
  periodEnd           DateTime
  loadsCompleted      Int      @default(0)
  loadsCancelled      Int      @default(0)
  onTimePickups       Int      @default(0)
  onTimeDeliveries    Int      @default(0)
  latePickups         Int      @default(0)
  lateDeliveries      Int      @default(0)
  claimsCount         Int      @default(0)
  claimsAmount        Decimal  @default(0) @db.Decimal(12, 2)
  onTimePickupRate    Decimal? @db.Decimal(5, 2)
  onTimeDeliveryRate  Decimal? @db.Decimal(5, 2)
  claimsRate          Decimal? @db.Decimal(5, 2)
  totalPaid           Decimal  @default(0) @db.Decimal(14, 2)
  avgRatePerMile      Decimal? @db.Decimal(8, 2)
  avgDispatcherRating Decimal? @db.Decimal(3, 2)
  avgCustomerRating   Decimal? @db.Decimal(3, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([carrierId, periodType, periodStart])
  @@index([tenantId])
  @@index([carrierId])
  @@index([periodType])
  @@index([periodStart])
}

model FmcsaComplianceLog {
  id                   String   @id @default(cuid())
  tenantId             String
  carrierId            String
  checkedAt            DateTime @default(now())
  dotNumber            String?  @db.VarChar(20)
  mcNumber             String?  @db.VarChar(20)
  authorityStatus      String?  @db.VarChar(50)
  commonAuthority      Boolean?
  contractAuthority    Boolean?
  brokerAuthority      Boolean?
  safetyRating         String?  @db.VarChar(50)
  outOfService         Boolean?
  driverInspections    Int?
  driverOosRate        Decimal? @db.Decimal(5, 2)
  vehicleInspections   Int?
  vehicleOosRate       Decimal? @db.Decimal(5, 2)
  fmcsaInsuranceOnFile Boolean?
  fmcsaInsuranceAmount Decimal? @db.Decimal(14, 2)
  changesDetected      Json     @default("[]") // [{field, old_value, new_value}]
  rawResponse          Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([checkedAt])
  @@index([dotNumber])
  @@index([mcNumber])
  @@index([externalId, sourceSystem])
}

// ============================================================================
// ACCOUNTING SERVICE (Service 06)
// ============================================================================

model ChartOfAccount {
  id              String  @id @default(cuid())
  tenantId        String
  accountNumber   String  @db.VarChar(20)
  accountName     String  @db.VarChar(255)
  accountType     String  @db.VarChar(50) // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  accountSubType  String? @db.VarChar(50) // BANK, AR, AP, REVENUE, EXPENSE, etc.
  parentAccountId String?
  description     String? @db.Text
  normalBalance   String  @db.VarChar(10) // DEBIT, CREDIT
  isActive        Boolean @default(true)
  isSystemAccount Boolean @default(false)
  balance         Decimal @default(0) @db.Decimal(14, 2)

  // QuickBooks sync
  quickbooksId String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentAccount ChartOfAccount?  @relation("AccountHierarchy", fields: [parentAccountId], references: [id], onDelete: SetNull)
  childAccounts ChartOfAccount[] @relation("AccountHierarchy")

  // Invoice relations
  invoiceRevenueAccounts Invoice[] @relation("InvoiceRevenueAccount")
  invoiceArAccounts      Invoice[] @relation("InvoiceArAccount")

  // Invoice line relations
  invoiceLineAccounts InvoiceLineItem[] @relation("InvoiceLineRevenueAccount")

  // Settlement relations
  settlementExpenseAccounts Settlement[] @relation("SettlementExpenseAccount")
  settlementApAccounts      Settlement[] @relation("SettlementApAccount")

  // Settlement line relations
  settlementLineAccounts SettlementLineItem[] @relation("SettlementLineExpenseAccount")

  // Payment relations
  paymentsReceivedBank PaymentReceived[] @relation("PaymentReceivedBankAccount")
  paymentsMadeBank     PaymentMade[]     @relation("PaymentMadeBankAccount")

  // Journal entry lines
  journalEntryLines JournalEntryLine[]

  @@unique([tenantId, accountNumber])
  @@index([tenantId])
  @@index([accountType])
  @@index([isActive])
  @@index([parentAccountId])
  @@index([externalId, sourceSystem])
}

model Invoice {
  id            String  @id @default(cuid())
  tenantId      String
  invoiceNumber String  @db.VarChar(50)
  companyId     String
  orderId       String?
  loadId        String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Dates
  invoiceDate DateTime
  dueDate     DateTime
  sentAt      DateTime?

  // Amounts
  subtotal    Decimal @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @db.Decimal(12, 2)
  totalAmount Decimal @db.Decimal(12, 2)
  amountPaid  Decimal @default(0) @db.Decimal(12, 2)
  balanceDue  Decimal @db.Decimal(12, 2)
  currency    String  @default("USD") @db.VarChar(3)

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, SENT, VIEWED, PARTIAL, PAID, OVERDUE, VOID

  // Terms
  paymentTerms String? @db.VarChar(50)

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Aging
  daysOutstanding Int?
  agingBucket     String? @db.VarChar(20) // CURRENT, 1-30, 31-60, 61-90, 90+

  // Collection
  lastReminderDate DateTime?
  reminderCount    Int       @default(0)
  collectionStatus String?   @db.VarChar(50)

  // GL Accounts
  revenueAccountId String?
  arAccountId      String?

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  updatedById String?
  voidedAt    DateTime?
  voidedById  String?
  voidReason  String?   @db.Text

  // Custom fields
  customFields Json @default("{}")

  // Relations
  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company        Company              @relation(fields: [companyId], references: [id])
  order          Order?               @relation(fields: [orderId], references: [id])
  load           Load?                @relation(fields: [loadId], references: [id])
  revenueAccount ChartOfAccount?      @relation("InvoiceRevenueAccount", fields: [revenueAccountId], references: [id])
  arAccount      ChartOfAccount?      @relation("InvoiceArAccount", fields: [arAccountId], references: [id])
  lineItems      InvoiceLineItem[]
  applications   PaymentApplication[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@index([orderId])
  @@index([loadId])
  @@index([externalId, sourceSystem])
}

model InvoiceLineItem {
  id        String  @id @default(cuid())
  tenantId  String
  invoiceId String
  loadId    String?
  orderId   String?

  // Line details
  lineNumber  Int
  description String  @db.VarChar(500)
  itemType    String? @db.VarChar(50) // FREIGHT, ACCESSORIAL, ADJUSTMENT

  // Amounts
  quantity  Decimal @default(1) @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  amount    Decimal @db.Decimal(12, 2)

  // GL
  revenueAccountId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice        Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  load           Load?           @relation(fields: [loadId], references: [id])
  order          Order?          @relation(fields: [orderId], references: [id])
  revenueAccount ChartOfAccount? @relation("InvoiceLineRevenueAccount", fields: [revenueAccountId], references: [id])

  @@unique([invoiceId, lineNumber])
  @@index([tenantId])
  @@index([invoiceId])
  @@index([loadId])
  @@index([orderId])
  @@index([externalId, sourceSystem])
}

model Settlement {
  id               String @id @default(cuid())
  tenantId         String
  settlementNumber String @db.VarChar(50)
  carrierId        String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Dates
  settlementDate DateTime
  dueDate        DateTime

  // Payment method
  paymentType        String?  @db.VarChar(50) // QUICK_PAY, NET30, FACTORING
  quickPayFeePercent Decimal? @db.Decimal(5, 2)
  quickPayFeeAmount  Decimal? @db.Decimal(12, 2)

  // Amounts
  grossAmount     Decimal @db.Decimal(12, 2)
  deductionsTotal Decimal @default(0) @db.Decimal(12, 2)
  quickPayFee     Decimal @default(0) @db.Decimal(12, 2)
  netAmount       Decimal @db.Decimal(12, 2)
  amountPaid      Decimal @default(0) @db.Decimal(12, 2)
  balanceDue      Decimal @db.Decimal(12, 2)
  currency        String  @default("USD") @db.VarChar(3)

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, PENDING, APPROVED, PARTIAL, PAID, VOID

  // Payment destination
  paymentMethod      String? @db.VarChar(50) // CHECK, ACH, WIRE
  payToName          String? @db.VarChar(255)
  payToFactoring     Boolean @default(false)
  factoringCompanyId String?
  factoringAccount   String? @db.VarChar(100)

  // GL Accounts
  expenseAccountId String?
  apAccountId      String?

  // Approval
  approvedById String?
  approvedAt   DateTime?

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Custom fields
  customFields Json @default("{}")

  // Relations
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier                   Carrier                    @relation(fields: [carrierId], references: [id])
  expenseAccount            ChartOfAccount?            @relation("SettlementExpenseAccount", fields: [expenseAccountId], references: [id])
  apAccount                 ChartOfAccount?            @relation("SettlementApAccount", fields: [apAccountId], references: [id])
  lineItems                 SettlementLineItem[]
  carrierInvoiceSubmissions CarrierInvoiceSubmission[]

  @@unique([tenantId, settlementNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([status])
  @@index([dueDate])
  @@index([settlementDate])
  @@index([externalId, sourceSystem])
}

model SettlementLineItem {
  id           String  @id @default(cuid())
  tenantId     String
  settlementId String
  loadId       String?

  // Line details
  lineNumber  Int
  description String  @db.VarChar(500)
  itemType    String? @db.VarChar(50) // FREIGHT, ACCESSORIAL, DEDUCTION, ADVANCE

  // Amounts
  quantity Decimal @default(1) @db.Decimal(10, 2)
  unitRate Decimal @db.Decimal(12, 2)
  amount   Decimal @db.Decimal(12, 2)

  // GL
  expenseAccountId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settlement     Settlement      @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  load           Load?           @relation(fields: [loadId], references: [id])
  expenseAccount ChartOfAccount? @relation("SettlementLineExpenseAccount", fields: [expenseAccountId], references: [id])

  @@unique([settlementId, lineNumber])
  @@index([tenantId])
  @@index([settlementId])
  @@index([loadId])
  @@index([externalId, sourceSystem])
}

model PaymentReceived {
  id            String @id @default(cuid())
  tenantId      String
  paymentNumber String @db.VarChar(50)
  companyId     String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Payment details
  paymentDate   DateTime
  paymentMethod String   @db.VarChar(50) // CHECK, ACH, WIRE, CREDIT_CARD, CASH

  // Amount
  amount          Decimal @db.Decimal(12, 2)
  unappliedAmount Decimal @default(0) @db.Decimal(12, 2)
  currency        String  @default("USD") @db.VarChar(3)

  // Reference
  referenceNumber String? @db.VarChar(100)

  // Bank
  bankAccountId String?
  depositDate   DateTime?

  // Status
  status String @default("RECEIVED") @db.VarChar(50) // RECEIVED, APPLIED, PARTIAL, BOUNCED, REFUNDED

  // Notes
  notes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company      Company              @relation(fields: [companyId], references: [id])
  bankAccount  ChartOfAccount?      @relation("PaymentReceivedBankAccount", fields: [bankAccountId], references: [id])
  applications PaymentApplication[]

  @@unique([tenantId, paymentNumber])
  @@index([tenantId])
  @@index([companyId])
  @@index([paymentDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model PaymentApplication {
  id        String  @id @default(cuid())
  tenantId  String
  paymentId String
  invoiceId String
  amount    Decimal @db.Decimal(12, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment PaymentReceived @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice         @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([paymentId])
  @@index([invoiceId])
  @@index([externalId, sourceSystem])
}

model PaymentMade {
  id            String @id @default(cuid())
  tenantId      String
  paymentNumber String @db.VarChar(50)
  carrierId     String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Payment details
  paymentDate   DateTime
  paymentMethod String   @db.VarChar(50) // CHECK, ACH, WIRE

  // Amount
  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("USD") @db.VarChar(3)

  // Reference
  referenceNumber String? @db.VarChar(100)

  // Bank
  bankAccountId String?

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, SENT, CLEARED, VOID

  // ACH/Wire details
  achBatchId     String? @db.VarChar(100)
  achTraceNumber String? @db.VarChar(100)

  // Notes
  notes String? @db.Text

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier     Carrier         @relation(fields: [carrierId], references: [id])
  bankAccount ChartOfAccount? @relation("PaymentMadeBankAccount", fields: [bankAccountId], references: [id])

  @@unique([tenantId, paymentNumber])
  @@index([tenantId])
  @@index([carrierId])
  @@index([paymentDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model JournalEntry {
  id          String @id @default(cuid())
  tenantId    String
  entryNumber String @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  quickbooksId String? @db.VarChar(50)

  // Details
  entryDate   DateTime
  description String?  @db.Text

  // Reference
  referenceType String? @db.VarChar(50) // INVOICE, SETTLEMENT, PAYMENT, MANUAL
  referenceId   String?

  // Status
  status String @default("DRAFT") @db.VarChar(50) // DRAFT, POSTED, VOID

  // Amounts (must balance)
  totalDebit  Decimal @db.Decimal(14, 2)
  totalCredit Decimal @db.Decimal(14, 2)

  // Posting
  postedById String?
  postedAt   DateTime?

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines  JournalEntryLine[]

  @@unique([tenantId, entryNumber])
  @@index([tenantId])
  @@index([entryDate])
  @@index([referenceType, referenceId])
  @@index([status])
}

model JournalEntryLine {
  id             String @id @default(cuid())
  tenantId       String
  journalEntryId String
  lineNumber     Int
  accountId      String

  description  String? @db.VarChar(255)
  debitAmount  Decimal @default(0) @db.Decimal(14, 2)
  creditAmount Decimal @default(0) @db.Decimal(14, 2)

  // Dimensions (for reporting)
  customerId String?
  carrierId  String?
  loadId     String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  journalEntry JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      ChartOfAccount @relation(fields: [accountId], references: [id])

  @@unique([journalEntryId, lineNumber])
  @@index([tenantId])
  @@index([journalEntryId])
  @@index([accountId])
  @@index([externalId, sourceSystem])
}

model QuickbooksSyncLog {
  id           String  @id @default(cuid())
  tenantId     String
  entityType   String  @db.VarChar(50)
  entityId     String
  quickbooksId String? @db.VarChar(50)

  syncDirection String @db.VarChar(20) // TO_QB, FROM_QB
  syncStatus    String @db.VarChar(20) // SUCCESS, FAILED, PENDING

  payloadSent     Json?
  payloadReceived Json?
  errorMessage    String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  syncedAt    DateTime  @default(now())
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([syncStatus])
  @@index([externalId, sourceSystem])
}

// ==============================================
// LOAD BOARD MODULE
// ==============================================

model LoadPosting {
  id       String @id @default(cuid())
  tenantId String
  loadId   String

  // Posting details
  postingType String @db.VarChar(50) // INTERNAL, EXTERNAL, BOTH
  visibility  String @default("ALL_CARRIERS") @db.VarChar(50) // ALL_CARRIERS, PREFERRED_ONLY, SPECIFIC_CARRIERS

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, BOOKED, EXPIRED, CANCELLED

  // Rate visibility
  showRate   Boolean  @default(false)
  rateType   String?  @db.VarChar(50) // ALL_IN, PER_MILE
  postedRate Decimal? @db.Decimal(12, 2)
  rateMin    Decimal? @db.Decimal(12, 2)
  rateMax    Decimal? @db.Decimal(12, 2)

  // Origin (denormalized for search)
  originCity  String?  @db.VarChar(100)
  originState String?  @db.VarChar(50)
  originZip   String?  @db.VarChar(20)
  originLat   Decimal? @db.Decimal(10, 7)
  originLng   Decimal? @db.Decimal(10, 7)

  // Destination
  destCity  String?  @db.VarChar(100)
  destState String?  @db.VarChar(50)
  destZip   String?  @db.VarChar(20)
  destLat   Decimal? @db.Decimal(10, 7)
  destLng   Decimal? @db.Decimal(10, 7)

  // Load details (denormalized)
  equipmentType String?   @db.VarChar(50)
  totalMiles    Decimal?  @db.Decimal(10, 2)
  weightLbs     Decimal?  @db.Decimal(10, 2)
  pickupDate    DateTime?
  deliveryDate  DateTime?

  // External postings
  datPostingId       String? @db.VarChar(100)
  truckstopPostingId String? @db.VarChar(100)

  // Timing
  postedAt        DateTime  @default(now())
  expiresAt       DateTime?
  autoRefresh     Boolean   @default(true)
  refreshInterval Int       @default(4) // hours
  lastRefreshedAt DateTime?

  // Metrics
  viewCount    Int @default(0)
  inquiryCount Int @default(0)

  // Specific carriers (for SPECIFIC_CARRIERS visibility)
  carrierIds String[] // Array of carrier IDs

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load   Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  views  CarrierLoadView[]
  bids   LoadBid[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([loadId])
  @@index([originState, originCity])
  @@index([destState, destCity])
  @@index([pickupDate])
  @@index([equipmentType])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierLoadView {
  id        String @id @default(cuid())
  tenantId  String
  postingId String
  carrierId String

  viewedAt DateTime @default(now())
  source   String?  @db.VarChar(50) // INTERNAL, DAT, TRUCKSTOP, EMAIL

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  posting LoadPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  carrier Carrier     @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([postingId, carrierId])
  @@index([tenantId])
  @@index([postingId])
  @@index([carrierId])
  @@index([externalId, sourceSystem])
}

model LoadBid {
  id        String @id @default(cuid())
  tenantId  String
  postingId String
  loadId    String
  carrierId String

  // Bid details
  bidAmount Decimal @db.Decimal(12, 2)
  rateType  String? @db.VarChar(50) // ALL_IN, PER_MILE
  notes     String? @db.Text

  // Equipment offered
  truckNumber String? @db.VarChar(50)
  driverName  String? @db.VarChar(255)
  driverPhone String? @db.VarChar(50)

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, ACCEPTED, REJECTED, COUNTERED, EXPIRED, WITHDRAWN

  // Counter offer
  counterAmount Decimal?  @db.Decimal(12, 2)
  counterNotes  String?   @db.Text
  counterAt     DateTime?

  // Resolution
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Timing
  submittedAt DateTime  @default(now())
  expiresAt   DateTime?

  // Source
  source String? @db.VarChar(50) // INTERNAL, CARRIER_PORTAL, DAT, TRUCKSTOP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  posting LoadPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  load    Load        @relation(fields: [loadId], references: [id], onDelete: Cascade)
  carrier Carrier     @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([postingId])
  @@index([carrierId])
  @@index([tenantId, status])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model LoadTender {
  id       String @id @default(cuid())
  tenantId String
  loadId   String

  // Tender settings
  tenderType String  @db.VarChar(50) // BROADCAST, WATERFALL, SPECIFIC
  tenderRate Decimal @db.Decimal(12, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, ACCEPTED, EXPIRED, CANCELLED

  // Timing
  expiresAt DateTime?

  // Waterfall settings
  waterfallTimeoutMinutes Int @default(30)
  currentPosition         Int @default(0)

  // Result
  acceptedByCarrierId String?
  acceptedAt          DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load              Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  acceptedByCarrier Carrier?          @relation(fields: [acceptedByCarrierId], references: [id], onDelete: SetNull)
  recipients        TenderRecipient[]

  @@index([tenantId])
  @@index([loadId])
  @@index([tenantId, status])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model TenderRecipient {
  id        String @id @default(cuid())
  tenantId  String
  tenderId  String
  carrierId String

  // Waterfall position (1 = first to offer)
  position Int

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, OFFERED, ACCEPTED, DECLINED, EXPIRED, SKIPPED

  // Timing
  offeredAt   DateTime?
  respondedAt DateTime?
  expiresAt   DateTime?

  // Response
  declineReason String? @db.Text

  // Notification
  notificationSent   Boolean @default(false)
  notificationMethod String? @db.VarChar(50) // EMAIL, SMS, APP

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tender  LoadTender @relation(fields: [tenderId], references: [id], onDelete: Cascade)
  carrier Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([tenderId, position])
  @@index([tenantId])
  @@index([tenderId])
  @@index([carrierId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// ==============================================
// COMMISSION MODULE
// ==============================================

model CommissionPlan {
  id       String @id @default(cuid())
  tenantId String

  // Plan details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Type
  planType String @db.VarChar(50) // FLAT_FEE, PERCENT_REVENUE, PERCENT_MARGIN, TIERED, CUSTOM

  // Status
  status    String  @default("ACTIVE") @db.VarChar(50) // ACTIVE, INACTIVE
  isDefault Boolean @default(false)

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Base rates
  flatAmount  Decimal? @db.Decimal(10, 2)
  percentRate Decimal? @db.Decimal(5, 2)

  // Basis
  calculationBasis String? @db.VarChar(50) // GROSS_REVENUE, NET_MARGIN, LINEHAUL

  // Conditions
  minimumMarginPercent Decimal? @db.Decimal(5, 2)

  // Custom rules
  rules Json @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tiers       CommissionPlanTier[]
  assignments UserCommissionAssignment[]
  entries     CommissionEntry[]

  @@unique([tenantId, name, effectiveDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([externalId, sourceSystem])
}

model CommissionPlanTier {
  id     String @id @default(cuid())
  planId String

  // Tier definition
  tierNumber Int
  tierName   String? @db.VarChar(100)

  // Thresholds
  thresholdType String   @db.VarChar(50) // REVENUE, LOAD_COUNT, MARGIN
  thresholdMin  Decimal  @db.Decimal(14, 2)
  thresholdMax  Decimal? @db.Decimal(14, 2)

  // Rate
  rateType   String  @db.VarChar(50) // FLAT, PERCENT
  rateAmount Decimal @db.Decimal(10, 2)

  // Period
  periodType String? @db.VarChar(50) // MONTHLY, QUARTERLY, ANNUAL

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  plan CommissionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, tierNumber])
  @@index([planId])
  @@index([externalId, sourceSystem])
}

model UserCommissionAssignment {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  planId   String

  // Override rates
  overrideRate Decimal? @db.Decimal(5, 2)
  overrideFlat Decimal? @db.Decimal(10, 2)

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Draw
  drawAmount      Decimal @default(0) @db.Decimal(10, 2)
  drawRecoverable Boolean @default(true)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   CommissionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@unique([tenantId, userId, effectiveDate])
  @@index([tenantId])
  @@index([userId])
  @@index([planId])
  @@index([externalId, sourceSystem])
}

model CustomerCommissionOverride {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Override rate
  rateType         String  @db.VarChar(50) // FLAT, PERCENT
  rateAmount       Decimal @db.Decimal(10, 2)
  calculationBasis String? @db.VarChar(50) // GROSS_REVENUE, NET_MARGIN

  // Validity
  effectiveDate DateTime  @db.Date
  endDate       DateTime? @db.Date

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, companyId, userId, effectiveDate])
  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([externalId, sourceSystem])
}

model CommissionEntry {
  id       String  @id @default(cuid())
  tenantId String
  userId   String
  loadId   String?
  orderId  String?

  // Entry type
  entryType String @db.VarChar(50) // LOAD_COMMISSION, BONUS, ADJUSTMENT, DRAW, DRAW_RECOVERY

  // Calculation details
  planId           String?
  calculationBasis String?  @db.VarChar(50)
  basisAmount      Decimal? @db.Decimal(12, 2)
  rateApplied      Decimal? @db.Decimal(5, 2)

  // Commission
  commissionAmount Decimal @db.Decimal(12, 2)

  // Split info
  isSplit       Boolean @default(false)
  splitPercent  Decimal @default(100) @db.Decimal(5, 2)
  parentEntryId String?

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, PAID, REVERSED

  // Period
  commissionPeriod DateTime @db.Date

  // Notes
  notes String? @db.Text

  // Reversal
  reversedAt     DateTime?
  reversedBy     String?
  reversalReason String?   @db.Text

  // Payout
  payoutId String?
  paidAt   DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  load         Load?             @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order        Order?            @relation(fields: [orderId], references: [id], onDelete: SetNull)
  plan         CommissionPlan?   @relation(fields: [planId], references: [id], onDelete: SetNull)
  parentEntry  CommissionEntry?  @relation("EntrySplits", fields: [parentEntryId], references: [id], onDelete: SetNull)
  splitEntries CommissionEntry[] @relation("EntrySplits")
  payout       CommissionPayout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([loadId])
  @@index([tenantId, commissionPeriod])
  @@index([tenantId, status])
  @@index([externalId, sourceSystem])
}

model CommissionPayout {
  id           String   @id @default(cuid())
  tenantId     String
  payoutNumber String   @db.VarChar(50)
  payoutDate   DateTime @db.Date
  periodStart  DateTime @db.Date
  periodEnd    DateTime @db.Date
  userId       String

  // Amounts
  grossCommission Decimal @db.Decimal(12, 2)
  drawRecovery    Decimal @default(0) @db.Decimal(12, 2)
  adjustments     Decimal @default(0) @db.Decimal(12, 2)
  netPayout       Decimal @db.Decimal(12, 2)

  // Status
  status String @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, PROCESSING, PAID, VOID

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Payment
  paymentMethod    String?   @db.VarChar(50) // CHECK, ACH, PAYROLL
  paymentReference String?   @db.VarChar(100)
  paidAt           DateTime?

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Restrict)
  approver User?             @relation("PayoutApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  entries  CommissionEntry[]

  @@unique([tenantId, payoutNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, periodStart])
  @@index([externalId, sourceSystem])
}

// ============================================
// DOCUMENTS MODULE
// ============================================

model Document {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Migration support
  externalId   String? @db.VarChar(100)
  sourceSystem String? @db.VarChar(50)

  // Document info
  name         String  @db.VarChar(255)
  description  String? @db.Text
  documentType String  @db.VarChar(50) // BOL, POD, RATE_CONFIRM, INVOICE, INSURANCE, CONTRACT, W9, CARRIER_AGREEMENT, OTHER

  // File details
  fileName      String  @db.VarChar(255)
  filePath      String  @db.VarChar(500)
  fileSize      Int
  mimeType      String  @db.VarChar(100)
  fileExtension String? @db.VarChar(20)

  // Storage
  storageProvider String  @default("S3") @db.VarChar(50) // S3, MINIO, LOCAL
  bucketName      String? @db.VarChar(100)

  // Entity association (polymorphic)
  entityType String? @db.VarChar(50) // LOAD, ORDER, CARRIER, COMPANY, USER
  entityId   String?

  // Additional associations
  loadId    String?
  orderId   String?
  carrierId String?
  companyId String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, ARCHIVED, DELETED, PROCESSING, FAILED

  // OCR Processing
  ocrProcessed   Boolean   @default(false)
  ocrText        String?   @db.Text
  ocrProcessedAt DateTime?

  // Metadata
  metadata Json     @default("{}")
  tags     String[] @db.VarChar(100)

  // Versioning
  version          Int     @default(1)
  parentDocumentId String?
  isLatestVersion  Boolean @default(true)

  // Security
  isPublic        Boolean   @default(false)
  accessToken     String?   @db.VarChar(100)
  accessExpiresAt DateTime?

  // Retention
  retentionDate DateTime? @db.Date

  // Custom fields
  customFields Json @default("{}")

  // Audit
  uploadedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  load               Load?               @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order              Order?              @relation(fields: [orderId], references: [id], onDelete: SetNull)
  carrier            Carrier?            @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  company            Company?            @relation(fields: [companyId], references: [id], onDelete: SetNull)
  uploader           User?               @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  parentDocument     Document?           @relation("DocumentVersions", fields: [parentDocumentId], references: [id], onDelete: SetNull)
  childDocuments     Document[]          @relation("DocumentVersions")
  shares             DocumentShare[]
  folderDocuments    FolderDocument[]
  generatedDocuments GeneratedDocument[]

  @@index([tenantId])
  @@index([tenantId, documentType])
  @@index([entityType, entityId])
  @@index([loadId])
  @@index([carrierId])
  @@index([companyId])
  @@index([externalId, sourceSystem])
}

model DocumentTemplate {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Template details
  name         String  @db.VarChar(255)
  description  String? @db.Text
  templateType String  @db.VarChar(50) // RATE_CONFIRM, BOL, INVOICE, CARRIER_PACKET, QUOTE, STATEMENT

  // Template content
  templateFormat   String  @db.VarChar(50) // HTML, PDF, DOCX
  templateContent  String? @db.Text // HTML/Handlebars template
  templateFilePath String? @db.VarChar(500)

  // Settings
  paperSize   String @default("LETTER") @db.VarChar(20) // LETTER, A4, LEGAL
  orientation String @default("PORTRAIT") @db.VarChar(20) // PORTRAIT, LANDSCAPE
  margins     Json   @default("{\"top\": 1, \"bottom\": 1, \"left\": 1, \"right\": 1}")

  // Branding
  includeLogo   Boolean @default(true)
  logoPosition  String  @default("TOP_LEFT") @db.VarChar(20)
  headerContent String? @db.Text
  footerContent String? @db.Text

  // Status
  status    String  @default("ACTIVE") @db.VarChar(50)
  isDefault Boolean @default(false)

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator            User?               @relation(fields: [createdById], references: [id], onDelete: SetNull)
  generatedDocuments GeneratedDocument[]

  @@unique([tenantId, name, templateType])
  @@index([tenantId])
  @@index([tenantId, templateType])
  @@index([externalId, sourceSystem])
}

model GeneratedDocument {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Generation details
  templateId String
  documentId String?

  // Source data
  entityType String @db.VarChar(50)
  entityId   String

  // Generation data
  dataSnapshot Json // Data used for generation

  // Status
  status       String  @default("PENDING") @db.VarChar(50) // PENDING, GENERATING, COMPLETED, FAILED
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Timing
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  requestedBy String?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template  DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  document  Document?        @relation(fields: [documentId], references: [id], onDelete: SetNull)
  requester User?            @relation(fields: [requestedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model DocumentShare {
  id String @id @default(uuid())

  // Document
  documentId String

  // Share type
  shareType String @db.VarChar(50) // LINK, EMAIL, PORTAL

  // Access
  accessToken    String  @unique @db.VarChar(100)
  accessPassword String? @db.VarChar(255) // Optional password (hashed)

  // Restrictions
  expiresAt     DateTime?
  maxViews      Int?
  maxDownloads  Int?
  allowDownload Boolean   @default(true)

  // Tracking
  viewCount      Int       @default(0)
  downloadCount  Int       @default(0)
  lastAccessedAt DateTime?

  // Recipient (for email shares)
  recipientEmail String? @db.VarChar(255)
  recipientName  String? @db.VarChar(255)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, EXPIRED, REVOKED

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  creator  User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([accessToken])
  @@index([externalId, sourceSystem])
}

model DocumentFolder {
  id String @id @default(uuid())

  // Tenant
  tenantId String

  // Folder info
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentFolderId String?
  path           String? @db.VarChar(1000) // /root/subfolder/...

  // Association
  entityType String? @db.VarChar(50)
  entityId   String?

  // Settings
  isSystem Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentFolder    DocumentFolder?  @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  childFolders    DocumentFolder[] @relation("FolderHierarchy")
  creator         User?            @relation(fields: [createdById], references: [id], onDelete: SetNull)
  folderDocuments FolderDocument[]

  @@unique([tenantId, parentFolderId, name])
  @@index([tenantId])
  @@index([parentFolderId])
  @@index([entityType, entityId])
  @@index([externalId, sourceSystem])
}

model FolderDocument {
  folderId   String
  documentId String

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  addedAt     DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  addedBy     String?
  createdById String?
  updatedById String?

  // Relations
  folder   DocumentFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  document Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  adder    User?          @relation(fields: [addedBy], references: [id], onDelete: SetNull)

  @@id([folderId, documentId])
}

// ============================================================================
// COMMUNICATION SERVICE (Service 11)
// ============================================================================

model CommunicationTemplate {
  id          String  @id @default(cuid())
  tenantId    String
  name        String  @db.VarChar(255)
  code        String  @db.VarChar(100) // LOAD_ASSIGNED, POD_REQUEST, etc.
  description String? @db.Text
  category    String? @db.VarChar(50) // LOAD, CARRIER, CUSTOMER, SYSTEM
  channel     String  @db.VarChar(50) // EMAIL, SMS, PUSH, IN_APP

  // Content (bilingual)
  subjectEn String? @db.VarChar(500)
  subjectEs String? @db.VarChar(500)
  bodyEn    String  @db.Text
  bodyEs    String? @db.Text

  // Email specific
  fromName  String? @db.VarChar(255)
  fromEmail String? @db.VarChar(255)
  replyTo   String? @db.VarChar(255)

  status   String  @default("ACTIVE") @db.VarChar(50)
  isSystem Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  logs   CommunicationLog[]

  @@unique([tenantId, code, channel])
  @@index([tenantId])
  @@index([code])
  @@index([channel])
  @@index([category])
  @@index([externalId, sourceSystem])
}

model CommunicationLog {
  id           String  @id @default(cuid())
  tenantId     String
  channel      String  @db.VarChar(50) // EMAIL, SMS, PUSH, IN_APP
  templateId   String?
  templateCode String? @db.VarChar(100)

  // Recipient
  recipientType  String? @db.VarChar(50) // USER, CARRIER, CONTACT, DRIVER
  recipientId    String?
  recipientEmail String? @db.VarChar(255)
  recipientPhone String? @db.VarChar(50)
  recipientName  String? @db.VarChar(255)

  // Content
  subject     String? @db.VarChar(500)
  body        String  @db.Text
  bodyHtml    String? @db.Text
  language    String  @default("en") @db.VarChar(10)
  attachments Json? // [{name, url, size}]

  // Entity association
  entityType String? @db.VarChar(50) // LOAD, ORDER, CARRIER, COMPANY
  entityId   String?

  // Status: PENDING, SENT, DELIVERED, FAILED, BOUNCED, OPENED, CLICKED
  status String @default("PENDING") @db.VarChar(50)

  // Tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  failedAt    DateTime?

  // Provider
  provider          String? @db.VarChar(50) // SENDGRID, TWILIO, FCM
  providerMessageId String? @db.VarChar(255)

  // Error handling
  errorMessage String?   @db.Text
  retryCount   Int       @default(0)
  lastRetryAt  DateTime?

  metadata Json @default("{}")

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template CommunicationTemplate? @relation(fields: [templateId], references: [id])

  @@index([tenantId])
  @@index([recipientType, recipientId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([channel])
  @@index([createdAt])
  @@index([templateCode])
  @@index([externalId, sourceSystem])
}

model SmsConversation {
  id              String  @id @default(cuid())
  tenantId        String
  phoneNumber     String  @db.VarChar(50)
  participantType String? @db.VarChar(50) // CARRIER, DRIVER, CONTACT
  participantId   String?
  participantName String? @db.VarChar(255)
  loadId          String?

  status             String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, CLOSED
  unreadCount        Int       @default(0)
  lastMessageAt      DateTime?
  lastMessagePreview String?   @db.VarChar(255)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages SmsMessage[]

  @@unique([tenantId, phoneNumber, loadId])
  @@index([tenantId])
  @@index([phoneNumber])
  @@index([participantType, participantId])
  @@index([loadId])
  @@index([externalId, sourceSystem])
}

model SmsMessage {
  id             String @id @default(cuid())
  conversationId String
  direction      String @db.VarChar(20) // INBOUND, OUTBOUND
  body           String @db.Text
  mediaUrls      Json? // Array of media URLs

  // Status: PENDING, SENT, DELIVERED, FAILED, RECEIVED
  status String @default("PENDING") @db.VarChar(50)

  providerMessageId String? @db.VarChar(255)
  errorMessage      String? @db.Text

  sentAt      DateTime?
  deliveredAt DateTime?
  receivedAt  DateTime?
  readAt      DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  conversation SmsConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([direction])
  @@index([status])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model NotificationPreference {
  id       String @id @default(cuid())
  tenantId String
  userId   String @unique

  // Notification types (which events to notify)
  loadAssigned     Boolean @default(true)
  loadStatusChange Boolean @default(true)
  documentReceived Boolean @default(true)
  invoiceCreated   Boolean @default(true)
  paymentReceived  Boolean @default(true)
  claimFiled       Boolean @default(true)
  carrierExpiring  Boolean @default(true)

  // Channels (how to notify)
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Quiet hours
  quietHoursEnabled  Boolean @default(false)
  quietHoursStart    String? @db.VarChar(5) // HH:MM
  quietHoursEnd      String? @db.VarChar(5)
  quietHoursTimezone String? @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@index([externalId, sourceSystem])
}

model InAppNotification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  type      String  @db.VarChar(50) // LOAD, CARRIER, INVOICE, SYSTEM, etc.
  title     String  @db.VarChar(255)
  message   String  @db.Text
  icon      String? @db.VarChar(50)
  actionUrl String? @db.VarChar(500)

  entityType String? @db.VarChar(50)
  entityId   String?

  isRead Boolean   @default(false)
  readAt DateTime?

  expiresAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CARRIER SERVICE - CarrierCapacity Model
// ==============================================

model CarrierCapacity {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // Equipment
  equipmentType String @db.VarChar(50) // DRY_VAN, REEFER, FLATBED, STEP_DECK, etc.

  // Capacity
  availableUnits Int @default(0)
  totalUnits     Int

  // Location
  city    String?  @db.VarChar(100)
  state   String?  @db.VarChar(50)
  zipCode String?  @db.VarChar(20)
  lat     Decimal? @db.Decimal(10, 7)
  lng     Decimal? @db.Decimal(10, 7)

  // Timing
  effectiveDate DateTime  @db.Date
  expiresAt     DateTime? @db.Date

  // Status
  status CapacityStatus @default(AVAILABLE)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([equipmentType])
  @@index([state])
  @@index([effectiveDate])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// This file contains all new enums and models for pending Phase A services
// This content will be appended to schema.prisma

// ==============================================
// ENUMS FOR PENDING SERVICES
// ==============================================

// Carrier Service - CarrierCapacity
enum CapacityStatus {
  AVAILABLE
  COMMITTED
  INACTIVE
}

// Customer Portal (Service 12)
enum PortalUserRole {
  ADMIN
  USER
  VIEW_ONLY
}

enum PortalUserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum QuoteRequestStatus {
  SUBMITTED
  REVIEWING
  QUOTED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum PortalPaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// Carrier Portal (Service 13)
enum CarrierPortalUserRole {
  OWNER
  ADMIN
  DISPATCHER
  DRIVER
}

enum CarrierDocumentType {
  POD
  LUMPER_RECEIPT
  SCALE_TICKET
  BOL_SIGNED
  WEIGHT_TICKET
  OTHER
}

enum CarrierDocumentStatus {
  UPLOADED
  REVIEWING
  APPROVED
  REJECTED
}

enum QuickPayStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

// Contracts (Service 14)
enum ContractType {
  CUSTOMER_RATE
  CARRIER_RATE
  DEDICATED_CAPACITY
  VOLUME_COMMITMENT
  AGENT_AGREEMENT
}

enum ContractStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT_FOR_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
}

enum RateType {
  FLAT
  PER_MILE
  PER_CWT
  PER_PALLET
  PERCENTAGE
}

enum SLAType {
  ON_TIME_PICKUP
  ON_TIME_DELIVERY
  CLAIMS_RATIO
  TENDER_ACCEPTANCE
}

// Agent (Service 15)
enum AgentType {
  REFERRING
  SELLING
  HYBRID
}

enum AgentStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum AgentAssignmentType {
  PRIMARY
  SECONDARY
  SPLIT
}

enum LeadStatus {
  SUBMITTED
  REVIEWING
  QUALIFIED
  WORKING
  CONVERTED
  REJECTED
  EXPIRED
}

enum AgentCommissionStatus {
  CALCULATED
  APPROVED
  PAID
  ADJUSTED
  VOIDED
}

// Factoring (Service 16)
enum NOAStatus {
  PENDING
  VERIFIED
  ACTIVE
  EXPIRED
  RELEASED
}

enum FactoringStatus {
  NONE
  FACTORED
  QUICK_PAY_ONLY
}

enum VerificationStatus {
  PENDING
  VERIFIED
  PARTIAL
  DECLINED
}

// HR (Service 17)
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMP
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

enum TimeOffType {
  PTO
  SICK
  VACATION
  PERSONAL
  FLOATING_HOLIDAY
}

enum TimeOffRequestStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

// Analytics (Service 18)
enum KPICategory {
  FINANCIAL
  OPERATIONAL
  CARRIER
  CUSTOMER
  SALES
}

enum AggregationType {
  SUM
  AVG
  COUNT
  MIN
  MAX
  RATIO
}

enum PeriodType {
  HOUR
  DAY
  WEEK
  MONTH
  QUARTER
  YEAR
}

enum ReportType {
  STANDARD
  CUSTOM
  AD_HOC
}

enum OutputFormat {
  PDF
  EXCEL
  CSV
  JSON
}

// Workflow (Service 19)
enum TriggerType {
  EVENT
  SCHEDULE
  MANUAL
  WEBHOOK
}

enum StepType {
  ACTION
  CONDITION
  APPROVAL
  WAIT
  PARALLEL
  LOOP
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  WAITING
}

enum ApprovalType {
  SINGLE
  ALL
  ANY
  SEQUENTIAL
}

// Integration Hub (Service 20)
enum IntegrationCategory {
  LOAD_BOARD
  ACCOUNTING
  ELD
  CRM
  RATING
  TMS
  DOCUMENT
  TRACKING
}

enum AuthType {
  API_KEY
  OAUTH2
  BASIC
  NONE
}

enum SyncFrequency {
  REALTIME
  HOURLY
  DAILY
  MANUAL
}

enum WebhookStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

enum CircuitBreakerState {
  CLOSED
  OPEN
  HALF_OPEN
}

// Search (Service 21)
enum SearchEntityType {
  ORDERS
  LOADS
  COMPANIES
  CARRIERS
  CONTACTS
  INVOICES
  DOCUMENTS
}

enum IndexStatus {
  ACTIVE
  REBUILDING
  ERROR
}

// Audit (Service 22)
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum AuditActionCategory {
  DATA
  AUTH
  ADMIN
  SYSTEM
}

enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AuditEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  PASSWORD_RESET
  MFA_ENABLED
  DATA_EXPORT
  PERMISSION_CHANGE
}

// Config (Service 23)
enum ConfigCategory {
  SECURITY
  LIMITS
  DEFAULTS
  INTEGRATIONS
  EMAIL
  NOTIFICATIONS
}

enum FeatureFlagStatus {
  ACTIVE
  DEPRECATED
  ARCHIVED
}

enum ConfigTemplateType {
  TENANT
  USER
}

// Scheduler (Service 24)
enum ScheduleType {
  CRON
  INTERVAL
  ONCE
  MANUAL
}

enum JobType {
  SYSTEM
  TENANT
  USER
}

enum JobExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

enum ReminderStatus {
  PENDING
  SENT
  SNOOZED
  DISMISSED
  COMPLETED
}

// Cache (Service 25)
enum CacheType {
  ENTITY
  QUERY
  SESSION
  CONFIG
}

enum InvalidationType {
  DELETE
  REFRESH
}

enum RateLimitScope {
  USER
  TENANT
  IP
  GLOBAL
}

// Help Desk (Service 26)
enum TicketSource {
  EMAIL
  PORTAL
  PHONE
  CHAT
  INTERNAL
}

enum TicketType {
  QUESTION
  PROBLEM
  INCIDENT
  REQUEST
}

enum TicketPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum TicketStatus {
  NEW
  OPEN
  PENDING
  ON_HOLD
  RESOLVED
  CLOSED
}

enum ReplyType {
  PUBLIC
  INTERNAL_NOTE
  SYSTEM
}

// Feedback (Service 27)
enum NPSCategory {
  PROMOTER
  PASSIVE
  DETRACTOR
}

enum SurveyType {
  NPS
  CSAT
  CUSTOM
  EXIT
  ONBOARDING
}

enum FeatureRequestStatus {
  SUBMITTED
  UNDER_REVIEW
  PLANNED
  IN_PROGRESS
  COMPLETED
  DECLINED
}

enum FeedbackType {
  BUG
  SUGGESTION
  COMPLAINT
  PRAISE
  OTHER
}

// ==============================================
// CUSTOMER PORTAL (Service 12) - Core Models
// ==============================================

model PortalUser {
  id        String @id @default(cuid())
  tenantId  String
  companyId String

  // User info
  email     String  @db.VarChar(255)
  password  String  @db.VarChar(255)
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  phone     String? @db.VarChar(20)

  // Role and status
  role   PortalUserRole   @default(USER)
  status PortalUserStatus @default(PENDING)

  // Verification
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  verificationToken String?   @unique @db.VarChar(255)

  // Session
  lastLoginAt DateTime?

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sessions      PortalSession[]
  quoteRequests QuoteRequest[]
  activityLogs  PortalActivityLog[]
  payments      PortalPayment[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([companyId])
  @@index([email])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model PortalSession {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Session data
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
  @@index([externalId, sourceSystem])
}

model QuoteRequest {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Request details
  requestNumber String  @unique @db.VarChar(50)
  subject       String? @db.VarChar(255)
  description   String? @db.Text

  // Shipment details
  originCity              String?   @db.VarChar(100)
  originState             String?   @db.VarChar(50)
  originZip               String?   @db.VarChar(20)
  destCity                String?   @db.VarChar(100)
  destState               String?   @db.VarChar(50)
  destZip                 String?   @db.VarChar(20)
  pickupDate              DateTime? @db.Date
  deliveryDate            DateTime? @db.Date
  equipmentType           String?   @db.VarChar(50)
  commodity               String?   @db.VarChar(255)
  weightLbs               Decimal?  @db.Decimal(10, 2)
  palletCount             Int?
  isHazmat                Boolean   @default(false)
  isTemperatureControlled Boolean   @default(false)
  tempRange               String?   @db.VarChar(50)

  // Status
  status QuoteRequestStatus @default(SUBMITTED)

  // Quote info
  quoteId        String?   @unique
  quotedAmount   Decimal?  @db.Decimal(12, 2)
  quotedAt       DateTime?
  quotedBy       String?
  quoteExpiresAt DateTime?

  // Response
  acceptedAt    DateTime?
  declinedAt    DateTime?
  declineReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  quote   Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([requestNumber])
  @@index([externalId, sourceSystem])
}

model PortalActivityLog {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Activity
  action      String  @db.VarChar(100)
  entityType  String? @db.VarChar(50)
  entityId    String?
  description String? @db.Text

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company?   @relation(fields: [companyId], references: [id])
  companyId String?

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model PortalPayment {
  id        String @id @default(cuid())
  tenantId  String
  companyId String
  userId    String

  // Payment details
  paymentNumber String  @unique @db.VarChar(50)
  amount        Decimal @db.Decimal(12, 2)
  currency      String  @default("USD") @db.VarChar(3)

  // Status
  status PortalPaymentStatus @default(PENDING)

  // Method
  paymentMethod  String  @db.VarChar(50) // CREDIT_CARD, ACH, WIRE
  lastFourDigits String? @db.VarChar(4)

  // Processor
  processorTransactionId String? @db.VarChar(255)
  processorResponse      Json?

  // Applied to
  invoiceIds String[] // Array of invoice IDs

  // Timing
  processedAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([paymentNumber])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CARRIER PORTAL (Service 13) - Core Models
// ==============================================

model CarrierPortalUser {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String

  // User info
  email     String  @db.VarChar(255)
  password  String  @db.VarChar(255)
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  phone     String? @db.VarChar(20)

  // Role and status
  role   CarrierPortalUserRole @default(DISPATCHER)
  status PortalUserStatus      @default(PENDING)

  // Verification
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  verificationToken String?   @unique @db.VarChar(255)

  // Session
  lastLoginAt DateTime?

  // Language
  language String @default("en") @db.VarChar(10)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant             Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier            Carrier                    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  sessions           CarrierPortalSession[]
  documents          CarrierPortalDocument[]
  invoiceSubmissions CarrierInvoiceSubmission[]
  quickPayRequests   CarrierQuickPayRequest[]
  activityLogs       CarrierPortalActivityLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([carrierId])
  @@index([email])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierPortalSession {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Session data
  refreshTokenHash String    @db.VarChar(255)
  userAgent        String?   @db.Text
  ipAddress        String?   @db.VarChar(45)
  expiresAt        DateTime
  revokedAt        DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  carrier   Carrier?          @relation(fields: [carrierId], references: [id])
  carrierId String?

  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshTokenHash])
  @@index([externalId, sourceSystem])
}

model CarrierPortalDocument {
  id        String  @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String?

  // Document info
  documentType CarrierDocumentType @default(POD)
  fileName     String              @db.VarChar(255)
  filePath     String              @db.VarChar(500)
  fileSize     Int
  mimeType     String              @db.VarChar(100)

  // Status
  status CarrierDocumentStatus @default(UPLOADED)

  // Review
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text
  rejectionNotes String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user    CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load    Load?             @relation(fields: [loadId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([documentType])
  @@index([externalId, sourceSystem])
}

model CarrierInvoiceSubmission {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String

  // Invoice details
  invoiceNumber String   @db.VarChar(50)
  amount        Decimal  @db.Decimal(12, 2)
  invoiceDate   DateTime @db.Date

  // Status
  status String @default("SUBMITTED") @db.VarChar(50)

  // Review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  // Linked settlement
  settlementId String?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier    Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user       CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load       Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)
  settlement Settlement?       @relation(fields: [settlementId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([externalId, sourceSystem])
}

model CarrierQuickPayRequest {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String
  userId    String
  loadId    String

  // Request details
  requestedAmount Decimal @db.Decimal(12, 2)
  feePercent      Decimal @db.Decimal(5, 2)
  feeAmount       Decimal @db.Decimal(12, 2)
  netAmount       Decimal @db.Decimal(12, 2)

  // Status
  status QuickPayStatus @default(REQUESTED)

  // Decision
  approvedBy      String?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Processing
  processedAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  user    CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  load    Load              @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([userId])
  @@index([loadId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model CarrierPortalActivityLog {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Activity
  action      String  @db.VarChar(100)
  entityType  String? @db.VarChar(50)
  entityId    String?
  description String? @db.Text

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      CarrierPortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  carrier   Carrier?          @relation(fields: [carrierId], references: [id])
  carrierId String?

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CONTRACTS (Service 14) - Core Models
// ==============================================

model Contract {
  id             String @id @default(cuid())
  tenantId       String
  contractNumber String @unique @db.VarChar(50)

  // Type
  contractType ContractType

  // Parties
  customerId String?
  carrierId  String?
  agentId    String?

  // Contract details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Dates
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Status
  status ContractStatus @default(DRAFT)

  // Auto-renewal
  autoRenew       Boolean @default(false)
  renewalTermDays Int?
  noticeDays      Int?

  // Documents
  documentId       String? @unique
  signedDocumentId String?

  // E-signature
  esignProvider   String?   @db.VarChar(50)
  esignEnvelopeId String?   @db.VarChar(255)
  signedAt        DateTime?
  signedBy        String?

  // Financial
  minimumRevenue Decimal? @db.Decimal(12, 2)
  maximumRevenue Decimal? @db.Decimal(12, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Company?             @relation("CustomerContracts", fields: [customerId], references: [id], onDelete: SetNull)
  carrier             Carrier?             @relation(fields: [carrierId], references: [id], onDelete: SetNull)
  agent               Agent?               @relation(fields: [agentId], references: [id], onDelete: SetNull)
  fuelSurchargeTables FuelSurchargeTable[]
  slas                ContractSLA[]
  volumeCommitments   VolumeCommitment[]

  @@index([tenantId])
  @@index([contractNumber])
  @@index([contractType])
  @@index([customerId])
  @@index([carrierId])
  @@index([status])
  @@index([effectiveDate])
  @@index([expirationDate])
  @@index([externalId, sourceSystem])
}

model FuelSurchargeTable {
  id         String  @id @default(cuid())
  tenantId   String
  contractId String?

  // Table info
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Settings
  basePrice Decimal @db.Decimal(5, 3) // Base fuel price (e.g., $1.20/gallon)
  isDefault Boolean @default(false)

  // Dates
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract?           @relation(fields: [contractId], references: [id], onDelete: SetNull)
  tiers    FuelSurchargeTier[]

  @@index([tenantId])
  @@index([contractId])
  @@index([status])
  @@index([effectiveDate])
  @@index([externalId, sourceSystem])
}

model FuelSurchargeTier {
  id      String @id @default(cuid())
  tableId String

  // Tier definition
  tierNumber Int

  // Price range
  priceMin Decimal  @db.Decimal(5, 3)
  priceMax Decimal? @db.Decimal(5, 3)

  // Surcharge
  surchargePercent Decimal @db.Decimal(5, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  table FuelSurchargeTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, tierNumber])
  @@index([tableId])
  @@index([externalId, sourceSystem])
}

model ContractSLA {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // SLA type
  slaType SLAType

  // Target
  targetPercent Decimal @db.Decimal(5, 2)

  // Measurement period
  measurementPeriod String @db.VarChar(50) // MONTHLY, QUARTERLY, ANNUAL

  // Penalty
  penaltyAmount  Decimal? @db.Decimal(12, 2)
  penaltyPercent Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([slaType])
  @@index([externalId, sourceSystem])
}

model VolumeCommitment {
  id         String @id @default(cuid())
  tenantId   String
  contractId String

  // Commitment details
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date

  // Targets
  minimumLoads   Int?
  minimumRevenue Decimal? @db.Decimal(14, 2)
  minimumWeight  Decimal? @db.Decimal(14, 2)

  // Actuals (tracked)
  actualLoads   Int     @default(0)
  actualRevenue Decimal @default(0) @db.Decimal(14, 2)
  actualWeight  Decimal @default(0) @db.Decimal(14, 2)

  // Shortfall handling
  shortfallFee     Decimal? @db.Decimal(12, 2)
  shortfallPercent Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50) // ACTIVE, MET, SHORTFALL, WAIVED

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contractId])
  @@index([periodStart])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// ==============================================
// AGENT (Service 15) - Core Models
// ==============================================

model Agent {
  id       String @id @default(cuid())
  tenantId String

  // Agent details
  agentCode String    @unique @db.VarChar(50)
  name      String    @db.VarChar(255)
  agentType AgentType

  // Contact
  email   String? @db.VarChar(255)
  phone   String? @db.VarChar(20)
  address String? @db.Text

  // Status
  status AgentStatus @default(PENDING)

  // Active date
  activeFrom DateTime? @db.Date
  activeTo   DateTime? @db.Date

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agreements          AgentAgreement[]
  customerAssignments AgentCustomerAssignment[]
  commissions         AgentCommission[]
  contracts           Contract[]

  @@index([tenantId])
  @@index([agentCode])
  @@index([status])
  @@index([agentType])
  @@index([externalId, sourceSystem])
}

model AgentAgreement {
  id       String @id @default(cuid())
  tenantId String
  agentId  String

  // Agreement details
  agreementNumber String  @unique @db.VarChar(50)
  description     String? @db.Text

  // Dates
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Commission structure
  commissionType String   @db.VarChar(50) // PERCENTAGE, FLAT, TIERED
  commissionRate Decimal? @db.Decimal(5, 2)
  flatAmount     Decimal? @db.Decimal(10, 2)

  // Basis
  calculationBasis String @db.VarChar(50) // REP_COMMISSION, MARGIN, REVENUE

  // Protection
  protectionPeriodMonths Int @default(12)

  // Sunset provision
  hasSunset              Boolean  @default(false)
  sunsetStartMonth       Int?
  sunsetReductionPercent Decimal? @db.Decimal(5, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent  Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([agentId])
  @@index([status])
  @@index([effectiveDate])
  @@index([externalId, sourceSystem])
}

model AgentCustomerAssignment {
  id         String @id @default(cuid())
  tenantId   String
  agentId    String
  customerId String

  // Assignment details
  assignmentType AgentAssignmentType @default(PRIMARY)
  splitPercent   Decimal             @default(100) @db.Decimal(5, 2)

  // Dates
  assignedDate DateTime  @db.Date
  releaseDate  DateTime? @db.Date

  // Protection
  protectionEndsAt DateTime? @db.Date

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent    Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  customer Company @relation("AgentCustomerAssignments", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([agentId])
  @@index([customerId])
  @@index([status])
  @@index([assignmentType])
  @@index([externalId, sourceSystem])
}

model AgentCommission {
  id       String  @id @default(cuid())
  tenantId String
  agentId  String
  loadId   String?
  orderId  String?

  // Commission details
  calculationBasis String  @db.VarChar(50)
  basisAmount      Decimal @db.Decimal(12, 2)
  commissionRate   Decimal @db.Decimal(5, 2)
  commissionAmount Decimal @db.Decimal(12, 2)

  // Split
  isSplit      Boolean @default(false)
  splitPercent Decimal @default(100) @db.Decimal(5, 2)

  // Status
  status AgentCommissionStatus @default(CALCULATED)

  // Period
  commissionPeriod DateTime @db.Date

  // Payment
  paidAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent  Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  load   Load?  @relation(fields: [loadId], references: [id], onDelete: SetNull)
  order  Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([agentId])
  @@index([loadId])
  @@index([orderId])
  @@index([status])
  @@index([commissionPeriod])
  @@index([externalId, sourceSystem])
}

// ==============================================
// FACTORING (Service 16) - Core Models
// ==============================================

model FactoringCompany {
  id       String @id @default(cuid())
  tenantId String

  // Company details
  companyCode String @unique @db.VarChar(50)
  name        String @db.VarChar(255)

  // Contact
  email   String? @db.VarChar(255)
  phone   String? @db.VarChar(20)
  fax     String? @db.VarChar(20)
  address String? @db.Text

  // Settings
  verificationMethod String  @db.VarChar(50) // PHONE, EMAIL, FAX, API
  apiEndpoint        String? @db.VarChar(500)
  apiKey             String? @db.VarChar(255)

  // Timing
  verificationSLAHours Int @default(24)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  noaRecords      NOARecord[]
  carrierStatuses CarrierFactoringStatus[]

  @@index([tenantId])
  @@index([companyCode])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model NOARecord {
  id                 String @id @default(cuid())
  tenantId           String
  carrierId          String
  factoringCompanyId String

  // NOA details
  noaNumber   String  @unique @db.VarChar(50)
  noaDocument String? @db.VarChar(500) // Document path

  // Dates
  receivedDate   DateTime  @db.Date
  effectiveDate  DateTime  @db.Date
  expirationDate DateTime? @db.Date

  // Verification
  verifiedBy     String?
  verifiedAt     DateTime?
  verifiedMethod String?   @db.VarChar(50)

  // Status
  status NOAStatus @default(PENDING)

  // Release
  releasedBy    String?
  releasedAt    DateTime?
  releaseReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier          Carrier          @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  factoringCompany FactoringCompany @relation(fields: [factoringCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([carrierId])
  @@index([factoringCompanyId])
  @@index([noaNumber])
  @@index([status])
  @@index([effectiveDate])
  @@index([externalId, sourceSystem])
}

model CarrierFactoringStatus {
  id        String @id @default(cuid())
  tenantId  String
  carrierId String @unique

  // Current status
  factoringStatus    FactoringStatus @default(NONE)
  factoringCompanyId String?

  // Active NOA
  activeNoaId String?

  // Quick pay
  quickPayEnabled    Boolean  @default(false)
  quickPayFeePercent Decimal? @db.Decimal(5, 2)

  // Notes
  notes String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  carrier          Carrier           @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  factoringCompany FactoringCompany? @relation(fields: [factoringCompanyId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([carrierId])
  @@index([factoringCompanyId])
  @@index([factoringStatus])
  @@index([externalId, sourceSystem])
}

// ==============================================
// HR (Service 17) - Core Models
// ==============================================

model Employee {
  id       String  @id @default(cuid())
  tenantId String
  userId   String? @unique

  // Employee details
  employeeNumber String  @unique @db.VarChar(50)
  firstName      String  @db.VarChar(100)
  lastName       String  @db.VarChar(100)
  email          String  @db.VarChar(255)
  phone          String? @db.VarChar(20)

  // Employment
  employmentType   EmploymentType
  employmentStatus EmploymentStatus @default(ACTIVE)
  departmentId     String?
  positionId       String?
  managerId        String?

  // Dates
  hireDate        DateTime  @db.Date
  terminationDate DateTime? @db.Date

  // Compensation
  annualSalary Decimal? @db.Decimal(12, 2)
  hourlyRate   Decimal? @db.Decimal(10, 2)

  // PTO
  ptoBalance  Decimal @default(0) @db.Decimal(6, 2)
  sickBalance Decimal @default(0) @db.Decimal(6, 2)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  department      Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  position        Position?        @relation(fields: [positionId], references: [id], onDelete: SetNull)
  manager         Employee?        @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports   Employee[]       @relation("EmployeeManager")
  timeOffRequests TimeOffRequest[]

  @@unique([tenantId, employeeNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([departmentId])
  @@index([managerId])
  @@index([employmentStatus])
  @@index([externalId, sourceSystem])
}

model Department {
  id       String @id @default(cuid())
  tenantId String

  // Department details
  code        String  @unique @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Hierarchy
  parentDepartmentId String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant           Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentDepartment Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id], onDelete: SetNull)
  childDepartments Department[] @relation("DepartmentHierarchy")
  employees        Employee[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentDepartmentId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Position {
  id       String @id @default(cuid())
  tenantId String

  // Position details
  code        String  @unique @db.VarChar(50)
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Compensation
  minSalary Decimal? @db.Decimal(12, 2)
  maxSalary Decimal? @db.Decimal(12, 2)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees Employee[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model TimeOffRequest {
  id         String @id @default(cuid())
  tenantId   String
  employeeId String

  // Request details
  requestType TimeOffType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  totalDays   Decimal     @db.Decimal(5, 2)

  // Reason
  reason String? @db.Text

  // Status
  status TimeOffRequestStatus @default(PENDING)

  // Approval
  approvedBy   String?
  approvedAt   DateTime?
  deniedBy     String?
  deniedAt     DateTime?
  denialReason String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([externalId, sourceSystem])
}

// ==============================================
// ANALYTICS (Service 18) - Core Models
// ==============================================

model KPIDefinition {
  id       String @id @default(cuid())
  tenantId String

  // KPI details
  code        String      @unique @db.VarChar(100)
  name        String      @db.VarChar(255)
  description String?     @db.Text
  category    KPICategory

  // Calculation
  aggregationType AggregationType
  sourceQuery     String          @db.Text

  // Display
  unit   String? @db.VarChar(50)
  format String? @db.VarChar(50)

  // Thresholds
  targetValue   Decimal? @db.Decimal(14, 4)
  warningValue  Decimal? @db.Decimal(14, 4)
  criticalValue Decimal? @db.Decimal(14, 4)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Dashboard {
  id       String @id @default(cuid())
  tenantId String

  // Dashboard details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Access
  isPublic Boolean @default(false)
  ownerId  String?

  // Layout
  layout Json @default("{}")

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ownerId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model Report {
  id       String @id @default(cuid())
  tenantId String

  // Report details
  name        String     @db.VarChar(255)
  description String?    @db.Text
  reportType  ReportType

  // Query
  sourceQuery String @db.Text
  parameters  Json   @default("[]")

  // Output
  outputFormat OutputFormat @default(PDF)

  // Schedule
  isScheduled        Boolean @default(false)
  scheduleExpression String? @db.VarChar(255)

  // Access
  isPublic Boolean @default(false)
  ownerId  String?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([reportType])
  @@index([ownerId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

// ==============================================
// WORKFLOW (Service 19) - Core Models
// ==============================================

model Workflow {
  id       String @id @default(cuid())
  tenantId String

  // Workflow details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Trigger
  triggerType       TriggerType
  triggerEvent      String?     @db.VarChar(100)
  triggerConditions Json        @default("{}")

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Version
  version Int @default(1)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions WorkflowExecution[]

  @@index([tenantId])
  @@index([triggerType])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WorkflowExecution {
  id         String @id @default(cuid())
  tenantId   String
  workflowId String

  // Execution details
  triggerData Json

  // Status
  status WorkflowExecutionStatus @default(PENDING)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Result
  result       Json?
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowId])
  @@index([status])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ApprovalRequest {
  id       String @id @default(cuid())
  tenantId String

  // Request details
  requestNumber String  @db.VarChar(50)
  title         String  @db.VarChar(255)
  description   String? @db.Text

  // Type
  approvalType ApprovalType

  // Entity
  entityType String @db.VarChar(50)
  entityId   String

  // Approvers
  approverIds String[] // Array of user IDs

  // Status
  status String @default("PENDING") @db.VarChar(50)

  // Timing
  dueDate DateTime? @db.Date

  // Decision
  decidedBy String?
  decidedAt DateTime?
  decision  String?   @db.VarChar(50) // APPROVED, REJECTED
  comments  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, requestNumber])
  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([externalId, sourceSystem])
}

// ==============================================
// INTEGRATION HUB (Service 20) - Core Models
// ==============================================

model Integration {
  id       String @id @default(cuid())
  tenantId String

  // Integration details
  name        String              @db.VarChar(255)
  description String?             @db.Text
  category    IntegrationCategory
  provider    String              @db.VarChar(100)

  // Authentication
  authType    AuthType
  apiKey      String?  @db.VarChar(500)
  apiSecret   String?  @db.VarChar(500)
  oauthTokens Json?

  // Configuration
  config Json @default("{}")

  // Sync settings
  syncFrequency SyncFrequency
  lastSyncAt    DateTime?
  nextSyncAt    DateTime?

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  webhookDeliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([category])
  @@index([provider])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WebhookEndpoint {
  id       String @id @default(cuid())
  tenantId String

  // Endpoint details
  name        String  @db.VarChar(255)
  url         String  @db.VarChar(500)
  description String? @db.Text

  // Events
  events String[] // Array of event types

  // Security
  secret String? @db.VarChar(255)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([status])
  @@index([externalId, sourceSystem])
}

model WebhookDelivery {
  id            String  @id @default(cuid())
  tenantId      String
  endpointId    String?
  integrationId String?

  // Event
  event   String @db.VarChar(100)
  payload Json

  // Delivery
  requestHeaders  Json?
  requestBody     Json?
  responseStatus  Int?
  responseHeaders Json?
  responseBody    String? @db.Text

  // Status
  status WebhookStatus @default(PENDING)

  // Retry
  attempts    Int       @default(0)
  lastAttempt DateTime?
  nextRetry   DateTime?

  // Error
  errorMessage String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  endpoint    WebhookEndpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)
  integration Integration?     @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([endpointId])
  @@index([integrationId])
  @@index([status])
  @@index([event])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// SEARCH (Service 21) - Core Models
// ==============================================

model SavedSearch {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Search details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Entity
  entityType SearchEntityType

  // Query
  query   Json
  filters Json @default("{}")

  // Settings
  isPublic Boolean @default(false)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType])
  @@index([externalId, sourceSystem])
}

model SearchHistory {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Search details
  entityType SearchEntityType
  searchTerm String           @db.VarChar(500)

  // Result
  resultCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType])
  @@index([searchTerm])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// AUDIT (Service 22) - Core Models
// ==============================================

model AuditLog {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?

  // Action
  action   AuditAction
  category AuditActionCategory
  severity AuditSeverity       @default(INFO)

  // Entity
  entityType String? @db.VarChar(50)
  entityId   String?

  // Details
  description String? @db.Text
  metadata    Json    @default("{}")

  // Context
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model ChangeHistory {
  id       String  @id @default(cuid())
  tenantId String
  userId   String?

  // Entity
  entityType String @db.VarChar(50)
  entityId   String

  // Change
  field    String  @db.VarChar(100)
  oldValue String? @db.Text
  newValue String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([field])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CONFIG (Service 23) - Core Models
// ==============================================

model SystemConfig {
  id String @id @default(cuid())

  // Config details
  category ConfigCategory
  key      String         @unique @db.VarChar(100)
  value    Json

  // Metadata
  description String? @db.Text
  dataType    String  @db.VarChar(50) // STRING, NUMBER, BOOLEAN, JSON

  // Validation
  validationRules Json?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  @@index([category])
  @@index([key])
  @@index([externalId, sourceSystem])
}

model FeatureFlag {
  id String @id @default(cuid())

  // Flag details
  key         String            @unique @db.VarChar(100)
  name        String            @db.VarChar(255)
  description String?           @db.Text
  status      FeatureFlagStatus @default(ACTIVE)

  // Rollout
  enabled        Boolean @default(false)
  rolloutPercent Int     @default(0)

  // Targeting
  tenantIds String[] // Array of tenant IDs
  userIds   String[] // Array of user IDs

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  @@index([key])
  @@index([status])
  @@index([enabled])
  @@index([externalId, sourceSystem])
}

// ==============================================
// SCHEDULER (Service 24) - Core Models
// ==============================================

model ScheduledJob {
  id       String  @id @default(cuid())
  tenantId String?

  // Job details
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Type
  jobType      JobType
  scheduleType ScheduleType

  // Schedule
  cronExpression  String?   @db.VarChar(255)
  intervalMinutes Int?
  scheduledAt     DateTime?

  // Handler
  handlerName String @db.VarChar(255)
  parameters  Json   @default("{}")

  // Settings
  timeoutMinutes Int @default(30)
  retryAttempts  Int @default(3)

  // Status
  status String @default("ACTIVE") @db.VarChar(50)

  // Last run
  lastRunAt     DateTime?
  lastRunStatus String?   @db.VarChar(50)

  // Next run
  nextRunAt DateTime?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant     Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions JobExecution[]

  @@index([tenantId])
  @@index([jobType])
  @@index([status])
  @@index([nextRunAt])
  @@index([externalId, sourceSystem])
}

model JobExecution {
  id    String @id @default(cuid())
  jobId String

  // Execution details
  status JobExecutionStatus @default(PENDING)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // milliseconds

  // Result
  result       Json?
  errorMessage String? @db.Text

  // Retry
  attempt Int @default(1)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  job ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
  @@index([startedAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// CACHE (Service 25) - Core Models
// ==============================================

model CacheConfig {
  id       String @id @default(cuid())
  tenantId String

  // Cache details
  cacheType CacheType
  key       String    @db.VarChar(255)

  // Settings
  ttlSeconds Int @default(3600)

  // Tags
  tags String[] // For group invalidation

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, cacheType, key])
  @@index([tenantId])
  @@index([cacheType])
  @@index([externalId, sourceSystem])
}

model RateLimit {
  id       String  @id @default(cuid())
  tenantId String?

  // Rate limit details
  scope      RateLimitScope
  identifier String         @db.VarChar(255) // user_id, tenant_id, ip, etc

  // Limits
  maxRequests   Int
  windowSeconds Int

  // Current usage
  currentRequests Int      @default(0)
  windowStartsAt  DateTime @default(now())

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([scope, identifier])
  @@index([tenantId])
  @@index([scope])
  @@index([identifier])
  @@index([windowStartsAt])
  @@index([externalId, sourceSystem])
}

// ==============================================
// HELP DESK (Service 26) - Core Models
// ==============================================

model SupportTicket {
  id       String @id @default(cuid())
  tenantId String

  // Ticket details
  ticketNumber String         @unique @db.VarChar(50)
  subject      String         @db.VarChar(500)
  description  String         @db.Text
  source       TicketSource
  type         TicketType
  priority     TicketPriority @default(NORMAL)
  status       TicketStatus   @default(NEW)

  // Requester
  requesterId    String?
  requesterName  String? @db.VarChar(255)
  requesterEmail String? @db.VarChar(255)

  // Assignment
  assignedToId String?
  teamId       String?

  // SLA
  firstResponseDue DateTime?
  resolutionDue    DateTime?
  firstRespondedAt DateTime?

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?   @db.Text

  // Satisfaction
  satisfactionRating  Int?
  satisfactionComment String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant  Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  replies TicketReply[]

  @@index([tenantId])
  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model TicketReply {
  id       String @id @default(cuid())
  tenantId String
  ticketId String

  // Reply details
  replyType ReplyType
  body      String    @db.Text
  bodyHtml  String?   @db.Text

  // Author
  authorId   String?
  authorName String? @db.VarChar(255)

  // Attachments
  attachments Json? // [{name, url, size}]

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ticketId])
  @@index([replyType])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model KBArticle {
  id       String @id @default(cuid())
  tenantId String

  // Article details
  title   String  @db.VarChar(500)
  content String  @db.Text
  summary String? @db.VarChar(1000)

  // Category
  categoryId String?

  // SEO
  slug     String  @db.VarChar(500)
  keywords String? @db.Text

  // Visibility
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  // Stats
  viewCount      Int @default(0)
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isPublished])
  @@index([externalId, sourceSystem])
}

// ==============================================
// FEEDBACK (Service 27) - Core Models
// ==============================================

model NPSSurvey {
  id       String @id @default(cuid())
  tenantId String

  // Survey details
  surveyNumber     String  @unique @db.VarChar(50)
  question         String  @db.Text
  followUpQuestion String? @db.Text

  // Target
  targetType String @db.VarChar(50) // ALL, CUSTOMERS, CARRIERS

  // Schedule
  scheduledAt DateTime? @db.Date
  expiresAt   DateTime? @db.Date

  // Status
  status String @default("DRAFT") @db.VarChar(50)

  // Stats
  responseCount Int  @default(0)
  npsScore      Int?

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  responses NPSResponse[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
  @@index([externalId, sourceSystem])
}

model NPSResponse {
  id       String @id @default(cuid())
  tenantId String
  surveyId String

  // Respondent
  respondentType  String? @db.VarChar(50)
  respondentId    String?
  respondentEmail String? @db.VarChar(255)

  // Response
  score    Int
  category NPSCategory
  feedback String?     @db.Text

  // Follow-up
  followUpResponse String? @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  survey NPSSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([surveyId])
  @@index([category])
  @@index([score])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}

model FeatureRequest {
  id       String @id @default(cuid())
  tenantId String

  // Request details
  title       String @db.VarChar(500)
  description String @db.Text

  // Submitter
  submitterId    String?
  submitterName  String? @db.VarChar(255)
  submitterEmail String? @db.VarChar(255)

  // Status
  status FeatureRequestStatus @default(SUBMITTED)

  // Priority
  voteCount Int @default(0)

  // Implementation
  implementedAt DateTime?
  releaseNotes  String?   @db.Text

  // Migration support
  externalId   String? @db.VarChar(255)
  sourceSystem String? @db.VarChar(100)
  customFields Json    @default("{}")

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdById String?
  updatedById String?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([voteCount])
  @@index([createdAt])
  @@index([externalId, sourceSystem])
}
